{% extends "header.html" %}

{% block title %}Hồ Sơ Người Dùng{% endblock %}


{% block content}
<div class="card">
    <div class="title-section">
        <i class="fas fa-info-circle"></i> Thông Tin Cơ Bản
    </div>
    
    <form id="profileForm">
        <input type="hidden" id="currentUserId" value="{{ session.get('user_id') }}">
        
        <div class="input-group" style="margin-bottom: 15px;">
            <label>Tên đăng nhập:</label>
            <input type="text" id="profileUsername" value="{{ session.get('username') }}" readonly style="background: #eee;">
        </div>
        
        <div class="input-group" style="margin-bottom: 15px;">
            <label>Họ và tên:</label>
            <input type="text" id="profileHoTen" value="{{ session.get('ho_ten') }}" required>
        </div>
        
        <div class="input-group" style="margin-bottom: 15px;">
            <label>Email:</label>
            <input type="email" id="profileEmail" value="{{ session.get('email') }}" required>
        </div>
        
        <div class="input-group" style="margin-bottom: 15px;">
            <label>Vai trò:</label>
            <input type="text" value="{{ session.get('vai_tro') }}" readonly style="background: #eee; font-weight: bold; color: var(--primary);">
        </div>
        
        <div class="title-section" style="margin-top: 30px;">
            <i class="fas fa-key"></i> Đổi Mật Khẩu
        </div>
        
        <div class="input-group" style="margin-bottom: 15px;">
            <label>Mật khẩu mới (Để trống nếu không đổi):</label>
            <input type="password" id="profileNewPassword" placeholder="Nhập mật khẩu mới">
        </div>
        
        <div class="input-group" style="margin-bottom: 15px;">
            <label>Xác nhận mật khẩu mới:</label>
            <input type="password" id="profileConfirmPassword" placeholder="Xác nhận mật khẩu mới">
        </div>

        <div style="text-align: right; margin-top: 20px;">
            <button type="submit" class="btn btn-primary" id="saveProfileBtn">
                <i class="fas fa-save"></i> Lưu Thay Đổi
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('profileForm').addEventListener('submit', handleProfileUpdate);
    });

    async function handleProfileUpdate(e) {
        e.preventDefault();
        
        const hoTen = document.getElementById('profileHoTen').value.trim();
        const email = document.getElementById('profileEmail').value.trim();
        const newPassword = document.getElementById('profileNewPassword').value;
        const confirmPassword = document.getElementById('profileConfirmPassword').value;
        const userId = document.getElementById('currentUserId').value;
        
        if (newPassword !== confirmPassword) {
            showNotification('❌ Mật khẩu mới và xác nhận mật khẩu không khớp!', 'error');
            return;
        }

        const data = {
            ho_ten: hoTen,
            email: email
        };

        if (newPassword) {
            data.password = newPassword;
        }

        const saveProfileBtn = document.getElementById('saveProfileBtn');
        saveProfileBtn.disabled = true;
        saveProfileBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang lưu...';

        try {
            // Sử dụng API sửa người dùng cho profile
            const response = await fetch(`/api/nguoi-dung/${userId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.success) {
                showNotification('✅ Cập nhật hồ sơ thành công! Vui lòng đăng nhập lại nếu đổi mật khẩu.', 'success');
                // Clear password fields
                document.getElementById('profileNewPassword').value = '';
                document.getElementById('profileConfirmPassword').value = '';
                
                // Cần reload lại session info nếu đổi HoTen/Email, nhưng phức tạp. Tạm thời chỉ thông báo.
            } else {
                showNotification(`❌ Lỗi: ${result.message || result.error}`, 'error');
            }

        } catch (error) {
            console.error('Lỗi cập nhật hồ sơ:', error);
            showNotification('❌ Lỗi kết nối khi cập nhật hồ sơ', 'error');
        } finally {
            saveProfileBtn.disabled = false;
            saveProfileBtn.innerHTML = '<i class="fas fa-save"></i> Lưu Thay Đổi';
        }
    }
</script>
{% endblock %}