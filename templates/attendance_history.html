{% extends "header.html" %}

{% block title %}Lịch sử điểm danh - Hệ thống DLA{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-slate-800"><i class="fas fa-history mr-2 text-indigo-600"></i>Lịch sử điểm danh</h1>
        <button onclick="window.exportToExcel()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2 shadow-sm">
            <i class="fas fa-file-excel"></i> Xuất Excel
        </button>
    </div>

    <!-- Filter Section -->
    <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 mb-6">
        <div class="flex flex-col md:flex-row gap-4 justify-between items-end">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 w-full md:w-3/4">
                <!-- Search -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Tìm kiếm</label>
                    <div class="relative">
                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                        <input type="text" id="searchInput" onkeyup="filterAndRender()" placeholder="Tên hoặc Mã SV..." class="w-full pl-9 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
                    </div>
                </div>

                <!-- Class/Subject Filter -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Lớp / Môn học</label>
                    <select id="classFilter" onchange="filterAndRender()" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none cursor-pointer">
                        <option value="">-- Tất cả --</option>
                    </select>
                </div>

                <!-- Confidence Filter -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Độ chính xác</label>
                    <select id="confFilter" onchange="filterAndRender()" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none cursor-pointer">
                        <option value="">Tất cả</option>
                        <option value="high">Cao (>80%)</option>
                        <option value="medium">Trung bình (60-80%)</option>
                        <option value="low">Thấp (<60%)</option>
                    </select>
                </div>
            </div>

            <!-- Refresh Button (Redesigned) -->
            <div class="w-full md:w-auto flex justify-end">
                 <button onclick="window.loadHistory()" class="group flex items-center justify-center gap-2 px-5 py-2.5 bg-white border border-slate-200 text-slate-600 rounded-lg hover:bg-indigo-50 hover:text-indigo-600 hover:border-indigo-200 transition-all shadow-sm font-medium text-sm">
                    <i class="fas fa-sync-alt group-hover:animate-spin"></i>
                    <span>Làm mới dữ liệu</span>
                </button>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse">
                <thead class="bg-slate-50 text-slate-500 font-semibold text-sm uppercase tracking-wider">
                    <tr>
                        <th class="px-6 py-4 w-16 text-center">STT</th>
                        <th class="px-6 py-4">Mã SV</th>
                        <th class="px-6 py-4">Họ tên</th>
                        <th class="px-6 py-4">Lớp</th>
                        <th class="px-6 py-4 text-center">Ảnh</th>
                        <th class="px-6 py-4">Thời gian vào</th>
                        <th class="px-6 py-4">Độ tin cậy</th>
                        <th class="px-6 py-4">Trạng thái</th>
                        <th class="px-6 py-4 text-center">Hành động</th>
                    </tr>
                </thead>
                <tbody id="historyTableBody" class="divide-y divide-slate-100 text-slate-600 text-sm"></tbody>
            </table>
        </div>
        <div class="p-4 border-t border-slate-100 flex justify-between items-center" id="paginationControls">
            <span class="text-slate-500 text-sm">Hiển thị <span id="showingCount">0</span> kết quả</span>
        </div>
    </div>
</div>

<script>
    var allHistory = [];

    window.initializeAttendanceHistory = function() {
        // Gọi hàm thông qua window để đảm bảo tìm thấy
        if (typeof window.loadHistory === 'function') {
            window.loadHistory();
        }
    }

    if (document.readyState === 'complete' || document.readyState === 'interactive') {
        if(document.getElementById('historyTableBody')) window.initializeAttendanceHistory();
    } else {
        document.addEventListener('DOMContentLoaded', () => {
            if(document.getElementById('historyTableBody')) window.initializeAttendanceHistory();
        });
    }

    window.loadHistory = async function() {
        const tbody = document.getElementById('historyTableBody');
        if(!tbody) return;
        tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8"><i class="fas fa-spinner fa-spin text-indigo-500 mr-2"></i>Đang tải dữ liệu...</td></tr>';
        
        try {
            const res = await fetch('/api/diem-danh'); 
            if(!res.ok) throw new Error('Failed');
            allHistory = await res.json();
            
            // Populate Class Filter
            const classes = [...new Set(allHistory.map(x => x.lop).filter(Boolean))].sort();
            const sel = document.getElementById('classFilter');
            if(sel) {
                const currentVal = sel.value;
                sel.innerHTML = '<option value="">-- Tất cả --</option>';
                classes.forEach(c => sel.add(new Option(c, c)));
                if (classes.includes(currentVal)) sel.value = currentVal;
            }

            filterAndRender();
        } catch(err) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-red-500">Lỗi tải dữ liệu: ' + err.message + '</td></tr>';
        }
    }
    
    function filterAndRender() {
        const search = document.getElementById('searchInput').value.toLowerCase();
        const cls = document.getElementById('classFilter').value;
        const confFilter = document.getElementById('confFilter').value;
        
        const filtered = allHistory.filter(item => {
            // Filter by Search
            const matchSearch = !search || item.ho_ten.toLowerCase().includes(search) || item.ma_sv.toLowerCase().includes(search);
            
            // Filter by Class
            const matchClass = !cls || item.lop === cls;
            
            // Filter by Confidence
            let matchConf = true;
            const conf = parseFloat(item.do_tin_cay || 0);
            if (confFilter === 'high') matchConf = conf >= 80;
            else if (confFilter === 'medium') matchConf = conf >= 60 && conf < 80;
            else if (confFilter === 'low') matchConf = conf < 60;

            return matchSearch && matchClass && matchConf;
        });
        renderTable(filtered);
    }
    
    function renderTable(data) {
        const tbody = document.getElementById('historyTableBody');
        if(!tbody) return;
        tbody.innerHTML = '';
        const countEl = document.getElementById('showingCount');
        if(countEl) countEl.textContent = data.length;
        
        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" class="text-center py-8 text-slate-400 flex-col"><i class="far fa-folder-open text-4xl mb-2 opacity-20"></i><br>Không có dữ liệu phù hợp</td></tr>';
            return;
        }
        data.forEach((item, idx) => {
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-slate-50 transition-colors border-b border-slate-50 last:border-0';
            
            const conf = parseFloat(item.do_tin_cay || 0);
            let badge = '';
            if (conf >= 80) badge = '<span class="px-2.5 py-0.5 rounded-full bg-green-100 text-green-700 text-xs font-bold border border-green-200">Cao</span>';
            else if (conf >= 60) badge = '<span class="px-2.5 py-0.5 rounded-full bg-yellow-100 text-yellow-700 text-xs font-bold border border-yellow-200">TB</span>';
            else badge = '<span class="px-2.5 py-0.5 rounded-full bg-red-100 text-red-700 text-xs font-bold border border-red-200">Thấp</span>';
            
            // Capture Image
            var captureHtml = item.capture_image_path 
                ? `<img src="${item.capture_image_path}" class="w-12 h-12 rounded-lg object-cover border border-slate-200 shadow-sm cursor-pointer hover:scale-150 transition-transform origin-left" onclick="window.open(this.src, '_blank')">`
                : `<div class="w-12 h-12 rounded-lg bg-slate-100 flex items-center justify-center text-slate-400 text-xs"><i class="fas fa-camera-slash"></i></div>`;

            tr.innerHTML = `
                <td class="px-6 py-4 text-center text-slate-400 text-xs">${idx + 1}</td>
                <td class="px-6 py-4 font-mono text-slate-600 text-xs font-bold">${item.ma_sv}</td>
                <td class="px-6 py-4 font-medium text-slate-800">${item.ho_ten}</td>
                <td class="px-6 py-4"><span class="px-2 py-1 bg-slate-100 rounded text-xs text-slate-600 font-medium">${item.lop || '?'}</span></td>
                <td class="px-6 py-4 text-center">${captureHtml}</td>
                <td class="px-6 py-4 text-indigo-600 font-medium text-sm">${item.thoi_gian_vao}</td>
                <td class="px-6 py-4 font-mono text-xs">${conf.toFixed(1)}%</td>
                <td class="px-6 py-4">${badge}</td>
                <td class="px-6 py-4 text-center">
                    <button onclick="deleteAttendance(${item.id_diem_danh})" class="group relative text-slate-400 hover:text-red-500 transition-colors p-2" title="Xóa bản ghi">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }
    
    window.deleteAttendance = async function(id) {
        if(!confirm('Bạn có chắc chắn muốn xóa bản ghi điểm danh này?')) return;
        
        try {
            const res = await fetch(`/api/diem-danh/${id}`, { method: 'DELETE' });
            const data = await res.json();
            
            if(data.success) {
                allHistory = allHistory.filter(x => x.id_diem_danh !== id);
                filterAndRender();
            } else {
                alert('Lỗi: ' + (data.error || 'Không thể xóa'));
            }
        } catch(err) {
            console.error(err);
            alert('Lỗi kết nối khi xóa');
        }
    }

    window.exportToExcel = function() { alert('Tính năng đang phát triển'); }
</script>
{% endblock %}