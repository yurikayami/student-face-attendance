{% extends "header.html" %}
{% block title %}Hệ thống điểm danh khuôn mặt sinh viên DLA{% endblock %}
{% block content %}
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý sinh viên - Hệ thống điểm danh khuôn mặt sinh viên DLA</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        /* Biến CSS */
        :root {
            /* --primary-color: #667eea; */
            --primary-dark: #2980b9;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --secondary-color: #764ba2;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --gray-color: #6c757d;
            --border-color: #dee2e6;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --border-radius: 8px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: var(--dark-color);
            line-height: 1.6;
        }

        /* Layout và Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header-content h1 {
            margin: 0 0 5px 0;
            color: var(--dark-color);
            font-size: 28px;
        }

        .page-description {
            color: var(--gray-color);
            margin: 0;
        }

        /* Thống kê */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 15px;
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }

        .stat-icon.total {
            background: var(--primary-color);
        }

        .stat-icon.trained {
            background: var(--success-color);
        }

        .stat-icon.pending {
            background: var(--warning-color);
        }

        .stat-info .count {
            display: block;
            font-size: 28px;
            font-weight: bold;
            color: var(--dark-color);
        }

        .stat-info .label {
            color: var(--gray-color);
            font-size: 14px;
        }

        /* Bộ lọc và tìm kiếm */
        .filter-section {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .search-box {
            position: relative;
            flex: 1;
            min-width: 250px;
        }

        .search-box i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-color);
        }

        .search-box input {
            width: 100%;
            padding: 10px 10px 10px 35px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 14px;
        }

        .filter-options {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-options select {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background: white;
            font-size: 14px;
            min-width: 150px;
        }

        /* Tab chuyển đổi view */
        .view-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            padding: 0 20px;
        }

        .view-toggle .btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* Bảng sinh viên */
        .table-view {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .table-responsive {
            overflow-x: auto;
        }

        .student-table {
            width: 100%;
            border-collapse: collapse;
        }

        .student-table th,
        .student-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .student-table th {
            background: var(--light-color);
            font-weight: 600;
            color: var(--dark-color);
            position: sticky;
            top: 0;
        }

        .student-table tr:hover {
            background: var(--light-color);
        }

        /* Badge trạng thái */
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-badge.trained {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.partial {
            background: #fff3cd;
            color: #856404;
        }

        .status-badge.none {
            background: #f8d7da;
            color: #721c24;
        }

        /* Danh sách sinh viên */
        .student-list-container {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .list-header h2 {
            margin: 0;
            font-size: 20px;
            color: var(--dark-color);
        }

        /* Item sinh viên */
        .student-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s;
        }

        .student-item:hover {
            background-color: var(--light-color);
        }

        .student-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }

        .student-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--border-color);
        }

        .avatar-placeholder {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--light-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray-color);
            font-size: 20px;
            border: 2px solid var(--border-color);
        }

        .student-details {
            flex: 1;
        }

        .student-name {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 5px;
            color: var(--dark-color);
        }

        .student-details-text {
            color: var(--gray-color);
            font-size: 14px;
            line-height: 1.4;
        }

        .student-actions {
            display: flex;
            gap: 10px;
        }

        /* Action buttons in table */
        .action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .action-buttons .btn {
            padding: 4px 8px;
            font-size: 12px;
        }

        /* Trạng thái loading và empty */
        .loading-state {
            padding: 40px;
            text-align: center;
            color: var(--gray-color);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-color);
            border-left: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            padding: 60px 20px;
            text-align: center;
            color: var(--gray-color);
        }

        .empty-state i {
            font-size: 60px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h3 {
            margin: 0 0 10px;
            color: var(--dark-color);
        }

        .empty-state p {
            margin: 0 0 20px;
        }

        .hidden {
            display: none !important;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: var(--border-radius);
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .modal-content.large {
            max-width: 900px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-header h2 {
            margin: 0;
            font-size: 20px;
            color: var(--dark-color);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 18px;
            color: var(--gray-color);
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
        }

        .close-btn:hover {
            background: var(--light-color);
            color: var(--dark-color);
        }

        /* Form */
        form {
            padding: 20px;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            flex: 1;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--dark-color);
        }

        .required {
            color: var(--danger-color);
        }

        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 14px;
            box-sizing: border-box;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .form-hint {
            font-size: 12px;
            color: var(--gray-color);
            margin-top: 5px;
        }

        /* Modal footer */
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding: 20px;
            border-top: 1px solid var(--border-color);
        }

        /* Nút bấm */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            border: none;
            border-radius: var(--border-radius);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            white-space: nowrap;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-dark);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-outline {
            background: transparent;
            color: var(--dark-color);
            border: 1px solid var(--border-color);
        }

        .btn-outline:hover {
            background: var(--light-color);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 13px;
        }

        .btn-lg {
            padding: 12px 20px;
            font-size: 16px;
        }

        /* Modal chụp khuôn mặt */
        .capture-container {
            padding: 20px;
        }

        .capture-layout {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .video-container {
            flex: 1;
        }

        .video-wrapper {
            position: relative;
            width: 100%;
            border-radius: var(--border-radius);
            overflow: hidden;
            background: #000;
        }

        #faceVideo, #faceCanvas {
            width: 100%;
            height: auto;
            display: block;
        }

        #faceCanvas {
            position: absolute;
            top: 0;
            left: 0;
        }

        .detection-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .detection-frame {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 70%;
            height: 70%;
            border: 2px solid rgba(255, 255, 255, 0.7);
            border-radius: 10px;
        }

        .frame-corner {
            position: absolute;
            width: 20px;
            height: 20px;
            border: 2px solid white;
        }

        .top-left {
            top: -2px;
            left: -2px;
            border-right: none;
            border-bottom: none;
            border-top-left-radius: 8px;
        }

        .top-right {
            top: -2px;
            right: -2px;
            border-left: none;
            border-bottom: none;
            border-top-right-radius: 8px;
        }

        .bottom-left {
            bottom: -2px;
            left: -2px;
            border-right: none;
            border-top: none;
            border-bottom-left-radius: 8px;
        }

        .bottom-right {
            bottom: -2px;
            right: -2px;
            border-left: none;
            border-top: none;
            border-bottom-right-radius: 8px;
        }

        .video-status {
            padding: 10px;
            text-align: center;
            background: var(--light-color);
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            font-size: 14px;
            color: var(--gray-color);
        }

        .capture-sidebar {
            width: 300px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .capture-guide {
            padding: 15px;
            background: #e8f4fd;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--primary-color);
            font-size: 14px;
        }

        .capture-guide.success {
            background: #e8f6ef;
            border-left-color: var(--success-color);
        }

        .steps-container h3 {
            margin: 0 0 10px;
            font-size: 16px;
        }

        .steps-indicator {
            display: flex;
            gap: 10px;
        }

        .step {
            flex: 1;
            text-align: center;
        }

        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--light-color);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 5px;
            font-size: 14px;
            font-weight: bold;
            color: var(--gray-color);
        }

        .step.active .step-number {
            background: var(--primary-color);
            color: white;
        }

        .step.completed .step-number {
            background: var(--success-color);
            color: white;
        }

        .step-label {
            font-size: 12px;
            color: var(--gray-color);
        }

        .step.active .step-label {
            color: var(--primary-color);
            font-weight: 500;
        }

        .capture-progress-container {
            background: var(--light-color);
            padding: 15px;
            border-radius: var(--border-radius);
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .progress-bar-container {
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: var(--primary-color);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 10px;
            font-weight: bold;
        }

        .avatar-section h3 {
            margin: 0 0 10px;
            font-size: 16px;
        }

        .avatar-preview {
            position: relative;
            width: 120px;
            height: 120px;
            margin: 0 auto;
        }

        .avatar-preview img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            display: none;
        }

        .avatar-preview img:not([src=""]) {
            display: block;
        }

        .avatar-preview .avatar-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            color: var(--gray-color);
        }

        .avatar-preview img:not([src=""]) ~ .avatar-placeholder {
            display: none;
        }

        .capture-status {
            padding: 10px;
            text-align: center;
            border-radius: var(--border-radius);
            background: var(--light-color);
            font-size: 14px;
        }

        .preview-images {
            border-top: 1px solid var(--border-color);
            padding-top: 20px;
        }

        .preview-images h3 {
            margin: 0 0 15px;
            font-size: 16px;
        }

        .preview-list {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .preview-list img {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            object-fit: cover;
            border: 2px solid var(--border-color);
        }

        /* Profile modal */
        .profile-content {
            padding: 20px;
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .profile-avatar {
            position: relative;
        }

        .avatar-placeholder.large {
            width: 100px;
            height: 100px;
            font-size: 40px;
        }

        .profile-avatar img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            display: none;
        }

        .profile-avatar img:not([src=""]) {
            display: block;
        }

        .profile-info h3 {
            margin: 0 0 5px 0;
            font-size: 24px;
            color: var(--dark-color);
        }

        .profile-ma-sv {
            margin: 0;
            color: var(--gray-color);
            font-size: 16px;
        }

        .profile-details h4 {
            margin: 0 0 15px 0;
            color: var(--dark-color);
            font-size: 18px;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 5px;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .detail-item label {
            font-weight: 600;
            color: var(--dark-color);
            margin: 0;
        }

        .detail-item span {
            color: var(--gray-color);
        }

        .face-info {
            background: var(--light-color);
            padding: 15px;
            border-radius: var(--border-radius);
        }

        /* Thông báo */
        #notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1100;
            max-width: 400px;
        }

        .notification {
            padding: 15px 20px;
            margin-bottom: 10px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s ease-out;
        }

        .notification.success {
            background: var(--success-color);
            color: white;
        }

        .notification.error {
            background: var(--danger-color);
            color: white;
        }

        .notification.info {
            background: var(--primary-color);
            color: white;
        }

        .notification.warning {
            background: var(--warning-color);
            color: white;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .page-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .stats-container {
                grid-template-columns: 1fr;
            }
            
            .filter-section {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-options {
                flex-direction: column;
            }
            
            .student-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .student-actions {
                width: 100%;
                justify-content: flex-end;
            }
            
            .capture-layout {
                flex-direction: column;
            }
            
            .capture-sidebar {
                width: 100%;
            }
            
            .modal-content {
                margin: 10px;
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            /* Cột số thứ tự */
.stt-column {
    width: 60px;
    text-align: center;
}

.student-index {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 30px;
    height: 30px;
    background: var(--primary-color);
    color: white;
    border-radius: 50%;
    font-weight: bold;
    font-size: 14px;
}

.student-index.small {
    width: 25px;
    height: 25px;
    font-size: 12px;
}
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="page-header">
            <div class="header-content">
                <h1><i class="fas fa-users"></i> Quản lý sinh viên</h1>
                <p class="page-description">Quản lý thông tin và dữ liệu khuôn mặt của sinh viên</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-primary btn-lg" onclick="openAddModal()">
                    <i class="fas fa-plus-circle"></i> Thêm sinh viên
                </button>
                <button class="btn btn-outline btn-lg" onclick="syncEncodings()">
                    <i class="fas fa-sync-alt"></i> Đồng bộ
                </button>
            </div>
        </div>

        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-icon total">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-info">
                    <span id="totalStudents" class="count">0</span>
                    <span class="label">Tổng sinh viên</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon trained">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-info">
                    <span id="trainedStudents" class="count">0</span>
                    <span class="label">Đã train khuôn mặt</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon pending">
                    <i class="fas fa-exclamation-circle"></i>
                </div>
                <div class="stat-info">
                    <span id="pendingStudents" class="count">0</span>
                    <span class="label">Chưa train</span>
                </div>
            </div>
        </div>

        <div class="filter-section">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="studentSearch" placeholder="Tìm kiếm sinh viên theo tên, mã số hoặc lớp...">
            </div>
            <div class="filter-options">
                <select id="facultyFilter">
                    <option value="">Tất cả khoa</option>
                    </select>
                <select id="classFilter">
                    <option value="">Tất cả lớp</option>
                    </select>
                <select id="trainingFilter">
                    <option value="">Tất cả trạng thái</option>
                    <option value="trained">Đã train</option>
                    <option value="partial">Train một phần</option>
                    <option value="none">Chưa train</option>
                </select>
            </div>
        </div>

        <div class="view-toggle">
            <button class="btn btn-outline active" data-view="table">
                <i class="fas fa-table"></i> Dạng bảng
            </button>
            <button class="btn btn-outline" data-view="list">
                <i class="fas fa-list"></i> Dạng danh sách
            </button>
        </div>

       <div id="tableView" class="table-view">
    <div class="table-responsive">
        <table class="student-table">
            <thead>
                <tr>
                    <th class="stt-column">STT</th> <th>Mã SV</th>
                    <th>Họ tên</th>
                    <th>Lớp</th>
                    <th>Khoa</th>
                    <th>Giới tính</th>
                    <th>Trạng thái khuôn mặt</th>
                    <th>Thao tác</th>
                </tr>
            </thead>
            <tbody id="studentTableBody">
                </tbody>
        </table>
    </div>
</div>

        <div id="listView" class="student-list-container hidden">
            <div class="list-header">
                <h2>Danh sách sinh viên</h2>
                <div class="list-actions">
                    <button class="btn btn-outline" id="refreshBtn">
                        <i class="fas fa-sync-alt"></i> Làm mới
                    </button>
                </div>
            </div>
            
            <div id="studentList">
                <div class="loading-state">
                    <div class="spinner"></div>
                    <p>Đang tải dữ liệu sinh viên...</p>
                </div>
            </div>
            
            <div id="emptyState" class="empty-state hidden">
                <i class="fas fa-user-slash"></i>
                <h3>Không có sinh viên nào</h3>
                <p>Hãy thêm sinh viên đầu tiên để bắt đầu quản lý</p>
                <button class="btn btn-primary" onclick="openAddModal()">
                    <i class="fas fa-plus-circle"></i> Thêm sinh viên
                </button>
            </div>
        </div>
    </div>

    <div id="addStudentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-user-plus"></i> Thêm sinh viên mới</h2>
                <button type="button" class="close-btn" onclick="closeAddModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="addStudentForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="ma_sv">Mã sinh viên <span class="required">*</span></label>
                        <input type="text" id="ma_sv" name="ma_sv" placeholder="Nhập mã sinh viên" required>
                        <div class="form-hint">Mã sinh viên phải là duy nhất</div>
                    </div>
                    <div class="form-group">
                        <label for="ho_ten">Họ và tên <span class="required">*</span></label>
                        <input type="text" id="ho_ten" name="ho_ten" placeholder="Nhập họ và tên" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="lop">Lớp <span class="required">*</span></label>
                        <input type="text" id="lop" name="lop" placeholder="Nhập lớp" required>
                    </div>
                    <div class="form-group">
                        <label for="khoa">Khoa</label>
                        <input type="text" id="khoa" name="khoa" placeholder="Nhập khoa">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" name="email" placeholder="Nhập email">
                    </div>
                    <div class="form-group">
                        <label for="gioi_tinh">Giới tính</label>
                        <select id="gioi_tinh" name="gioi_tinh">
                            <option value="">Chọn giới tính</option>
                            <option value="Nam">Nam</option>
                            <option value="Nữ">Nữ</option>
                            
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="nganh_hoc">Ngành học</label>
                        <select id="nganh_hoc" name="nganh_hoc">
                            <option value="Kế toán">Kế toán</option>
                            <option value="Quản trị kinh doanh">Quản trị kinh doanh</option>
                            <option value="Công nghệ thông tin">Công nghệ thông tin</option>
                            <option value="Tài chính Ngân hàng">Tài chính Ngân hàng</option>
                            <option value="Ngôn ngữ Anh">Ngôn ngữ Anh</option>
                            <option value="Quản trị Dịch vụ du lịch và lữ hành">Quản trị Dịch vụ du lịch và lữ hành</option>
                            <option value="Kỹ thuật xây dựng">Kỹ thuật xây dựng</option>
                            <option value="Luật Kinh tế">Luật Kinh tế</option>
                            <option value="Marketing">Marketing</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="so_dien_thoai">Số điện thoại</label>
                        <input type="text" id="so_dien_thoai" name="so_dien_thoai" placeholder="Nhập số điện thoại">
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" onclick="closeAddModal()">Hủy</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Lưu & Chụp khuôn mặt
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="editStudentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-user-edit"></i> Sửa thông tin sinh viên</h2>
                <button type="button" class="close-btn" onclick="closeEditModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="editStudentForm">
                <input type="hidden" id="edit_id_sv" name="id_sv">
                <div class="form-row">
                    <div class="form-group">
                        <label for="edit_ma_sv">Mã sinh viên <span class="required">*</span></label>
                        <input type="text" id="edit_ma_sv" name="ma_sv" required readonly>
                        <div class="form-hint">Mã sinh viên không thể thay đổi</div>
                    </div>
                    <div class="form-group">
                        <label for="edit_ho_ten">Họ và tên <span class="required">*</span></label>
                        <input type="text" id="edit_ho_ten" name="ho_ten" placeholder="Nhập họ và tên" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="edit_lop">Lớp <span class="required">*</span></label>
                        <input type="text" id="edit_lop" name="lop" placeholder="Nhập lớp" required>
                    </div>
                    <div class="form-group">
                        <label for="edit_khoa">Khoa</label>
                        <input type="text" id="edit_khoa" name="khoa" placeholder="Nhập khoa">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="edit_email">Email</label>
                        <input type="email" id="edit_email" name="email" placeholder="Nhập email">
                    </div>
                    <div class="form-group">
                        <label for="edit_gioi_tinh">Giới tính</label>
                        <select id="edit_gioi_tinh" name="gioi_tinh">
                            <option value="">Chọn giới tính</option>
                            <option value="Nam">Nam</option>
                            <option value="Nữ">Nữ</option>
                          
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        
                        <label for="edit_nganh_hoc">Ngành học</label>
                        <select id="edit_nganh_hoc" name="nganh_hoc">
                            <option value="Kế toán">Kế toán</option>
                            <option value="Quản trị kinh doanh">Quản trị kinh doanh</option>
                            <option value="Công nghệ thông tin">Công nghệ thông tin</option>
                            <option value="Tài chính Ngân hàng">Tài chính Ngân hàng</option>
                            <option value="Ngôn ngữ Anh">Ngôn ngữ Anh</option>
                            <option value="Quản trị Dịch vụ du lịch và lữ hành">Quản trị Dịch vụ du lịch và lữ hành</option>
                            <option value="Kỹ thuật xây dựng">Kỹ thuật xây dựng</option>
                            <option value="Luật Kinh tế">Luật Kinh tế</option>
                            <option value="Marketing">Marketing</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edit_so_dien_thoai">Số điện thoại</label>
                        <input type="text" id="edit_so_dien_thoai" name="so_dien_thoai" placeholder="Nhập số điện thoại">
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" onclick="closeEditModal()">Hủy</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Cập nhật
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="viewProfileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-user-circle"></i> Hồ sơ sinh viên</h2>
                <button type="button" class="close-btn" onclick="closeProfileModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="profile-content">
                <div class="profile-header">
                    <div class="profile-avatar">
                        <img id="profile_avatar" src="" alt="Avatar">
                        <div id="profile_avatar_placeholder" class="avatar-placeholder large">
                            <i class="fas fa-user"></i>
                        </div>
                    </div>
                    <div class="profile-info">
                        <h3 id="profile_ho_ten"></h3>
                        <p class="profile-ma-sv" id="profile_ma_sv"></p>
                        <div class="profile-status">
                            <span id="profile_status" class="status-badge"></span>
                        </div>
                    </div>
                </div>
                
                <div class="profile-details">
                    <h4>Thông tin cá nhân</h4>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <label>Lớp:</label>
                            <span id="profile_lop"></span>
                        </div>
                        <div class="detail-item">
                            <label>Khoa:</label>
                            <span id="profile_khoa"></span>
                        </div>
                        <div class="detail-item">
                            <label>Ngành học:</label>
                            <span id="profile_nganh_hoc"></span>
                        </div>
                        <div class="detail-item">
                            <label>Giới tính:</label>
                            <span id="profile_gioi_tinh"></span>
                        </div>
                        <div class="detail-item">
                            <label>Email:</label>
                            <span id="profile_email"></span>
                        </div>
                        <div class="detail-item">
                            <label>Số điện thoại:</label>
                            <span id="profile_so_dien_thoai"></span>
                        </div>
                    </div>
                    
                    <h4>Thông tin khuôn mặt</h4>
                    <div class="face-info">
                        <div class="detail-item">
                            <label>Số ảnh đã train:</label>
                            <span id="profile_so_anh"></span>
                        </div>
                        <div class="detail-item">
                            <label>Trạng thái:</label>
                            <span id="profile_face_status"></span>
                        </div>
                        <div class="detail-item">
                            <label>Lần cập nhật cuối:</label>
                            <span id="profile_last_update"></span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeProfileModal()">Đóng</button>
                <button type="button" class="btn btn-primary" onclick="editFromProfile()">
                    <i class="fas fa-edit"></i> Sửa thông tin
                </button>
            </div>
        </div>
    </div>

    <div id="faceCaptureModal" class="modal">
        <div class="modal-content large">
            <div class="modal-header">
                <h2><i class="fas fa-camera"></i> Thu thập khuôn mặt: <span id="currentStudentName"></span></h2>
                <button type="button" class="close-btn" onclick="cancelFaceCapture()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="capture-container">
                <div class="capture-layout">
                    <div class="video-container">
                        <div class="video-wrapper">
                            <video id="faceVideo" autoplay muted playsinline></video>
                            <canvas id="faceCanvas"></canvas>
                            <div id="faceDetectionOverlay" class="detection-overlay">
                                <div class="detection-frame">
                                    <div class="frame-corner top-left"></div>
                                    <div class="frame-corner top-right"></div>
                                    <div class="frame-corner bottom-left"></div>
                                    <div class="frame-corner bottom-right"></div>
                                </div>
                            </div>
                        </div>
                        <div id="videoStatus" class="video-status">
                            <i class="fas fa-video"></i> Đang khởi động camera...
                        </div>
                    </div>
                    
                    <div class="capture-sidebar">
                        <div id="captureGuide" class="capture-guide">
                            <i class="fas fa-info-circle"></i> Vui lòng giữ khuôn mặt trong khung hình.
                        </div>

                        <div class="steps-container">
                            <h3>Tiến trình thu thập</h3>
                            <div class="steps-indicator">
                                <div class="step" id="step1">
                                    <div class="step-number">1</div>
                                    <div class="step-label">Chụp ảnh lần 1</div>
                                </div>
                                <div class="step" id="step2">
                                    <div class="step-number">2</div>
                                    <div class="step-label">Chụp ảnh lần 2</div>
                                </div>
                                <div class="step" id="step3">
                                    <div class="step-number">3</div>
                                    <div class="step-label">Chụp ảnh lần 3</div>
                                </div>
                            </div>
                        </div>

                        <div class="capture-progress-container">
                            <div class="progress-info">
                                <span>Đã chụp: <strong id="capturedCount">0</strong>/<strong id="targetCount">3</strong></span>
                            </div>
                            <div class="progress-bar-container">
                                <div id="progress-bar" class="progress-bar">0%</div>
                            </div>
                        </div>
                        
                        <div class="avatar-section">
                            <h3>Avatar sinh viên</h3>
                            <div class="avatar-preview">
                                <div id="avatarPlaceholder" class="avatar-placeholder">
                                    <i class="fas fa-user"></i>
                                </div>
                                <img id="avatarPreview" src="" alt="Avatar preview">
                            </div>
                        </div>
                        
                        <div id="faceCaptureStatus" class="capture-status">
                            <i class="fas fa-spinner fa-spin"></i> Đang tải mô hình nhận diện...
                        </div>
                    </div>
                </div>
                
                <div id="previewImages" class="preview-images">
                    <h3>Ảnh đã chụp</h3>
                    <div class="preview-list" id="previewList"></div>
                </div>
            </div>

            <div class="modal-footer" id="faceCaptureFooter">
                <button type="button" class="btn btn-primary btn-lg" id="startCaptureBtn" onclick="startCaptureManually()">
                    <i class="fas fa-play-circle"></i> Bắt đầu chụp
                </button>
                <button type="button" class="btn btn-danger btn-lg" id="cancelCaptureBtn" onclick="cancelFaceCapture()">
                    <i class="fas fa-times-circle"></i> Hủy & Đóng
                </button>
            </div>
        </div>
    </div>

    <div id="notification-container"></div>

    <script>
        // ===============================================
        // 			KHAI BÁO BIẾN GLOBAL
        // ===============================================
        let studentNameMapping = {};
        let studentInfoMapping = {};
        let allStudents = [];
        let filteredStudents = [];
        let faceMatcher = null;
        
        let currentStudentId = null;
        let currentStudentCode = null;
        let captureStream = null;
        let captureInterval = null;
        let capturedDescriptors = [];
        let isCapturing = false;
        const TARGET_DESCRIPTORS = 3;
        const CAPTURE_INTERVAL = 200;
        const CAPTURE_HOLD_TIME = 1500;
        
        // Trạng thái chụp ảnh theo góc
        const CAPTURE_STEPS = [
            { angle: 'CHÍNH DIỆN', guide: 'Vui lòng nhìn thẳng vào camera.', icon: 'fas fa-eye' },
            { angle: 'GÓC TRÁI', guide: 'Vui lòng nghiêng mặt sang TRÁI (nhìn qua vai phải).', icon: 'fas fa-arrow-alt-circle-left' },
            { angle: 'GÓC PHẢI', guide: 'Vui lòng nghiêng mặt sang PHẢI (nhìn qua vai trái).', icon: 'fas fa-arrow-alt-circle-right' }
        ];
        let currentStepIndex = 0;

        // Lấy các element
        const faceCaptureModal = document.getElementById('faceCaptureModal');
        const faceVideo = document.getElementById('faceVideo');
        const faceCanvas = document.getElementById('faceCanvas');
        const faceCaptureStatus = document.getElementById('faceCaptureStatus');
        const currentStudentNameSpan = document.getElementById('currentStudentName');
        const capturedCountSpan = document.getElementById('capturedCount');
        const progressBar = document.getElementById('progress-bar');
        const previewList = document.getElementById('previewList');
        const guideElement = document.getElementById('captureGuide');
        const avatarPreview = document.getElementById('avatarPreview');
        const avatarPlaceholder = document.getElementById('avatarPlaceholder');
        const videoStatus = document.getElementById('videoStatus');
        
        // NEW ELEMENTS (Cho tính năng Start Manual)
        const startCaptureBtn = document.getElementById('startCaptureBtn');
        const cancelCaptureBtn = document.getElementById('cancelCaptureBtn');

        // ===============================================
        // 			XỬ LÝ API VÀ SINH VIÊN - DỮ LIỆU THẬT
        // ===============================================
        async function loadAllStudentEmbeddings() {
            if (faceMatcher) return;
            try {
                const response = await fetch('/api/encodings');
                if (!response.ok) {
                    throw new Error('Failed to fetch encodings');
                }
                const encodingData = await response.json();

                if (encodingData.total_encodings === 0) {
                    console.log("No existing embeddings found for duplicate check.");
                    return;
                }

                const labeledDescriptors = [];
                for (const [ma_sv, info] of Object.entries(encodingData.encodings)) {
                    if (info.count > 0 && info.encodings && info.encodings.length > 0) {
                        const float32Encodings = info.encodings.map(d => new Float32Array(d));
                        labeledDescriptors.push(new faceapi.LabeledFaceDescriptors(ma_sv, float32Encodings));
                    }
                }
                
                if (labeledDescriptors.length > 0) {
                    faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, 0.2);
                    console.log('Face matcher created successfully for duplicate check.');
                    showNotification('Đã tải xong dữ liệu để đối chiếu khuôn mặt.', 'info');
                }

            } catch (error) {
                console.error('Error loading embeddings for face matching:', error);
                showNotification('Không thể tải dữ liệu khuôn mặt để đối chiếu.', 'warning');
            }
        }

        // ===============================================
        // 			CHỨC NĂNG CHUNG & NOTIFICATION
        // ===============================================
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            // Thêm icon tương ứng với loại thông báo
            let icon = '';
            switch(type) {
                case 'success': icon = 'fas fa-check-circle'; break;
                case 'error': icon = 'fas fa-exclamation-circle'; break;
                case 'warning': icon = 'fas fa-exclamation-triangle'; break;
                default: icon = 'fas fa-info-circle';
            }
            
            notification.innerHTML = `<i class="${icon}"></i> ${message}`;
            container.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // Hàm mở/đóng modal mượt mà
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        function openAddModal() {	
            closeModal('faceCaptureModal');	
            openModal('addStudentModal');	
        }
        
        function closeAddModal() {	
            closeModal('addStudentModal');	
            document.getElementById('addStudentForm').reset();
        }

        function closeEditModal() {
            closeModal('editStudentModal');
            document.getElementById('editStudentForm').reset();
        }

        function closeProfileModal() {
            closeModal('viewProfileModal');
        }

        function updateStepIndicator() {
            // Cập nhật trạng thái các bước
            for (let i = 0; i < 3; i++) {
                const step = document.getElementById(`step${i+1}`);
                if (i < currentStepIndex) {
                    step.className = 'step completed';
                } else if (i === currentStepIndex) {
                    step.className = 'step active';
                } else {
                    step.className = 'step';
                }
            }
        }

        function openFaceCaptureModal(id_sv, ma_sv, ho_ten) {
            currentStudentId = id_sv;
            currentStudentCode = ma_sv;
            currentStudentNameSpan.textContent = `${ho_ten} (${ma_sv})`;
            
            // Đặt lại trạng thái modal chụp ảnh
            capturedDescriptors = [];
            currentStepIndex = 0;
            capturedCountSpan.textContent = 0;
            progressBar.style.width = '0%';
            progressBar.textContent = '0%';
            previewList.innerHTML = '';
            faceCaptureStatus.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang chuẩn bị camera...';
            videoStatus.innerHTML = '<i class="fas fa-video"></i> Đang khởi động camera...';
            guideElement.className = 'capture-guide';
            guideElement.innerHTML = `<i class="fas fa-info-circle"></i> Vui lòng giữ khuôn mặt trong khung hình.`;
            document.querySelector('.video-wrapper').style.border = 'none';
            guideElement.style.backgroundColor = '';
            guideElement.style.color = '';
            
            // Reset avatar preview
            avatarPreview.src = '';
            avatarPreview.style.display = 'none';
            avatarPlaceholder.style.display = 'flex';
            
            // Reset nút Bắt đầu/Hủy
            startCaptureBtn.style.display = 'inline-flex'; // Hiển thị nút bắt đầu
            startCaptureBtn.disabled = true; // Vô hiệu hóa nút bắt đầu cho đến khi camera sẵn sàng
            cancelCaptureBtn.innerHTML = '<i class="fas fa-times-circle"></i> Hủy & Đóng'; // Đặt lại nút hủy
            cancelCaptureBtn.classList.remove('btn-success');
            cancelCaptureBtn.classList.remove('btn-outline');
            cancelCaptureBtn.classList.add('btn-danger');

            // Cập nhật chỉ báo bước
            updateStepIndicator();

            closeModal('addStudentModal');
            closeModal('editStudentModal');
            openModal('faceCaptureModal');

            // Khởi tạo camera và models VÀ CHỜ NGƯỜI DÙNG NHẤN START
            initFaceCapture(); 
        }

        async function cancelFaceCapture() {
            stopFaceCapture();
            closeModal('faceCaptureModal');
            await loadStudents();	
        }

        // ===============================================
        // 			LOGIC CHỤP KHUÔN MẶT REAL-TIME
        // ===============================================
        async function loadFaceApiModels() {
            try {
                faceCaptureStatus.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang tải mô hình Face Recognition...';
                
                // Kiểm tra xem faceapi đã được load chưa
                if (typeof faceapi === 'undefined') {
                    throw new Error('FaceAPI chưa được tải. Vui lòng kiểm tra đường dẫn models.');
                }
                
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri('/static/models'),
                    faceapi.nets.faceLandmark68Net.loadFromUri('/static/models'),
                    faceapi.nets.faceRecognitionNet.loadFromUri('/static/models'),
                    faceapi.nets.faceExpressionNet.loadFromUri('/static/models')
                ]);
                
                faceCaptureStatus.innerHTML = '<i class="fas fa-check-circle"></i> Đã tải mô hình thành công!';
                return true;
            } catch (error) {
                console.error("Lỗi khi tải mô hình Face API:", error);
                faceCaptureStatus.innerHTML = '<i class="fas fa-exclamation-circle"></i> Lỗi tải mô hình. Vui lòng kiểm tra console.';
                return false;
            }
        }

        async function initFaceCapture() {
            if (!await loadFaceApiModels()) return;
            
            // Luôn làm mới face matcher để cập nhật dữ liệu mới nhất
            faceMatcher = null;	
            await loadAllStudentEmbeddings();

            try {
                captureStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 640 }, 
                        height: { ideal: 480 },
                        facingMode: "user"
                    } 
                });
                faceVideo.srcObject = captureStream;
                
                faceVideo.addEventListener('loadedmetadata', () => {
                    faceCanvas.width = faceVideo.videoWidth;
                    faceCanvas.height = faceVideo.videoHeight;
                    
                    // Khởi tạo kích thước cho faceapi
                    if (typeof faceapi !== 'undefined') {
                        faceapi.matchDimensions(faceCanvas, { width: faceVideo.videoWidth, height: faceVideo.videoHeight });
                    }
                    
                    videoStatus.innerHTML = '<i class="fas fa-check-circle"></i> Camera sẵn sàng. Vui lòng bấm "Bắt đầu chụp"';
                    
                    // Kích hoạt nút BẮT ĐẦU CHỤP khi camera sẵn sàng
                    startCaptureBtn.disabled = false;
                    cancelCaptureBtn.disabled = false;
                    faceCaptureStatus.innerHTML = '<i class="fas fa-hand-pointer"></i> Sẵn sàng. Nhấn **Bắt đầu chụp** để tiếp tục.';
                }, { once: true });

            } catch (error) {
                console.error("Lỗi khi truy cập camera:", error);
                faceCaptureStatus.innerHTML = `<i class="fas fa-exclamation-circle"></i> Lỗi: Không thể truy cập camera. ${error.message}`;
                videoStatus.innerHTML = '<i class="fas fa-times-circle"></i> Lỗi camera';
                startCaptureBtn.disabled = true;
            }
        }

        function stopFaceCapture() {
            if (captureInterval) {
                clearInterval(captureInterval);
                captureInterval = null;
            }
            if (captureStream) {
                captureStream.getTracks().forEach(track => track.stop());
                faceVideo.srcObject = null;
                captureStream = null;
            }
            if (faceCanvas) {
                const context = faceCanvas.getContext('2d');
                context.clearRect(0, 0, faceCanvas.width, faceCanvas.height);
            }
            isCapturing = false;
        }

        // HÀM MỚI: KÍCH HOẠT CHỤP THỦ CÔNG
        function startCaptureManually() {
            if (!captureStream) {
                showNotification('Camera chưa sẵn sàng. Vui lòng thử lại.', 'warning');
                return;
            }

            // Ẩn nút bắt đầu và vô hiệu hóa nút hủy trong khi chụp
            startCaptureBtn.style.display = 'none';
            cancelCaptureBtn.disabled = true;
            cancelCaptureBtn.classList.remove('btn-danger');
            cancelCaptureBtn.classList.add('btn-outline');

            startFaceCapture();
        }

        function startFaceCapture() {
            isCapturing = true;
            
            faceCaptureStatus.innerHTML = '<i class="fas fa-camera"></i> Bắt đầu thu thập ảnh...';
            
            // Bắt đầu chu kỳ phát hiện và chụp
            captureInterval = setInterval(processNextCaptureStep, CAPTURE_INTERVAL);
        }
        
        async function processNextCaptureStep() {
            if (!isCapturing || currentStepIndex >= CAPTURE_STEPS.length) {
                 if (captureInterval) {
                     clearInterval(captureInterval);
                     captureInterval = null;
                 }
                 if (currentStepIndex >= CAPTURE_STEPS.length) {
                     await finalizeCapture();
                 }
                 return;
            }

            const currentStep = CAPTURE_STEPS[currentStepIndex];
            guideElement.innerHTML = `<i class="${currentStep.icon}"></i> <strong>Bước ${currentStepIndex + 1}/${TARGET_DESCRIPTORS} (${currentStep.angle})</strong>: ${currentStep.guide}`;
            updateStepIndicator();

            try {
                const detection = await faceapi
                    .detectSingleFace(faceVideo, new faceapi.TinyFaceDetectorOptions())
                    .withFaceLandmarks()
                    .withFaceDescriptor()
                    .withFaceExpressions();

                const context = faceCanvas.getContext('2d');
                context.clearRect(0, 0, faceCanvas.width, faceCanvas.height);
                
                if (detection) {
                    // Check for duplicates before proceeding
                    if (faceMatcher) {
                        const bestMatch = faceMatcher.findBestMatch(detection.descriptor);
                        console.log(`Duplicate check: ${bestMatch.toString()}`);
                        if (bestMatch.label !== 'unknown' && bestMatch.label !== currentStudentCode) {
                            const matchedStudentName = studentNameMapping[bestMatch.label] || bestMatch.label;
                            const errorMessage = `Lỗi: Khuôn mặt này đã được đăng ký cho SV ${matchedStudentName} (${bestMatch.label}).`;
                            
                            faceCaptureStatus.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${errorMessage}`;
                            showNotification(errorMessage, 'error');
                            
                            stopFaceCapture();
                            
                            document.querySelector('.video-wrapper').style.border = '3px solid var(--danger-color)';
                            guideElement.innerHTML = `<i class="fas fa-times-circle"></i> THU THẬP THẤT BẠI`;
                            guideElement.className = 'capture-guide';
                            guideElement.style.backgroundColor = 'var(--danger-color)';
                            guideElement.style.color = 'white';
                            cancelCaptureBtn.disabled = false;
                            cancelCaptureBtn.classList.remove('btn-outline');
                            cancelCaptureBtn.classList.add('btn-danger');
                            startCaptureBtn.style.display = 'none';

                            return;
                        }
                    }

                    const resizedDetection = faceapi.resizeResults(detection, { width: faceVideo.videoWidth, height: faceVideo.videoHeight });
                    
                    // Vẽ khung phát hiện khuôn mặt
                    faceapi.draw.drawDetections(faceCanvas, resizedDetection);
                    
                    // Vẽ các điểm mốc khuôn mặt
                    faceapi.draw.drawFaceLandmarks(faceCanvas, resizedDetection);
                    
                    if (detection.detection.score > 0.8 && isCapturing) {
                        // Phát hiện khuôn mặt rõ ràng, tiến hành chụp
                        isCapturing = false;
                        
                        await captureAndStoreDescriptor(detection);

                        faceCaptureStatus.innerHTML = `<i class="fas fa-check"></i> <strong>Đã chụp ${currentStep.angle}</strong>! Vui lòng giữ nguyên 1.5 giây...`;
                        guideElement.classList.add('success');
                        
                        clearInterval(captureInterval);
                        captureInterval = null;

                        await new Promise(resolve => setTimeout(resolve, CAPTURE_HOLD_TIME));

                        // Chuyển sang bước tiếp theo
                        currentStepIndex++;
                        guideElement.classList.remove('success');

                        if (currentStepIndex < CAPTURE_STEPS.length) {
                            isCapturing = true;
                            captureInterval = setInterval(processNextCaptureStep, CAPTURE_INTERVAL);
                        } else {
                            await finalizeCapture();
                        }

                    } else {
                        faceCaptureStatus.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Vui lòng căn chỉnh khuôn mặt rõ hơn hoặc xoay góc yêu cầu.';
                    }
                } else {
                    faceCaptureStatus.innerHTML = '<i class="fas fa-user-slash"></i> Không phát hiện thấy khuôn mặt.';
                }
            } catch (error) {
                console.error('Lỗi trong quá trình phát hiện khuôn mặt:', error);
                faceCaptureStatus.innerHTML = '<i class="fas fa-exclamation-circle"></i> Lỗi phát hiện khuôn mặt.';
            }
        }

        async function captureAndStoreDescriptor(detection) {
            try {
                // 1. Lưu descriptor
                capturedDescriptors.push(Array.from(detection.descriptor));
                capturedCountSpan.textContent = capturedDescriptors.length;
                
                const progress = (capturedDescriptors.length / TARGET_DESCRIPTORS) * 100;
                progressBar.style.width = `${progress}%`;
                progressBar.textContent = `${Math.round(progress)}%`;

                // 2. Tạo preview ảnh 
                const faceBox = detection.detection.box;
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = faceBox.width;
                tempCanvas.height = faceBox.height;
                const tempCtx = tempCanvas.getContext('2d');
                tempCtx.drawImage(faceVideo, faceBox.x, faceBox.y, faceBox.width, faceBox.height, 0, 0, faceBox.width, faceBox.height);
                
                const img = document.createElement('img');
                img.src = tempCanvas.toDataURL('image/jpeg');
                img.classList.add('captured');
                img.title = `Ảnh ${capturedDescriptors.length}: ${CAPTURE_STEPS[currentStepIndex].angle}`;
                previewList.appendChild(img);

                // 3. Cập nhật avatar preview với ảnh chính diện (bước đầu tiên)
                if (currentStepIndex === 0) {
                    // Tạo avatar từ khuôn mặt đã chụp
                    createAvatarFromFace(detection);
                }
            } catch (error) {
                console.error('Lỗi khi chụp và lưu descriptor:', error);
            }
        }

        function createAvatarFromFace(detection) {
            try {
                const faceBox = detection.detection.box;
                
                // Tạo canvas để cắt khuôn mặt
                const avatarCanvas = document.createElement('canvas');
                const avatarSize = 200; // Kích thước avatar
                avatarCanvas.width = avatarSize;
                avatarCanvas.height = avatarSize;
                const avatarCtx = avatarCanvas.getContext('2d');
                
                // Tính toán để cắt khuôn mặt với padding
                const padding = 0.2; // 20% padding xung quanh khuôn mặt
                const paddedWidth = faceBox.width * (1 + padding * 2);
                const paddedHeight = faceBox.height * (1 + padding * 2);
                const paddedX = Math.max(0, faceBox.x - faceBox.width * padding);
                const paddedY = Math.max(0, faceBox.y - faceBox.height * padding);
                
                // Vẽ khuôn mặt với padding vào canvas avatar
                avatarCtx.drawImage(
                    faceVideo,	
                    paddedX, paddedY, paddedWidth, paddedHeight,
                    0, 0, avatarSize, avatarSize
                );
                
                // Chuyển canvas thành hình tròn
                const roundedCanvas = document.createElement('canvas');
                roundedCanvas.width = avatarSize;
                roundedCanvas.height = avatarSize;
                const roundedCtx = roundedCanvas.getContext('2d');
                
                // Vẽ hình tròn làm mask
                roundedCtx.beginPath();
                roundedCtx.arc(avatarSize/2, avatarSize/2, avatarSize/2, 0, Math.PI * 2);
                roundedCtx.closePath();
                roundedCtx.clip();
                
                // Vẽ ảnh đã cắt vào hình tròn
                roundedCtx.drawImage(avatarCanvas, 0, 0, avatarSize, avatarSize);
                
                // Cập nhật avatar preview
                avatarPreview.src = roundedCanvas.toDataURL('image/jpeg');
                avatarPreview.style.display = 'block';
                avatarPlaceholder.style.display = 'none';
            } catch (error) {
                console.error('Lỗi khi tạo avatar:', error);
            }
        }

        async function finalizeCapture() {
            stopFaceCapture();
            faceCaptureStatus.innerHTML = `<i class="fas fa-upload fa-spin"></i> Đã thu thập đủ ${TARGET_DESCRIPTORS} ảnh. Đang gửi dữ liệu lên server...`;
            guideElement.innerHTML = `<i class="fas fa-robot"></i> Đang huấn luyện...`;
            
            let successCount = 0;
            for (const descriptor of capturedDescriptors) {
                const trained = await trainFace(currentStudentId, currentStudentCode, descriptor);
                if (trained) {
                    successCount++;
                }
                await new Promise(resolve => setTimeout(resolve, 50));
            }

            if (successCount === capturedDescriptors.length) {
                faceCaptureStatus.innerHTML = `<i class="fas fa-check-circle"></i> Hoàn thành! Đã train thành công <strong>${successCount}</strong> khuôn mặt!`;
                guideElement.innerHTML = `<i class="fas fa-thumbs-up"></i> Hoàn thành! Sẵn sàng đóng.`;
                guideElement.classList.add('success');
                showNotification(`Đã train thành công tất cả ${successCount} khuôn mặt! Đang cập nhật danh sách.`, 'success');
                
                // Cập nhật nút Hủy & Đóng thành Hoàn thành
                cancelCaptureBtn.innerHTML = '<i class="fas fa-check-circle"></i> Hoàn thành';
                cancelCaptureBtn.classList.remove('btn-danger');
                cancelCaptureBtn.classList.remove('btn-outline');
                cancelCaptureBtn.classList.add('btn-success');
                cancelCaptureBtn.disabled = false; // Kích hoạt lại nút đóng

                // Tự động đóng modal sau 2 giây
                setTimeout(() => {
                    closeModal('faceCaptureModal');
                    loadStudents();
                }, 2000);
            } else {
                faceCaptureStatus.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Hoàn thành với <strong>${successCount}/${capturedDescriptors.length}</strong> khuôn mặt được train.`;
                guideElement.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Xảy ra lỗi. Vui lòng bấm Hủy & Đóng và thử lại.`;
                showNotification(`Hoàn thành với ${successCount}/${capturedDescriptors.length} khuôn mặt được train.`, 'warning');
                cancelCaptureBtn.disabled = false; // Kích hoạt lại nút đóng
            }
        }

        // ===============================================
        // 			XỬ LÝ API VÀ SINH VIÊN - DỮ LIỆU THẬT
        // ===============================================

        // Hàm lấy danh sách sinh viên từ API thật
        async function loadStudents() {
            try {
                const studentList = document.getElementById('studentList');
                const emptyState = document.getElementById('emptyState');
                
                if (!studentList) return;
                
                // Hiển thị loading
                studentList.innerHTML = `
                    <div class="loading-state">
                        <div class="spinner"></div>
                        <p>Đang tải dữ liệu sinh viên...</p>
                    </div>
                `;
                emptyState.classList.add('hidden');
                
                // Gọi API thật để lấy danh sách sinh viên
                const response = await fetch('/api/sinh-vien', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                allStudents = await response.json();
                filteredStudents = [...allStudents];

                studentList.innerHTML = '';
                studentNameMapping = {};
                allStudents.forEach(s => { studentNameMapping[s.ma_sv] = s.ho_ten; });

                // Cập nhật thống kê
                updateStatistics(allStudents);
                
                // Cập nhật bộ lọc
                updateFilters(allStudents);

                if (allStudents.length === 0) {
                    emptyState.classList.remove('hidden');
                    return;
                }

                // Trong hàm loadStudents(), tìm phần hiển thị danh sách sinh viên và cập nhật:
                allStudents.forEach((student, index) => { // Thêm index parameter
                    const studentDiv = document.createElement('div');
                    studentDiv.className = 'student-item';
                    
                    let faceStatusIcon = '';
                    let faceStatusText = `${student.so_anh_khuon_mat || 0} ảnh`;
                    let trainButtonClass = 'btn-primary';

                    if (student.so_anh_khuon_mat >= TARGET_DESCRIPTORS) {
                        faceStatusIcon = '<i class="fas fa-check-circle" style="color: var(--success-color);"></i>';
                        trainButtonClass = 'btn-success';
                    } else if (student.so_anh_khuon_mat > 0) {
                        faceStatusIcon = '<i class="fas fa-exclamation-triangle" style="color: var(--warning-color);"></i>';
                        trainButtonClass = 'btn-primary';
                    } else {
                        faceStatusIcon = '<i class="fas fa-times-circle" style="color: var(--danger-color);"></i>';
                        trainButtonClass = 'btn-primary';
                    }

                    // Tính số thứ tự (index + 1)
                    const sttNumber = index + 1;
                    
                    // Hiển thị avatar với số thứ tự
                    const initials = student.ho_ten ?	
                        student.ho_ten.split(' ').map(n => n[0]).join('').toUpperCase() : 'SV';
                    const avatarHtml = `<div class="avatar-placeholder"><span class="student-index small">${sttNumber}</span></div>`;

                    studentDiv.innerHTML = `
                        <div class="student-info">
                            ${avatarHtml}
                            <div class="student-details">
                                <div class="student-name">${student.ho_ten} (${student.ma_sv})</div>
                                <div class="student-details-text">
                                    Lớp: ${student.lop} | Khoa: ${student.khoa || 'Chưa cập nhật'} | Giới tính: ${student.gioi_tinh || 'N/A'}
                                    <br>
                                    ${faceStatusIcon} <strong>Dữ liệu khuôn mặt:</strong> ${faceStatusText}
                                </div>
                            </div>
                        </div>
                        <div class="student-actions">
                            <button class="btn btn-outline btn-sm" onclick="viewStudentProfile(${student.id_sv})" title="Xem hồ sơ">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-primary btn-sm" onclick="editStudent(${student.id_sv})" title="Sửa thông tin">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn ${trainButtonClass} btn-sm" onclick="trainFaceRedirect(${student.id_sv}, '${student.ma_sv}', '${student.ho_ten.replace(/'/g, "\\'")}')" title="Train khuôn mặt">
                                <i class="fas fa-camera"></i>
                            </button>
                            <button class="btn btn-danger btn-sm delete-student-btn" data-id="${student.id_sv}" title="Xóa sinh viên">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    studentList.appendChild(studentDiv);
                    studentNameMapping[student.ma_sv] = student.ho_ten;
                });
                // Thêm event listeners cho nút xóa
                document.querySelectorAll('.delete-student-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const id_sv = e.currentTarget.dataset.id;
                        if (confirm('Bạn có chắc muốn xóa sinh viên này và tất cả dữ liệu khuôn mặt liên quan?')) {
                            await deleteStudent(id_sv);
                        }
                    });
                });

                // Render bảng nếu đang ở chế độ bảng
                if (!document.getElementById('tableView').classList.contains('hidden')) {
                    renderTableView();
                }

            } catch (e) {
                console.error("Lỗi khi tải danh sách sinh viên:", e);
                const studentList = document.getElementById('studentList');
                if (studentList) {
                    studentList.innerHTML = '<div class="student-item" style="color: var(--danger-color); text-align: center; padding: 20px;"><i class="fas fa-exclamation-circle"></i> Lỗi tải danh sách sinh viên. Vui lòng kiểm tra kết nối.</div>';
                }
                showNotification('Lỗi khi tải danh sách sinh viên: ' + e.message, 'error');
                
                // Kiểm tra nếu lỗi 401 (chưa đăng nhập)
                if (e.message.includes('401')) {
                    showNotification('Vui lòng đăng nhập để tiếp tục', 'error');
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 2000);
                }
            }
        }

        // Hàm xóa sinh viên với API thật
        async function deleteStudent(id_sv) {
            try {
                const response = await fetch(`/api/sinh-vien/${id_sv}`, {	
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    await loadStudents();
                    showNotification('Đã xóa sinh viên thành công!', 'success');
                } else {
                    throw new Error(result.error || 'Lỗi không xác định');
                }
            } catch (error) {
                console.error('Lỗi xóa sinh viên:', error);
                showNotification('Lỗi khi xóa sinh viên: ' + error.message, 'error');
            }
        }

        // Hàm train khuôn mặt với API thật
        async function trainFace(id_sv, ma_sv, descriptor) {
            try {
                const response = await fetch('/api/train', {
                    method: 'POST',
                    headers: {	
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        id_sv: id_sv,
                        ma_sv: ma_sv,
                        descriptor: descriptor
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                return result.success;
            } catch (error) {
                console.error('Lỗi train khuôn mặt:', error);
                showNotification('Lỗi khi train khuôn mặt: ' + error.message, 'error');
                return false;
            }
        }

        // Hàm lấy thông tin thống kê từ API thật
        async function loadRealStats() {
            try {
                const response = await fetch('/api/stats', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const stats = await response.json();
                    document.getElementById('totalStudents').textContent = stats.total_students || 0;
                    document.getElementById('trainedStudents').textContent = stats.total_encodings || 0;
                    document.getElementById('pendingStudents').textContent = (stats.total_students || 0) - (stats.total_encodings || 0);
                }
            } catch (error) {
                console.error('Lỗi tải thống kê:', error);
            }
        }

        // Cập nhật hàm updateStatistics để sử dụng dữ liệu thật
        function updateStatistics(students) {
            const totalStudents = students.length;
            const trainedStudents = students.filter(s => (s.so_anh_khuon_mat || 0) >= TARGET_DESCRIPTORS).length;
            const pendingStudents = students.filter(s => (s.so_anh_khuon_mat || 0) === 0).length;
            
            document.getElementById('totalStudents').textContent = totalStudents;
            document.getElementById('trainedStudents').textContent = trainedStudents;
            document.getElementById('pendingStudents').textContent = pendingStudents;
        }

        document.getElementById('addStudentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const form = this;
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            
            try {
                // Hiển thị trạng thái loading
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang xử lý...';
                
                const formData = new FormData(form);
                const data = Object.fromEntries(formData);
                
                // Chuẩn bị dữ liệu gửi lên server
                const studentData = {
                    ma_sv: data.ma_sv,
                    ho_ten: data.ho_ten,
                    lop: data.lop,
                    khoa: data.khoa || '',
                    nganh_hoc: data.nganh_hoc || '',
                    gioi_tinh: data.gioi_tinh || 'Khác',
                    so_dien_thoai: data.so_dien_thoai || '',
                    email: data.email || '',
                    trang_thai: 'Đang học'
                };
                
                const response = await fetch('/api/sinh-vien', {
                    method: 'POST',
                    headers: {	
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify(studentData)
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    showNotification('Đã thêm sinh viên thành công!', 'success');
                    closeAddModal();
                    openFaceCaptureModal(result.id_sv, data.ma_sv, data.ho_ten);
                } else {
                    throw new Error(result.error || 'Lỗi không xác định khi thêm sinh viên');
                }
            } catch (error) {
                console.error('Lỗi thêm sinh viên:', error);
                showNotification('Lỗi: ' + error.message, 'error');
            } finally {
                // Khôi phục trạng thái nút
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        });

        // Xử lý form sửa sinh viên
        document.getElementById('editStudentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const form = this;
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            
            try {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang cập nhật...';
                
                const formData = new FormData(form);
                const data = Object.fromEntries(formData);
                
                const studentData = {
                    id_sv: parseInt(data.id_sv),
                    ho_ten: data.ho_ten,
                    lop: data.lop,
                    khoa: data.khoa || '',
                    nganh_hoc: data.nganh_hoc || '',
                    gioi_tinh: data.gioi_tinh || 'Khác',
                    so_dien_thoai: data.so_dien_thoai || '',
                    email: data.email || ''
                };
                
                const response = await fetch('/api/sinh-vien', {
                    method: 'PUT',
                    headers: {	
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify(studentData)
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    showNotification('Đã cập nhật thông tin sinh viên thành công!', 'success');
                    closeEditModal();
                    await loadStudents();
                } else {
                    throw new Error(result.error || 'Lỗi không xác định khi cập nhật sinh viên');
                }
            } catch (error) {
                console.error('Lỗi cập nhật sinh viên:', error);
                showNotification('Lỗi: ' + error.message, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        });

        // ===============================================
        // 			CHỨC NĂNG MỚI: XEM, SỬA, BẢNG
        // ===============================================

        // Chuyển đổi giữa dạng bảng và danh sách
        function initViewToggle() {
            const tableView = document.getElementById('tableView');
            const listView = document.getElementById('listView');
            const viewButtons = document.querySelectorAll('.view-toggle .btn');
            
            viewButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    const view = this.dataset.view;
                    
                    // Update active state
                    viewButtons.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Show/hide views
                    if (view === 'table') {
                        tableView.classList.remove('hidden');
                        listView.classList.add('hidden');
                        renderTableView();
                    } else {
                        tableView.classList.add('hidden');
                        listView.classList.remove('hidden');
                    }
                });
            });
        }

       // Hiển thị dạng bảng
        function renderTableView() {
            const tbody = document.getElementById('studentTableBody');
            
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            const studentsToRender = filteredStudents.length > 0 ? filteredStudents : allStudents;
            
            studentsToRender.forEach((student, index) => { // Thêm index parameter
                const row = document.createElement('tr');
                
                // Xác định trạng thái khuôn mặt
                let faceStatus = '';
                let statusClass = '';
                const faceCount = student.so_anh_khuon_mat || 0;
                
                if (faceCount >= TARGET_DESCRIPTORS) {
                    faceStatus = `<span class="status-badge trained">Đã train (${faceCount})</span>`;
                } else if (faceCount > 0) {
                    faceStatus = `<span class="status-badge partial">Train một phần (${faceCount})</span>`;
                } else {
                    faceStatus = `<span class="status-badge none">Chưa train</span>`;
                }
                
                // Tính số thứ tự (index + 1)
                const sttNumber = index + 1;
                
                row.innerHTML = `
                    <td class="stt-column">
                        <span class="student-index">${sttNumber}</span>
                    </td>
                    <td>${student.ma_sv}</td>
                    <td>
                        <div class="student-name">${student.ho_ten}</div>
                    </td>
                    <td>${student.lop}</td>
                    <td>${student.khoa || 'N/A'}</td>
                    <td>${student.gioi_tinh || 'N/A'}</td>
                    <td>${faceStatus}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-outline btn-sm" onclick="viewStudentProfile(${student.id_sv})" title="Xem hồ sơ">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-primary btn-sm" onclick="editStudent(${student.id_sv})" title="Sửa thông tin">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-success btn-sm" onclick="trainFaceRedirect(${student.id_sv}, '${student.ma_sv}', '${student.ho_ten.replace(/'/g, "\\'")}')" title="Train khuôn mặt">
                                <i class="fas fa-camera"></i>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteStudent(${student.id_sv})" title="Xóa sinh viên">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }
        // Mở modal xem hồ sơ
        async function viewStudentProfile(id_sv) {
            try {
                const student = allStudents.find(s => s.id_sv == id_sv);
                if (!student) {
                    showNotification('Không tìm thấy thông tin sinh viên', 'error');
                    return;
                }
                
                // Điền thông tin vào modal
                document.getElementById('profile_ho_ten').textContent = student.ho_ten;
                document.getElementById('profile_ma_sv').textContent = student.ma_sv;
                document.getElementById('profile_lop').textContent = student.lop;
                document.getElementById('profile_khoa').textContent = student.khoa || 'Chưa cập nhật';
                document.getElementById('profile_nganh_hoc').textContent = student.nganh_hoc || 'Chưa cập nhật';
                document.getElementById('profile_gioi_tinh').textContent = student.gioi_tinh || 'N/A';
                document.getElementById('profile_email').textContent = student.email || 'Chưa cập nhật';
                document.getElementById('profile_so_dien_thoai').textContent = student.so_dien_thoai || 'Chưa cập nhật';
                document.getElementById('profile_so_anh').textContent = student.so_anh_khuon_mat || 0;
                
                // Cập nhật avatar
                const avatarImg = document.getElementById('profile_avatar');
                const avatarPlaceholder = document.getElementById('profile_avatar_placeholder');
                
                // Tạo avatar từ chữ cái đầu
                const initials = student.ho_ten ?	
                    student.ho_ten.split(' ').map(n => n[0]).join('').toUpperCase() : 'SV';
                avatarPlaceholder.innerHTML = initials;
                avatarImg.style.display = 'none';
                avatarPlaceholder.style.display = 'flex';
                
                // Cập nhật trạng thái khuôn mặt
                const faceCount = student.so_anh_khuon_mat || 0;
                let faceStatus = '';
                let statusClass = '';
                
                if (faceCount >= TARGET_DESCRIPTORS) {
                    faceStatus = 'Đã train đủ';
                    statusClass = 'trained';
                } else if (faceCount > 0) {
                    faceStatus = 'Train một phần';
                    statusClass = 'partial';
                } else {
                    faceStatus = 'Chưa train';
                    statusClass = 'none';
                }
                
                document.getElementById('profile_face_status').textContent = faceStatus;
                document.getElementById('profile_status').textContent = faceStatus;
                document.getElementById('profile_status').className = `status-badge ${statusClass}`;
                
                // Lần cập nhật cuối
                document.getElementById('profile_last_update').textContent = student.created_at || 'Chưa cập nhật';
                
                openModal('viewProfileModal');
                
            } catch (error) {
                console.error('Lỗi khi xem hồ sơ:', error);
                showNotification('Lỗi khi tải thông tin hồ sơ', 'error');
            }
        }

        // Mở modal sửa sinh viên
        async function editStudent(id_sv) {
            try {
                const student = allStudents.find(s => s.id_sv == id_sv);
                if (!student) {
                    showNotification('Không tìm thấy sinh viên', 'error');
                    return;
                }
                
                // Điền thông tin vào form
                document.getElementById('edit_id_sv').value = student.id_sv;
                document.getElementById('edit_ma_sv').value = student.ma_sv;
                document.getElementById('edit_ho_ten').value = student.ho_ten;
                document.getElementById('edit_lop').value = student.lop;
                document.getElementById('edit_khoa').value = student.khoa || '';
                document.getElementById('edit_email').value = student.email || '';
                document.getElementById('edit_gioi_tinh').value = student.gioi_tinh || '';
                document.getElementById('edit_nganh_hoc').value = student.nganh_hoc || '';
                document.getElementById('edit_so_dien_thoai').value = student.so_dien_thoai || '';
                
                openModal('editStudentModal');
                
            } catch (error) {
                console.error('Lỗi khi mở form sửa:', error);
                showNotification('Lỗi khi tải thông tin sinh viên', 'error');
            }
        }

        // Sửa từ profile
        function editFromProfile() {
            closeProfileModal();
            const id_sv = document.getElementById('edit_id_sv').value;
            if (id_sv) {
                editStudent(parseInt(id_sv));
            }
        }

        function updateFilters(students) {
            const facultyFilter = document.getElementById('facultyFilter');
            const classFilter = document.getElementById('classFilter');
            
            // Lấy danh sách khoa và lớp duy nhất
            const faculties = [...new Set(students.map(s => s.khoa).filter(Boolean))];
            const classes = [...new Set(students.map(s => s.lop).filter(Boolean))];
            
            // Cập nhật filter khoa
            facultyFilter.innerHTML = '<option value="">Tất cả khoa</option>';
            faculties.forEach(faculty => {
                facultyFilter.innerHTML += `<option value="${faculty}">${faculty}</option>`;
            });
            
            // Cập nhật filter lớp
            classFilter.innerHTML = '<option value="">Tất cả lớp</option>';
            classes.forEach(cls => {
                classFilter.innerHTML += `<option value="${cls}">${cls}</option>`;
            });
        }

        function filterStudents() {
            const searchTerm = document.getElementById('studentSearch').value.toLowerCase();
            const faculty = document.getElementById('facultyFilter').value;
            const classVal = document.getElementById('classFilter').value;
            const trainingStatus = document.getElementById('trainingFilter').value;
            
            filteredStudents = allStudents.filter(student => {
                // Tìm kiếm theo tên, mã SV, lớp
                const matchesSearch = !searchTerm ||	
                    student.ho_ten.toLowerCase().includes(searchTerm) ||
                    student.ma_sv.toLowerCase().includes(searchTerm) ||
                    (student.lop && student.lop.toLowerCase().includes(searchTerm));
                    
                // Lọc theo khoa
                const matchesFaculty = !faculty || student.khoa === faculty;
                
                // Lọc theo lớp
                const matchesClass = !classVal || student.lop === classVal;
                
                // Lọc theo trạng thái train
                let matchesTraining = true;
                const faceCount = student.so_anh_khuon_mat || 0;
                
                if (trainingStatus === 'trained') {
                    matchesTraining = faceCount >= TARGET_DESCRIPTORS;
                } else if (trainingStatus === 'partial') {
                    matchesTraining = faceCount > 0 && faceCount < TARGET_DESCRIPTORS;
                } else if (trainingStatus === 'none') {
                    matchesTraining = faceCount === 0;
                }
                
                return matchesSearch && matchesFaculty && matchesClass && matchesTraining;
            });
            
            // Render lại bảng nếu đang ở chế độ bảng
            if (!document.getElementById('tableView').classList.contains('hidden')) {
                renderTableView();
            } else {
                renderFilteredStudents();
            }
        }

        function renderFilteredStudents() {
            const studentList = document.getElementById('studentList');
            const emptyState = document.getElementById('emptyState');
            
            studentList.innerHTML = '';
            
            if (filteredStudents.length === 0) {
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            
            filteredStudents.forEach((student, index) => {
                const studentDiv = document.createElement('div');
                studentDiv.className = 'student-item';
                
                let faceStatusIcon = '';
                let faceStatusText = `${student.so_anh_khuon_mat || 0} ảnh`;
                let trainButtonClass = 'btn-primary';

                if (student.so_anh_khuon_mat >= TARGET_DESCRIPTORS) {
                    faceStatusIcon = '<i class="fas fa-check-circle" style="color: var(--success-color);"></i>';
                    trainButtonClass = 'btn-success';
                } else if (student.so_anh_khuon_mat > 0) {
                    faceStatusIcon = '<i class="fas fa-exclamation-triangle" style="color: var(--warning-color);"></i>';
                    trainButtonClass = 'btn-primary';
                } else {
                    faceStatusIcon = '<i class="fas fa-times-circle" style="color: var(--danger-color);"></i>';
                    trainButtonClass = 'btn-primary';
                }

                // Tính số thứ tự (index + 1)
                const sttNumber = allStudents.findIndex(s => s.id_sv === student.id_sv) + 1;

                // Hiển thị avatar
                const initials = student.ho_ten ?	
                    student.ho_ten.split(' ').map(n => n[0]).join('').toUpperCase() : 'SV';
                const avatarHtml = `<div class="avatar-placeholder"><span class="student-index small">${sttNumber}</span></div>`;

                studentDiv.innerHTML = `
                    <div class="student-info">
                        ${avatarHtml}
                        <div class="student-details">
                            <div class="student-name">${student.ho_ten} (${student.ma_sv})</div>
                            <div class="student-details-text">
                                Lớp: ${student.lop} | Khoa: ${student.khoa || 'Chưa cập nhật'} | Giới tính: ${student.gioi_tinh || 'N/A'}
                                <br>
                                ${faceStatusIcon} <strong>Dữ liệu khuôn mặt:</strong> ${faceStatusText}
                            </div>
                        </div>
                    </div>
                    <div class="student-actions">
                        <button class="btn btn-outline btn-sm" onclick="viewStudentProfile(${student.id_sv})" title="Xem hồ sơ">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="editStudent(${student.id_sv})" title="Sửa thông tin">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn ${trainButtonClass} btn-sm" onclick="trainFaceRedirect(${student.id_sv}, '${student.ma_sv}', '${student.ho_ten.replace(/'/g, "\\'")}')" title="Train/Chụp lại khuôn mặt">
                            <i class="fas fa-camera"></i> Train
                        </button>
                        <button class="btn btn-danger btn-sm delete-student-btn" data-id="${student.id_sv}" title="Xóa sinh viên">
                            <i class="fas fa-trash"></i> Xóa
                        </button>
                    </div>
                `;
                studentList.appendChild(studentDiv);
            });

            // Thêm event listeners cho nút xóa
            document.querySelectorAll('.delete-student-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const id_sv = e.currentTarget.dataset.id;
                    if (confirm('Bạn có chắc muốn xóa sinh viên này và tất cả dữ liệu khuôn mặt liên quan?')) {
                        await deleteStudent(id_sv);
                    }
                });
            });
        }
        
        function trainFaceRedirect(id_sv, ma_sv, ho_ten) {
            openFaceCaptureModal(id_sv, ma_sv, ho_ten);
        }

        // Hàm kiểm tra trạng thái đăng nhập
        async function checkLoginStatus() {
            try {
                const response = await fetch('/api/user-info', {
                    method: 'GET',
                    credentials: 'include'
                });
                return response.ok;
            } catch (error) {
                return false;
            }
        }
        
        // Hàm đồng bộ encodings từ server
        async function syncEncodings() {
            try {
                const response = await fetch('/api/sync-encodings', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showNotification(result.message, 'success');
                    await loadStudents();
                }
            } catch (error) {
                console.error('Lỗi đồng bộ encodings:', error);
                showNotification('Lỗi khi đồng bộ encodings', 'error');
            }
        }

        // Khởi tạo trang với dữ liệu thật
        document.addEventListener('DOMContentLoaded', () => {
            // Kiểm tra đăng nhập trước
            checkLoginStatus().then(isLoggedIn => {
                if (isLoggedIn) {
                    loadStudents();
                    loadRealStats();
                    loadAllStudentEmbeddings();
                } else {
                    window.location.href = '/login';
                }
            });
            
            initViewToggle();
            
            // Thêm event listeners cho bộ lọc
            document.getElementById('studentSearch').addEventListener('input', filterStudents);
            document.getElementById('facultyFilter').addEventListener('change', filterStudents);
            document.getElementById('classFilter').addEventListener('change', filterStudents);
            document.getElementById('trainingFilter').addEventListener('change', filterStudents);
            
            // Nút làm mới
            document.getElementById('refreshBtn').addEventListener('click', () => {
                loadStudents();
                loadRealStats();
            });
        });
    </script>
</body>
</html>
{% endblock %}