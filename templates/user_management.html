{% extends "header.html" %}

{% block title %}Quản lý người dùng - Hệ thống DLA{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-slate-800"><i class="fas fa-user-shield mr-2 text-indigo-600"></i>Quản lý người dùng</h1>
        <button onclick="window.openAddUserModal()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors shadow-md flex items-center gap-2">
            <i class="fas fa-plus"></i> Thêm Admin
        </button>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse">
                <thead class="bg-slate-50 text-slate-500 font-semibold text-sm uppercase tracking-wider">
                    <tr>
                        <th class="px-6 py-4 w-16">ID</th>
                        <th class="px-6 py-4">Username</th>
                        <th class="px-6 py-4">Họ tên</th>
                        <th class="px-6 py-4">Email</th>
                        <th class="px-6 py-4">Vai trò</th>
                        <th class="px-6 py-4">Trạng thái</th>
                        <th class="px-6 py-4 text-right">Thao tác</th>
                    </tr>
                </thead>
                <tbody id="userTableBody" class="divide-y divide-slate-100 text-slate-600 text-sm"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal -->
<div id="userModal" class="fixed inset-0 bg-slate-900 bg-opacity-50 z-50 hidden items-center justify-center backdrop-blur-sm">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 m-4">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-slate-800" id="modalTitle">Thêm người dùng</h2>
            <button onclick="window.closeUserModal()" class="text-slate-400 hover:text-slate-600 text-xl">&times;</button>
        </div>
        <form id="userForm" class="space-y-4">
            <input type="hidden" name="id_user" id="userId">
            <div><label class="block text-sm font-medium text-slate-700 mb-1">Username</label><input type="text" name="username" id="username" required class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none"></div>
            <div><label class="block text-sm font-medium text-slate-700 mb-1">Mật khẩu</label><input type="password" name="password" id="password" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="Để trống nếu không đổi"></div>
            <div><label class="block text-sm font-medium text-slate-700 mb-1">Họ tên</label><input type="text" name="ho_ten" id="ho_ten" required class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none"></div>
            <div><label class="block text-sm font-medium text-slate-700 mb-1">Email</label><input type="email" name="email" id="email" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none"></div>
            <div><label class="block text-sm font-medium text-slate-700 mb-1">Vai trò</label><select name="vai_tro" id="vai_tro" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none"><option value="Admin">Admin</option><option value="GiangVien">Giảng viên</option><option value="TroGiang">Trợ giảng</option></select></div>
            <div><label class="block text-sm font-medium text-slate-700 mb-1">Trạng thái</label><select name="trang_thai" id="trang_thai" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none"><option value="Hoạt động">Hoạt động</option><option value="Khóa">Khóa</option></select></div>
            <div class="flex justify-end gap-3 mt-6">
                <button type="button" onclick="window.closeUserModal()" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg">Hủy</button>
                <button type="submit" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 shadow-sm">Lưu</button>
            </div>
        </form>
    </div>
</div>

<script>
    window.initializeUserManagement = function() {
        loadUsers();
    }

    if (document.readyState === 'complete' || document.readyState === 'interactive') {
        if(document.getElementById('userTableBody')) window.initializeUserManagement();
    } else {
        document.addEventListener('DOMContentLoaded', () => {
            if(document.getElementById('userTableBody')) window.initializeUserManagement();
        });
    }

    async function loadUsers() {
        const tbody = document.getElementById('userTableBody');
        if(!tbody) return;
        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8"><i class="fas fa-spinner fa-spin"></i></td></tr>';
        
        try {
            const res = await fetch('/api/nguoi-dung');
            const users = await res.json();
            tbody.innerHTML = '';
            users.forEach(u => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-slate-50';
                tr.innerHTML = `<td class="px-6 py-4 font-mono text-slate-500">${u.id_user}</td><td class="px-6 py-4 font-bold text-indigo-700">${u.username}</td><td class="px-6 py-4">${u.ho_ten || '-'}</td><td class="px-6 py-4">${u.email || '-'}</td><td class="px-6 py-4"><span class="px-2 py-1 rounded-full text-xs font-bold bg-blue-100 text-blue-700">${u.vai_tro}</span></td><td class="px-6 py-4"><span class="px-2 py-1 rounded-full text-xs font-bold ${u.trang_thai==='Hoạt động'?'bg-green-100 text-green-700':'bg-red-100 text-red-700'}">${u.trang_thai}</span></td><td class="px-6 py-4 text-right space-x-2"><button onclick='window.editUser(${JSON.stringify(u)})' class="text-blue-600 hover:bg-blue-50 p-2 rounded"><i class="fas fa-edit"></i></button><button onclick="window.deleteUser(${u.id_user})" class="text-red-600 hover:bg-red-50 p-2 rounded"><i class="fas fa-trash"></i></button></td>`;
                tbody.appendChild(tr);
            });
        } catch (e) { tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-red-500">Lỗi tải dữ liệu</td></tr>'; }
    }

    window.openAddUserModal = function() {
        document.getElementById('userForm').reset();
        document.getElementById('userId').value = '';
        document.getElementById('modalTitle').textContent = 'Thêm người dùng';
        document.getElementById('username').readOnly = false;
        const modal = document.getElementById('userModal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }

    window.editUser = function(u) {
        document.getElementById('userId').value = u.id_user;
        document.getElementById('username').value = u.username;
        document.getElementById('username').readOnly = true; 
        document.getElementById('ho_ten').value = u.ho_ten || '';
        document.getElementById('email').value = u.email || '';
        document.getElementById('vai_tro').value = u.vai_tro;
        document.getElementById('trang_thai').value = u.trang_thai;
        document.getElementById('password').value = '';
        document.getElementById('modalTitle').textContent = 'Sửa người dùng';
        const modal = document.getElementById('userModal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }

    window.closeUserModal = function() {
        const modal = document.getElementById('userModal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }

    // Attach listener only once
    const form = document.getElementById('userForm');
    if(form) {
        const newForm = form.cloneNode(true);
        form.parentNode.replaceChild(newForm, form);
        newForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            const id = data.id_user;
            const url = id ? `/api/nguoi-dung/${id}` : '/api/nguoi-dung';
            const method = id ? 'PUT' : 'POST';
            if (!data.password) delete data.password;
            
            try {
                const res = await fetch(url, { method: method, headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
                if (res.ok) { window.closeUserModal(); loadUsers(); alert('Thành công!'); } 
                else { const json = await res.json(); alert(json.error || 'Lỗi'); }
            } catch (err) { alert('Lỗi hệ thống'); }
        });
    }

    window.deleteUser = async function(id) {
        if(!confirm('Chắc chắn xóa?')) return;
        try {
            const res = await fetch(`/api/nguoi-dung/${id}`, { method: 'DELETE' });
            if(res.ok) loadUsers(); else alert('Lỗi');
        } catch(e) { alert('Lỗi'); }
    }
</script>
{% endblock %}