{% extends "header.html" %}

{% block title %}Thống kê - Hệ thống DLA{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <h1 class="text-2xl font-bold text-slate-800 mb-6"><i class="fas fa-chart-pie mr-2 text-indigo-600"></i>Báo cáo Thống kê</h1>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-100">
            <p class="text-slate-500 text-xs font-bold uppercase">Tổng sinh viên</p>
            <h3 class="text-3xl font-bold text-slate-800 mt-2" id="statTotal">0</h3>
        </div>
        <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-100">
            <p class="text-slate-500 text-xs font-bold uppercase">Đã điểm danh (Tháng)</p>
            <h3 class="text-3xl font-bold text-green-600 mt-2" id="statPresent">0</h3>
        </div>
        <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-100">
            <p class="text-slate-500 text-xs font-bold uppercase">Vắng (Tháng)</p>
            <h3 class="text-3xl font-bold text-red-500 mt-2" id="statAbsent">0</h3>
        </div>
        <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-100">
            <p class="text-slate-500 text-xs font-bold uppercase">Tỷ lệ đi học</p>
            <h3 class="text-3xl font-bold text-indigo-600 mt-2" id="statRate">0%</h3>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-100">
            <h3 class="font-bold text-slate-700 mb-4">Xu hướng điểm danh (7 ngày qua)</h3>
            <div class="h-64"><canvas id="trendChart"></canvas></div>
        </div>
        <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-100">
            <h3 class="font-bold text-slate-700 mb-4">Tỷ lệ theo lớp</h3>
            <div class="h-64"><canvas id="classPieChart"></canvas></div>
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
        <div class="p-5 border-b border-slate-100 flex flex-col md:flex-row justify-between items-center gap-4">
            <h3 class="font-bold text-slate-700">Chi tiết theo sinh viên</h3>
            <div class="flex gap-2">
                <select id="monthFilter" class="px-3 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none"></select>
                <button class="px-4 py-2 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700" onclick="window.exportReport()"><i class="fas fa-file-excel mr-2"></i>Xuất Excel</button>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse">
                <thead class="bg-slate-50 text-slate-500 text-xs uppercase font-bold">
                    <tr>
                        <th class="px-6 py-4">Sinh viên</th>
                        <th class="px-6 py-4">Lớp</th>
                        <th class="px-6 py-4 text-center">Số buổi có mặt</th>
                        <th class="px-6 py-4 text-center">Số buổi vắng</th>
                        <th class="px-6 py-4 text-center">Tỷ lệ</th>
                    </tr>
                </thead>
                <tbody id="reportTableBody" class="divide-y divide-slate-100 text-sm text-slate-600"></tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
    var trendChartInstance = null;
    var classChartInstance = null;

    window.initializeAlgorithmsInfo = function() {
        initMonthFilter();
        loadStats();
    }

    if (document.readyState === 'complete' || document.readyState === 'interactive') {
        if(document.getElementById('statTotal')) window.initializeAlgorithmsInfo();
    } else {
        document.addEventListener('DOMContentLoaded', () => {
            if(document.getElementById('statTotal')) window.initializeAlgorithmsInfo();
        });
    }

    function initMonthFilter() {
        const sel = document.getElementById('monthFilter');
        const today = new Date();
        sel.innerHTML = '';
        for (let i = 0; i < 6; i++) {
            const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
            const val = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
            const text = `Tháng ${d.getMonth() + 1}/${d.getFullYear()}`;
            sel.add(new Option(text, val));
        }
        sel.addEventListener('change', loadStats);
    }

    async function loadStats() {
        try {
            const studentsRes = await fetch('/api/sinh-vien');
            const students = await studentsRes.json();
            const historyRes = await fetch('/api/diem-danh');
            const history = await historyRes.json();
            processData(students, history);
        } catch (e) { console.error(e); }
    }

    function processData(students, history) {
        document.getElementById('statTotal').textContent = students.length;
        const monthVal = document.getElementById('monthFilter').value;
        const currentMonthHistory = history.filter(h => h.thoi_gian_vao.startsWith(monthVal));
        const uniquePresent = new Set(currentMonthHistory.map(h => h.ma_sv)).size;
        document.getElementById('statPresent').textContent = uniquePresent;
        document.getElementById('statAbsent').textContent = Math.max(0, students.length - uniquePresent);
        const rate = students.length > 0 ? Math.round((uniquePresent / students.length) * 100) : 0;
        document.getElementById('statRate').textContent = `${rate}%`;
        renderTrendChart(history);
        renderClassChart(students, currentMonthHistory);
        renderTable(students, currentMonthHistory);
    }

    function renderTrendChart(history) {
        const ctx = document.getElementById('trendChart').getContext('2d');
        const labels = [];
        const data = [];
        for (let i = 6; i >= 0; i--) {
            const d = new Date();
            d.setDate(d.getDate() - i);
            const dateStr = d.toISOString().split('T')[0];
            labels.push(d.toLocaleDateString('vi-VN', {day: '2-digit', month: '2-digit'}));
            const count = history.filter(h => h.thoi_gian_vao.startsWith(dateStr)).length;
            data.push(count);
        }
        if (window.trendChartInstance) window.trendChartInstance.destroy();
        window.trendChartInstance = new Chart(ctx, {
            type: 'line',
            data: { labels: labels, datasets: [{ label: 'Số lượt điểm danh', data: data, borderColor: '#4f46e5', backgroundColor: 'rgba(79, 70, 229, 0.1)', fill: true, tension: 0.4 }] },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    function renderClassChart(students, monthHistory) {
        const ctx = document.getElementById('classPieChart').getContext('2d');
        const classes = [...new Set(students.map(s => s.lop))];
        const data = classes.map(c => monthHistory.filter(h => h.lop === c).length);
        if (window.classChartInstance) window.classChartInstance.destroy();
        window.classChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: { labels: classes, datasets: [{ data: data, backgroundColor: ['#4f46e5', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'] }] },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    function renderTable(students, monthHistory) {
        const tbody = document.getElementById('reportTableBody');
        tbody.innerHTML = '';
        students.forEach(s => {
            const presentCount = monthHistory.filter(h => h.ma_sv === s.ma_sv).length;
            const tr = document.createElement('tr');
            tr.innerHTML = `<td class="px-6 py-4 font-medium text-slate-800">${s.ho_ten}<br><span class="text-xs text-slate-400">${s.ma_sv}</span></td><td class="px-6 py-4">${s.lop}</td><td class="px-6 py-4 text-center text-green-600 font-bold">${presentCount}</td><td class="px-6 py-4 text-center text-slate-400">-</td><td class="px-6 py-4 text-center">-</td>`;
            tbody.appendChild(tr);
        });
    }
    
    window.exportReport = function() {
        const wb = XLSX.utils.table_to_book(document.querySelector('table'), {sheet: "BaoCao"});
        XLSX.writeFile(wb, 'BaoCao_ThongKe.xlsx');
    }
</script>
{% endblock %}