{% extends "header.html" %}

{% block title %}ƒêi·ªÉm danh Realtime - H·ªá th·ªëng DLA{% endblock %}

{% block content %}
<div class="container mx-auto h-[calc(100vh-6rem)] flex flex-col lg:flex-row gap-6">
    
    <div class="lg:w-2/3 flex flex-col gap-4 h-full">
        <div class="grid grid-cols-3 gap-4">
            <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-100 flex items-center justify-between">
                <div><p class="text-xs text-slate-500 uppercase font-semibold">Sinh vi√™n</p><p class="text-xl font-bold text-slate-800" id="totalStudents">0</p></div>
                <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600"><i class="fas fa-users"></i></div>
            </div>
             <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-100 flex items-center justify-between">
                <div><p class="text-xs text-slate-500 uppercase font-semibold">Ph√°t hi·ªán</p><p class="text-xl font-bold text-slate-800" id="detectedFaces">0</p></div>
                <div class="w-8 h-8 rounded-full bg-yellow-100 flex items-center justify-center text-yellow-600"><i class="fas fa-eye"></i></div>
            </div>
             <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-100 flex items-center justify-between">
                <div><p class="text-xs text-slate-500 uppercase font-semibold">ƒêi·ªÉm danh</p><p class="text-xl font-bold text-green-600" id="attendanceToday">0</p></div>
                <div class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center text-green-600"><i class="fas fa-check"></i></div>
            </div>
        </div>

        <div class="relative flex-1 bg-black rounded-2xl overflow-hidden shadow-lg border-2 border-slate-800 group">
             <div class="absolute top-4 left-4 z-20 flex gap-2">
                 <div id="camStatus" class="px-3 py-1 rounded-full bg-black bg-opacity-60 text-white text-xs backdrop-blur-md border border-white/20 flex items-center"><i class="fas fa-circle text-red-500 text-[8px] mr-2"></i>Offline</div>
                 <div id="modelStatus" class="px-3 py-1 rounded-full bg-black bg-opacity-60 text-white text-xs backdrop-blur-md border border-white/20"><i class="fas fa-brain mr-2 text-indigo-400"></i>Loading models...</div>
             </div>
             <div class="absolute top-4 right-4 z-20 bg-black bg-opacity-60 text-white px-3 py-1 rounded-full text-xs font-mono backdrop-blur-md border border-white/20"><i class="far fa-clock mr-1"></i> <span id="liveClock">--:--:--</span></div>

             <div class="relative w-full h-full flex items-center justify-center bg-black">
                 <video id="video" autoplay muted playsinline class="absolute inset-0 w-full h-full object-cover transform scale-x-[-1]" style="display:none;"></video>
                 <!-- Removed scale-x-[-1] from canvas so text is readable -->
                 <canvas id="overlay" class="absolute inset-0 w-full h-full pointer-events-none transform scale-x-[-1]"></canvas>
                 <div id="camPlaceholder" class="text-center p-10 z-10">
                     <div class="w-20 h-20 bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-4 animate-pulse"><i class="fas fa-camera text-3xl text-slate-500"></i></div>
                     <h3 class="text-slate-400 font-medium">Camera ƒëang t·∫Øt</h3>
                     <div id="errorMsg" class="text-red-400 text-sm mt-2 hidden"></div>
                     <button onclick="window.startCamera()" class="mt-4 px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors shadow-lg shadow-indigo-500/30"><i class="fas fa-power-off mr-2"></i>B·∫≠t Camera</button>
                 </div>
             </div>
             <div class="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black/80 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex justify-center gap-3 z-30">
                 <button onclick="window.startCamera()" class="p-3 bg-green-600 hover:bg-green-700 text-white rounded-full shadow-lg"><i class="fas fa-play"></i></button>
                 <button onclick="window.stopCamera()" class="p-3 bg-red-600 hover:bg-red-700 text-white rounded-full shadow-lg"><i class="fas fa-stop"></i></button>
             </div>
        </div>
    </div>
    
    <div class="lg:w-1/3 flex flex-col h-full bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
        <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
            <h3 class="font-bold text-slate-700 flex items-center"><i class="fas fa-history text-indigo-500 mr-2"></i>ƒêi·ªÉm danh g·∫ßn ƒë√¢y</h3>
            <button onclick="window.clearSessionList()" class="text-xs text-red-500 hover:text-red-700 hover:underline">X√≥a list</button>
        </div>
        <div id="attendanceFeed" class="flex-1 overflow-y-auto p-4 space-y-3">
            <div id="emptyFeed" class="text-center py-10 text-slate-400"><i class="fas fa-clipboard-list text-4xl mb-3 opacity-20"></i><p class="text-sm">Ch∆∞a c√≥ l∆∞·ª£t ƒëi·ªÉm danh n√†o</p></div>
        </div>
    </div>
</div>

<script>
    // ========== GLOBAL STATE ==========
    window.realtimeState = {
        stream: null,
        detecting: false,
        faceMatcher: null,
        labeledDescriptors: [], 
        studentMap: {},
        sessionAttendance: [],
        todayAttendanceMap: {},
        modelsLoaded: false,
        lastDetectionTime: 0,
        cooldowns: {},
        correctionMap: {}, // Map s·ª≠a l·ªói: { 'User_Wrong': { correctID: 'User_Right', expiry: timestamp } }
        lastAttendedFace: null // { id: '...', name: '...', time: ... }
    };

    var state = window.realtimeState;
    var video, canvas, ctx;

    // ========== CLOCK UPDATE ==========
    function startClock() {
        if (window.clockInterval) clearInterval(window.clockInterval);
        window.clockInterval = setInterval(() => {
            const now = new Date();
            const el = document.getElementById('liveClock');
            if(el) el.textContent = now.toLocaleTimeString('vi-VN');
        }, 1000);
    }

    // ========== INITIALIZE ==========
    window.initializeRealtimeAttendance = async function() {
        console.log("üöÄ Initializing Realtime Attendance System...");
        
        let attempts = 0;
        while (typeof faceapi === 'undefined' && attempts < 50) {
            await new Promise(r => setTimeout(r, 100));
            attempts++;
        }
        
        if (typeof faceapi === 'undefined') {
            document.getElementById('modelStatus').innerHTML = '<i class="fas fa-exclamation-circle mr-2 text-red-500"></i>Lib Missing';
            return;
        }
        
        video = document.getElementById('video');
        canvas = document.getElementById('overlay');
        ctx = canvas.getContext('2d');
        
        startClock();
        loadSessionData();
        await loadModels();
    }

    if (document.readyState === 'complete' || document.readyState === 'interactive') {
        if(document.getElementById('video')) window.initializeRealtimeAttendance();
    } else {
        document.addEventListener('DOMContentLoaded', () => {
            if(document.getElementById('video')) window.initializeRealtimeAttendance();
        });
    }

    // ========== LOAD MODELS ==========
    async function loadModels() {
        try {
            const statusEl = document.getElementById('modelStatus');
            if(statusEl) statusEl.innerHTML = '<i class="fas fa-circle-notch fa-spin mr-2 text-yellow-400"></i>Loading AI...';
            
            const modelPath = '/static/models';
            
            if (!state.modelsLoaded) {
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(modelPath),
                    faceapi.nets.faceLandmark68Net.loadFromUri(modelPath),
                    faceapi.nets.faceRecognitionNet.loadFromUri(modelPath)
                ]);
                state.modelsLoaded = true;
            }
            
            await loadStudents();
            await loadEncodings();
            await loadTodayAttendance();
            
            if(statusEl) statusEl.innerHTML = '<i class="fas fa-check-circle mr-2 text-green-400"></i>AI Ready';
            
        } catch (err) {
            console.error('Model error:', err);
            if(document.getElementById('modelStatus')) {
                document.getElementById('modelStatus').innerHTML = '<i class="fas fa-exclamation-triangle mr-2 text-red-400"></i>Error';
            }
        }
    }

    // ========== DATA LOADING ==========
    async function loadStudents() {
        try {
            const res = await fetch('/api/sinh-vien');
            const students = await res.json();
            document.getElementById('totalStudents').textContent = students.length || 0;
            state.studentMap = {};
            students.forEach(s => state.studentMap[s.ma_sv] = s);
        } catch (e) { console.error(e); }
    }

    async function loadEncodings() {
        try {
            const res = await fetch('/api/encodings');
            const data = await res.json();
            state.labeledDescriptors = []; 
            
            for (const [ma, info] of Object.entries(data.encodings)) {
                if (info.encodings && info.encodings.length > 0) {
                    const descriptors = info.encodings.map(enc => new Float32Array(enc));
                    state.labeledDescriptors.push(new faceapi.LabeledFaceDescriptors(ma, descriptors));
                }
            }
            
            updateFaceMatcher();
            
        } catch (e) { console.error(e); }
    }

    function updateFaceMatcher() {
        if (state.labeledDescriptors.length > 0) {
            state.faceMatcher = new faceapi.FaceMatcher(state.labeledDescriptors, 0.6);
            console.log("‚úÖ FaceMatcher updated with", state.labeledDescriptors.length, "profiles");
        }
    }

    async function loadTodayAttendance() {
        try {
            const res = await fetch('/api/diem-danh/hom-nay');
            const data = await res.json();
            if (data.success && data.attendance) {
                data.attendance.forEach(item => {
                    state.todayAttendanceMap[item.ma_sv] = true;
                });
                document.getElementById('attendanceToday').textContent = data.count;
            }
        } catch (e) { console.error("Error loading today attendance", e); }
    }

    // ========== CAMERA CONTROLS ==========
    window.startCamera = async function() {
        if (state.stream) return;
        
        if (!state.modelsLoaded) {
            document.getElementById('errorMsg').textContent = 'ƒêang t·∫£i m√¥ h√¨nh AI...';
            document.getElementById('errorMsg').classList.remove('hidden');
            return;
        }

        try {
            state.stream = await navigator.mediaDevices.getUserMedia({ 
                video: { width: 640, height: 480 }, 
                audio: false 
            });
            
            video.srcObject = state.stream;
            video.style.display = 'block';
            
            video.onloadedmetadata = () => {
                document.getElementById('camPlaceholder').classList.add('hidden');
                document.getElementById('camStatus').innerHTML = '<i class="fas fa-circle text-green-400 text-[8px] mr-2"></i>Live';
                state.detecting = true;
                detectionLoop();
            };
        } catch (err) {
            document.getElementById('errorMsg').textContent = 'L·ªói camera: ' + err.message;
            document.getElementById('errorMsg').classList.remove('hidden');
        }
    }

    window.stopCamera = function() {
        if (state.stream) { 
            state.stream.getTracks().forEach(t => t.stop()); 
            state.stream = null; 
        }
        state.detecting = false;
        video.style.display = 'none';
        document.getElementById('camPlaceholder').classList.remove('hidden');
        document.getElementById('camStatus').innerHTML = '<i class="fas fa-circle text-red-500 text-[8px] mr-2"></i>Offline';
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    // ========== DETECTION LOOP ==========
    async function detectionLoop() {
        if (!state.detecting || !state.stream) return;
        if (!video || video.paused || video.ended) return requestAnimationFrame(detectionLoop);
        
        const now = performance.now();
        if (now - state.lastDetectionTime < 100) return requestAnimationFrame(detectionLoop);
        state.lastDetectionTime = now;

        try {
            const options = new faceapi.TinyFaceDetectorOptions({ inputSize: 320, scoreThreshold: 0.5 });
            const detections = await faceapi.detectAllFaces(video, options)
                .withFaceLandmarks()
                .withFaceDescriptors();
            
            const countEl = document.getElementById('detectedFaces');
            if(countEl) countEl.textContent = detections.length;
            
            const dims = { width: video.videoWidth, height: video.videoHeight };
            faceapi.matchDimensions(canvas, dims);
            const resized = faceapi.resizeResults(detections, dims);
            
            ctx.clearRect(0, 0, dims.width, dims.height);
            
            for (const det of resized) {
                const box = det.detection.box;
                let label = 'Ch∆∞a x√°c ƒë·ªãnh';
                let color = '#ef4444'; // Red
                let bestMatch = null;
                let matchedID = null;

                // 1. FRONTEND MATCHING
                if (state.faceMatcher) {
                    bestMatch = state.faceMatcher.findBestMatch(det.descriptor);
                }

                // 2. CORRECTION LOGIC (Quan tr·ªçng: S·ª≠a l·ªói hi·ªÉn th·ªã sai t√™n)
                if (bestMatch && bestMatch.label !== 'unknown') {
                    matchedID = bestMatch.label;
                    
                    // Ki·ªÉm tra xem ID n√†y c√≥ ƒëang b·ªã map sang ID kh√°c kh√¥ng?
                    if (state.correctionMap[matchedID]) {
                        const correction = state.correctionMap[matchedID];
                        if (Date.now() < correction.expiry) {
                            matchedID = correction.correctID; // Force s·ª≠a th√†nh ID ƒë√∫ng
                        }
                    }
                }

                // 3. OVERRIDE LOGIC (N·∫øu v·ª´a ƒëi·ªÉm danh xong, ∆∞u ti√™n hi·ªán t√™n ƒë√≥)
                if (state.lastAttendedFace && (Date.now() - state.lastAttendedFace.time < 3000)) {
                    // N·∫øu kh√¥ng match ho·∫∑c match sai, force hi·ªán t√™n v·ª´a ƒëi·ªÉm danh (cho tr·∫£i nghi·ªám m∆∞·ª£t)
                    // Logic ƒë∆°n gi·∫£n: N·∫øu ch·ªâ c√≥ 1 m·∫∑t, g√°n lu√¥n.
                    if (resized.length === 1) {
                        matchedID = state.lastAttendedFace.id;
                    }
                }

                // 4. PROCESS & DISPLAY
                if (matchedID) {
                    const frontendConfidence = bestMatch ? (1 - bestMatch.distance) * 100 : 80;
                    const studentInfo = state.studentMap[matchedID];

                    if (studentInfo) {
                        label = `${studentInfo.ho_ten}`;
                        
                        if (state.todayAttendanceMap[matchedID]) {
                            color = '#22c55e'; // Green
                            label += ' (ƒê√£ ƒëi·ªÉm danh)';
                        } else {
                            color = '#f59e0b'; // Yellow
                            // G·ªçi API v·ªõi bestMatch g·ªëc (ƒë·ªÉ backend check l·∫°i)
                            // N·∫øu matchedID b·ªã override b·ªüi correction, ta v·∫´n g·ª≠i matchedID ƒë√∫ng l√™n
                            await processAttendance(matchedID, studentInfo, det.descriptor, frontendConfidence, bestMatch ? bestMatch.label : null);
                        }
                    }
                }

                // Draw UI
                ctx.strokeStyle = color;
                ctx.lineWidth = 2;
                ctx.strokeRect(box.x, box.y, box.width, box.height);

                ctx.fillStyle = color;
                ctx.fillRect(box.x, box.y - 25, box.width, 25);

                ctx.save();
                ctx.translate(box.x + box.width/2, box.y - 12);
                ctx.scale(-1, 1);
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(label, 0, 4);
                ctx.restore();
            }
            
        } catch (err) { console.error('Detect error', err); }
        
        requestAnimationFrame(detectionLoop);
    }

        // ========== HANDLE ATTENDANCE & DYNAMIC LEARNING ========== 
        async function processAttendance(ma_sv, studentInfo, descriptor, frontendConfidence, originalGuessID) {
            const now = Date.now();
            if (state.cooldowns[ma_sv] && now - state.cooldowns[ma_sv] < 5000) return;
            state.cooldowns[ma_sv] = now;
    
            try {
                // Capture Image for Attendance Evidence
                let captureImage = '';
                try {
                    const cvs = document.createElement('canvas');
                    cvs.width = 300; cvs.height = 300; // Resize for storage efficiency
                    // Crop center square
                    const size = Math.min(video.videoWidth, video.videoHeight);
                    const sx = (video.videoWidth - size) / 2;
                    const sy = (video.videoHeight - size) / 2;
                    cvs.getContext('2d').drawImage(video, sx, sy, size, size, 0, 0, 300, 300);
                    captureImage = cvs.toDataURL('image/jpeg', 0.8);
                } catch(e) { console.error("Capture error", e); }

                const descriptorArr = Array.from(descriptor);
                const response = await fetch('/api/identify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        descriptor: descriptorArr,
                        ma_sv: ma_sv,
                        ho_ten: studentInfo.ho_ten,
                        confidence: frontendConfidence,
                        algorithm: 'ArcFace',
                        image: captureImage // üõ†Ô∏è Send captured image
                    })
                });
    
                const result = await response.json();
    
                if (result.matched || result.success) {
                    const correctID = result.ma_sv;
                    const correctName = result.ho_ten;
    
                    // 1. Lu√¥n c·∫≠p nh·∫≠t matcher ƒë·ªÉ h·ªçc m·∫∑t m·ªõi (Box xanh ·ªïn ƒë·ªãnh h∆°n)
                    updateLocalMatcher(correctID, descriptor);
                    
                    // 2. QUAN TR·ªåNG: Ki·ªÉm tra ƒë√£ ƒëi·ªÉm danh ch∆∞a TR∆Ø·ªöC khi hi·ªán th√¥ng b√°o
                    if (state.todayAttendanceMap[correctID]) {
                        console.log(`‚ÑπÔ∏è ${correctName} ƒë√£ ƒëi·ªÉm danh r·ªìi. B·ªè qua th√¥ng b√°o.`);
                        return; // <--- D·ª™NG L·∫†I, KH√îNG HI·ªÜN TH√îNG B√ÅO/LIST N·ªÆA
                    }
    
                    console.log(`‚úÖ Attendance Success: ${correctName} (${correctID})`);
                    
                    // 3. ƒê√°nh d·∫•u ƒë√£ ƒëi·ªÉm danh
                    state.todayAttendanceMap[correctID] = true;
    
                    // 4. X·ª≠ l√Ω Correction Map (S·ª≠a l·ªói hi·ªÉn th·ªã t√™n sai)
                    if (originalGuessID && originalGuessID !== 'unknown' && originalGuessID !== correctID) {
                        state.correctionMap[originalGuessID] = {
                            correctID: correctID,
                            expiry: Date.now() + 5000 
                        };
                    }
    
                    // 5. Force override visual
                    state.lastAttendedFace = {
                        id: correctID,
                        name: correctName,
                        time: Date.now()
                    };
    
                    // 6. Ch·ªâ hi·ªán th√¥ng b√°o v√† th√™m v√†o list L·∫¶N ƒê·∫¶U TI√äN
                    showSuccessEffect(correctName);
                    updateAttendanceFeed({
                        name: correctName,
                        id: correctID,
                        class: result.lop,
                        time: new Date().toLocaleTimeString('vi-VN'),
                        confidence: result.do_tin_cay ? result.do_tin_cay.toFixed(1) : frontendConfidence.toFixed(1),
                        img: captureImage // Use the same image we sent to server
                    });
                    
                    const todayCountEl = document.getElementById('attendanceToday');
                    if(todayCountEl) {
                        let current = parseInt(todayCountEl.textContent) || 0;
                        todayCountEl.textContent = current + 1;
                    }
                }
    
            } catch (e) {
                console.error("‚ùå Error processing attendance:", e);
            }
        }
    function updateLocalMatcher(ma_sv, newDescriptor) {
        const float32Descriptor = new Float32Array(newDescriptor);
        const existing = state.labeledDescriptors.find(ld => ld.label === ma_sv);
        
        if (existing) {
            existing.descriptors.push(float32Descriptor);
        } else {
            // N·∫øu ch∆∞a c√≥, t·∫°o m·ªõi! (Fix l·ªói c≈©)
            const newProfile = new faceapi.LabeledFaceDescriptors(ma_sv, [float32Descriptor]);
            state.labeledDescriptors.push(newProfile);
        }
        
        // Rebuild matcher
        updateFaceMatcher();
    }

    // ========== UI HELPERS ==========
    function updateAttendanceFeed(item) {
        // Image is now passed in item.img from processAttendance
        if (!item.img) {
             try {
                const cvs = document.createElement('canvas');
                cvs.width = 100; cvs.height = 100;
                const size = Math.min(video.videoWidth, video.videoHeight);
                const sx = (video.videoWidth - size) / 2;
                const sy = (video.videoHeight - size) / 2;
                cvs.getContext('2d').drawImage(video, sx, sy, size, size, 0, 0, 100, 100);
                item.img = cvs.toDataURL('image/jpeg');
            } catch(e) { item.img = ''; }
        }

        state.sessionAttendance.unshift(item);
        saveSessionData();
        addFeedItemDOM(item);
    }

    function addFeedItemDOM(item) {
        const feed = document.getElementById('attendanceFeed');
        // FIX: Check if feed exists
        if (!feed) return;

        const emptyMsg = document.getElementById('emptyFeed');
        if(emptyMsg) emptyMsg.classList.add('hidden');

        const div = document.createElement('div');
        div.className = 'flex items-center gap-3 p-3 bg-green-50 rounded-xl border border-green-100 animate-in slide-in-from-right duration-300';
        div.innerHTML = `
            <img src="${item.img || ''}" class="w-12 h-12 rounded-lg object-cover bg-slate-200 border border-slate-200">
            <div class="flex-1 min-w-0">
                <p class="text-sm font-bold text-slate-800 truncate">${item.name}</p>
                <p class="text-xs text-slate-500">${item.id} ‚Ä¢ ${item.class}</p>
            </div>
            <div class="text-right">
                <span class="text-xs font-mono text-indigo-600 font-bold block">${item.time}</span>
                <span class="text-[10px] text-green-600 bg-green-100 px-1.5 py-0.5 rounded-full">${item.confidence}%</span>
            </div>
        `;
        feed.insertBefore(div, feed.firstChild);
        if (feed.children.length > 50) feed.removeChild(feed.lastChild);
    }

    function showSuccessEffect(name) {
        const notif = document.createElement('div');
        notif.className = 'fixed top-24 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-6 py-3 rounded-full shadow-2xl z-50 flex items-center gap-3 animate-bounce-in';
        notif.style.animation = 'slideDown 0.5s ease-out';
        notif.innerHTML = `<i class="fas fa-check-circle text-xl"></i> <div><p class="font-bold text-sm">ƒêi·ªÉm danh th√†nh c√¥ng!</p><p class="text-xs">${name}</p></div>`;
        document.body.appendChild(notif);
        setTimeout(() => {
            notif.style.opacity = '0';
            setTimeout(() => notif.remove(), 500);
        }, 3000);
    }

    // ========== SESSION HELPERS ==========
    function saveSessionData() { 
        try { sessionStorage.setItem('liveSession', JSON.stringify(state.sessionAttendance)); } catch(e) {}
    }
    
    function loadSessionData() {
        const data = sessionStorage.getItem('liveSession');
        if (data) {
            try {
                const parsed = JSON.parse(data);
                state.sessionAttendance = [];
                parsed.reverse().forEach(item => {
                    state.sessionAttendance.unshift(item);
                    addFeedItemDOM(item);
                });
            } catch (e) {}
        }
    }
    
    window.clearSessionList = function() {
        state.sessionAttendance = [];
        state.todayAttendanceMap = {}; 
        sessionStorage.removeItem('liveSession');
        
        const feed = document.getElementById('attendanceFeed');
        if (feed) {
            feed.innerHTML = '<div id="emptyFeed" class="text-center py-10 text-slate-400"><i class="fas fa-clipboard-list text-4xl mb-3 opacity-20"></i><p class="text-sm">Ch∆∞a c√≥ l∆∞·ª£t ƒëi·ªÉm danh n√†o</p></div>';
        }
        
        const todayCountEl = document.getElementById('attendanceToday');
        if (todayCountEl) {
            todayCountEl.textContent = 0;
        }
    }

    // CSS Animation for notification (FIX: Use IIFE and check existence)
    (function() {
        if (document.getElementById('realtime-style-unique')) return;
        const s = document.createElement('style');
        s.id = 'realtime-style-unique';
        s.innerHTML = `
            @keyframes slideDown {
                from { transform: translate(-50%, -20px); opacity: 0; }
                to { transform: translate(-50%, 0); opacity: 1; }
            }
        `;
        document.head.appendChild(s);
    })();

</script>
{% endblock %}