{% extends "header.html" %}

{% block title %}H·ªá th·ªëng ƒëi·ªÉm danh khu√¥n m·∫∑t sinh vi√™n DLA{% endblock %}

{% block content %}
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng ƒêi·ªÉm Danh Sinh Vi√™n - Nh·∫≠n Di·ªán Khu√¥n M·∫∑t ƒêa Thu·∫≠t To√°n</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary: #4e73df;
            --secondary: #1cc88a;
            --danger: #e74a3b;
            --warning: #f6c23e;
            --dark: #2c3e50;
            --light: #f8f9fc;
            --gray: #858796;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: var(--dark);
            min-height: 100vh;
        }

        header {
            background: linear-gradient(to right, var(--primary), #6f42c1);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        header h1 {
            font-size: 28px;
            margin-bottom: 8px;
            font-weight: 700;
        }

        header p {
            opacity: 0.9;
            font-size: 16px;
        }

        .header-status {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            margin-top: 10px;
            display: inline-block;
        }

        .container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
            padding: 24px;
            margin-bottom: 30px;
            transition: transform 0.3s, box-shadow 0.3s;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
        }

        .title-section {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--light);
        }

        .title-section i {
            color: var(--primary);
        }

        /* C·∫¢I THI·ªÜN KHUNG CAMERA V·ªöI G√ìC NH√åN R·ªòNG H∆†N */
        #video-wrap, #captureVideoWrap {
            position: relative;
            width: 100%;
            height: 500px;
            border-radius: 12px;
            background: #000;
            overflow: hidden;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            margin-bottom: 20px;
        }

        /* S·ª¨A L·ªñI CAMERA MODAL */
        #captureVideoWrap {
            position: relative;
            width: 100%;
            height: 400px;
            border-radius: 12px;
            background: #000;
            overflow: hidden;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            margin-bottom: 15px;
        }

        /* T·ªëi ∆∞u h√≥a hi·ªÉn th·ªã video v·ªõi g√≥c nh√¨n r·ªông */
        video, canvas {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* ƒê·∫£m b·∫£o video v√† canvas hi·ªÉn th·ªã ƒë√∫ng */
        #captureVideo, #captureCanvas {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover;
            top: 0;
            left: 0;
        }

        #captureVideo {
            transform: scaleX(-1);
        }

        #captureCanvas {
            pointer-events: none;
            z-index: 10;
        }

        /* C·∫•u h√¨nh camera cho g√≥c nh√¨n r·ªông h∆°n */
        .camera-wide-view {
            object-fit: cover;
            transform: scaleX(-1);
            width: 100%;
            height: 100%;
        }

        /* Responsive cho m√†n h√¨nh l·ªõn */
        @media (min-width: 1200px) {
            #video-wrap, #captureVideoWrap {
                height: 550px;
            }
        }

        /* T·ªëi ∆∞u cho m√†n h√¨nh nh·ªè */
        @media (max-width: 768px) {
            #video-wrap, #captureVideoWrap {
                height: 400px;
            }
        }

        /* Hi·ªáu ·ª©ng loading cho camera */
        .camera-loading-wide {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 16px;
            gap: 15px;
        }

        .camera-loading-wide i {
            font-size: 48px;
            opacity: 0.8;
        }

        .camera-loading-wide .loading-text {
            text-align: center;
            line-height: 1.4;
        }

        /* HI·ªÇN TH·ªä NG√ÄY GI·ªú */
        .datetime-display {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            z-index: 50;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .face-info-box {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 100;
            max-width: 250px;
            backdrop-filter: blur(10px);
            border: 2px solid var(--secondary);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .face-info-box .name {
            font-weight: bold;
            font-size: 16px;
            color: var(--secondary);
            margin-bottom: 5px;
        }

        .face-info-box .details {
            font-size: 12px;
            opacity: 0.9;
            line-height: 1.4;
        }

        .face-info-box .confidence {
            font-size: 11px;
            color: var(--warning);
            margin-top: 3px;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
            margin-top: 20px;
        }

        .btn {
            padding: 14px 24px;
            border-radius: 50px;
            cursor: pointer;
            border: none;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        }

        .btn:active {
            transform: translateY(1px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-success {
            background: var(--secondary);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-info {
            background: #36b9cc;
            color: white;
        }

        .btn-secondary {
            background: var(--gray);
            color: white;
        }

        #status {
            margin-top: 20px;
            font-size: 18px;
            text-align: center;
            font-weight: 600;
            padding: 12px;
            border-radius: 10px;
            background: rgba(28, 200, 138, 0.1);
            color: var(--secondary);
            transition: all 0.3s;
        }

        #previewContainer {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 15px;
        }

        .face-preview {
            width: 140px;
            height: 140px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            position: relative;
            transition: transform 0.3s;
        }

        .face-preview:hover {
            transform: scale(1.05);
        }

        .face-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .face-label {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 6px;
            font-size: 12px;
            text-align: center;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            text-align: center;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.2);
            animation: modalAppear 0.4s ease-out;
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes modalAppear {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal h3 {
            font-size: 24px;
            margin-bottom: 20px;
            color: var(--dark);
        }

        .modal img {
            width: 180px;
            height: 180px;
            border-radius: 12px;
            object-fit: cover;
            margin-bottom: 20px;
            border: 3px solid var(--secondary);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        }

        .modal input, .modal select {
            width: 100%;
            padding: 14px;
            margin-bottom: 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: border 0.3s;
        }

        .modal input:focus, .modal select:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(78, 115, 223, 0.2);
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .modal-buttons .btn {
            display: inline-flex !important;
            align-items: center;
            justify-content: center;
            min-width: 120px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card i {
            font-size: 36px;
            margin-bottom: 12px;
            color: var(--primary);
        }

        .stat-card .number {
            font-size: 32px;
            font-weight: 700;
            color: var(--dark);
        }

        .stat-card .label {
            font-size: 14px;
            color: var(--gray);
            margin-top: 5px;
        }

        footer {
            text-align: center;
            padding: 20px;
            margin-top: 40px;
            color: var(--gray);
            font-size: 14px;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .student-list {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .student-item {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s;
        }

        .student-item:hover {
            background: #f8f9fa;
        }

        .student-item:last-child {
            border-bottom: none;
        }

        .student-info {
            flex: 1;
        }

        .student-name {
            font-weight: 600;
            color: var(--dark);
            font-size: 16px;
        }

        .student-details {
            color: var(--gray);
            font-size: 14px;
            margin-top: 4px;
        }

        .student-actions {
            display: flex;
            gap: 8px;
        }

        .btn-sm {
            padding: 8px 12px;
            font-size: 12px;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            font-weight: 600;
        }

        .tab.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .attendance-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .attendance-item {
            padding: 12px;
            border-left: 4px solid var(--secondary);
            background: #f8f9fa;
            margin-bottom: 10px;
            border-radius: 8px;
        }

        .attendance-item.absent {
            border-left-color: var(--danger);
            background: #fdf2f2;
        }

        .attendance-item.late {
            border-left-color: var(--warning);
            background: #fef9e7;
        }

        .model-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 14px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .status-ready {
            background: var(--secondary);
        }

        .status-loading {
            background: var(--warning);
        }

        .status-error {
            background: var(--danger);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: var(--secondary);
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            font-weight: 600;
            transition: all 0.3s;
        }

        .notification.error {
            background: var(--danger);
        }

        .capture-section {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 2px dashed #ddd;
        }

        .capture-preview {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .captured-face {
            width: 120px;
            height: 120px;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .captured-face img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .remove-face {
            position: absolute;
            top: 5px;
            right: 5px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            gap: 10px;
        }

        .step {
            padding: 8px 16px;
            background: #e9ecef;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            color: var(--gray);
        }

        .step.active {
            background: var(--primary);
            color: white;
        }

        .capture-guide {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
        }

        .capture-guide h4 {
            margin-bottom: 8px;
            font-size: 16px;
        }

        .capture-guide p {
            font-size: 14px;
            opacity: 0.9;
        }

        /* C·∫£i thi·ªán hi·ªÉn th·ªã tr·∫°ng th√°i */
        #captureStatus {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--secondary);
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            z-index: 20;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .debug-info {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 12px;
            border-left: 4px solid var(--warning);
        }

        /* SIDEBAR DANH S√ÅCH ƒêI·ªÇM DANH */
        .attendance-sidebar {
            position: fixed;
            right: 20px;
            top: 150px;
            width: 320px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            max-height: 500px;
            overflow-y: auto;
            display: none;
        }

        .attendance-sidebar.active {
            display: block;
            animation: slideInRight 0.3s ease-out;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .attendance-header {
            background: linear-gradient(to right, var(--primary), #6f42c1);
            color: white;
            padding: 15px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .attendance-header h3 {
            font-size: 16px;
            margin: 0;
        }

        .close-sidebar {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }

        .close-sidebar:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .attendance-list-sidebar {
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
        }

        .attendance-item-sidebar {
            padding: 12px;
            border-left: 4px solid var(--secondary);
            background: #f8f9fa;
            margin-bottom: 10px;
            border-radius: 8px;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .attendance-item-sidebar .student-name {
            font-weight: 600;
            color: var(--dark);
            font-size: 14px;
        }

        .attendance-item-sidebar .student-info {
            font-size: 12px;
            color: var(--gray);
            margin: 4px 0;
        }

        .attendance-item-sidebar .attendance-time {
            font-size: 11px;
            color: var(--primary);
            font-weight: 600;
        }

        /* M√ÄU S·∫ÆC CHO ƒê·ªò TIN C·∫¨Y */
        .confidence-low {
            color: var(--danger) !important;
        }

        .confidence-medium {
            color: var(--warning) !important;
        }

        .confidence-high {
            color: var(--secondary) !important;
        }

        /* HI·ªÇN TH·ªä VECTOR KHU√îN M·∫∂T */
        .face-vector-display {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 8px;
            font-size: 11px;
            max-width: 300px;
            max-height: 150px;
            overflow-y: auto;
            z-index: 90;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .face-vector-display h4 {
            margin-bottom: 5px;
            font-size: 12px;
            color: var(--warning);
        }

        .vector-data {
            font-family: 'Courier New', monospace;
            font-size: 10px;
            line-height: 1.2;
            word-break: break-all;
        }

        .vector-toggle {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 5px 10px;
            font-size: 11px;
            cursor: pointer;
            z-index: 100;
        }

        /* Animation cho loading */
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .camera-pulse {
            animation: pulse 1.5s ease-in-out infinite;
        }

        /* C·∫£i thi·ªán controls trong modal */
        .capture-section .controls {
            margin: 15px 0;
        }

        .camera-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: white;
            font-size: 16px;
        }

        .camera-loading .loading {
            margin-right: 10px;
        }

        /* Hi·ªáu ·ª©ng ƒëi·ªÉm danh th√†nh c√¥ng */
        @keyframes pulseSuccess {
            0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        @keyframes flashGreen {
            0% { background-color: rgba(28, 200, 138, 0.3); }
            100% { background-color: transparent; }
        }

        .attendance-success-flash {
            animation: flashGreen 0.5s ease-in-out;
        }

        /* Badge ƒë√£ ƒëi·ªÉm danh */
        .attended-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #36b9cc;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: bold;
            z-index: 20;
            animation: fadeIn 0.5s ease-out;
        }

        /* THU·∫¨T TO√ÅN STYLES */
        .algorithm-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid var(--primary);
            margin-bottom: 15px;
        }

        .algorithm-info h4 {
            color: var(--dark);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .algorithm-info p {
            margin: 5px 0;
            font-size: 14px;
        }

        .algorithm-comparison {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .algorithm-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .algorithm-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .algorithm-card.euclidean {
            border-color: #4e73df;
        }

        .algorithm-card.arcface {
            border-color: #1cc88a;
        }

        .algorithm-card.deep-learning {
            border-color: #6f42c1;
        }

        .algorithm-card.mtcnn {
            border-color: #f6c23e;
        }

        .algorithm-card.lbph {
            border-color: #36b9cc;
        }

        .algorithm-card.ensemble {
            border-color: #e74a3b;
        }

        .algorithm-emoji {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .algorithm-stats {
            font-size: 12px;
            color: var(--gray);
            margin-top: 5px;
        }

        /* PH∆Ø∆†NG PH√ÅP PH√ÅT HI·ªÜN */
        .detection-methods {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .detection-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .detection-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .detection-card.opencv {
            border-color: #4e73df;
        }

        .detection-card.dlib {
            border-color: #1cc88a;
        }

        .detection-card.mtcnn {
            border-color: #6f42c1;
        }

        .detection-emoji {
            font-size: 28px;
            margin-bottom: 8px;
        }

        /* Advanced System Styles */
        .advanced-system-status {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
        }

        .system-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .system-stat {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .system-stat .number {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .system-stat .label {
            font-size: 12px;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <header>
        <h1><i class="fas fa-user-graduate"></i> H·ªÜ TH·ªêNG ƒêI·ªÇM DANH Sinh Vi√™n N√ÇNG CAO</h1>
        <p>Nh·∫≠n di·ªán khu√¥n m·∫∑t ƒëa thu·∫≠t to√°n - Ph√°t hi·ªán ƒëa ph∆∞∆°ng ph√°p - Qu·∫£n l√Ω ƒëi·ªÉm danh th√¥ng minh</p>
        <div class="header-status" id="headerStatus">
            <i class="fas fa-sync-alt loading"></i> ƒêang kh·ªüi ƒë·ªông h·ªá th·ªëng ƒëa thu·∫≠t to√°n n√¢ng cao...
        </div>
    </header>

    <div class="container">
        <div class="stats">
            <div class="stat-card">
                <i class="fas fa-users"></i>
                <div class="number" id="totalStudents">0</div>
                <div class="label">Sinh vi√™n ƒë√£ ƒëƒÉng k√Ω</div>
            </div>
            <div class="stat-card">
                <i class="fas fa-user-clock"></i>
                <div class="number" id="detectedFaces">0</div>
                <div class="label">Khu√¥n m·∫∑t ph√°t hi·ªán</div>
            </div>
            <div class="stat-card">
                <i class="fas fa-check-circle"></i>
                <div class="number" id="recognizedFaces">0</div>
                <div class="label">Khu√¥n m·∫∑t nh·∫≠n di·ªán</div>
            </div>
            <div class="stat-card">
                <i class="fas fa-chart-line"></i>
                <div class="number" id="attendanceToday">0</div>
                <div class="label">ƒêi·ªÉm danh h√¥m nay</div>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" data-tab="recognition">Nh·∫≠n Di·ªán</div>
            <div class="tab" data-tab="students">Qu·∫£n L√Ω Sinh Vi√™n</div>
            <div class="tab" data-tab="attendance">L·ªãch S·ª≠ ƒêi·ªÉm Danh</div>
            <div class="tab" data-tab="algorithms">Thu·∫≠t To√°n</div>
            <div class="tab" data-tab="advanced">H·ªá Th·ªëng N√¢ng Cao</div>
            <div class="tab" data-tab="debug">Debug</div>
        </div>

        <!-- TAB NH·∫¨N DI·ªÜN -->
        <div class="tab-content active" id="recognition-tab">
            <div class="card">
                <div class="title-section">
                    <i class="fas fa-camera"></i> Camera Nh·∫≠n Di·ªán & ƒêi·ªÉm Danh N√¢ng Cao
                </div>
                
                <!-- Model Status -->
                <div class="model-status">
                    <div class="status-dot" id="faceapiStatus"></div>
                    <span>Face Recognition: <span id="faceapiText">ƒêang t·∫£i...</span></span>
                </div>

                <div id="video-wrap">
                    <!-- HI·ªÇN TH·ªä NG√ÄY GI·ªú TH·ªúI GIAN TH·ª∞C -->
                    <div class="datetime-display" id="currentDatetime">
                        <i class="fas fa-clock"></i> 
                        <span id="dateTimeText">ƒêang t·∫£i...</span>
                    </div>
                    
                    <!-- N√öT TOGGLE HI·ªÇN TH·ªä VECTOR -->
                    <button class="vector-toggle" id="toggleVector">
                        <i class="fas fa-code"></i> Vector
                    </button>
                    
                    <video id="video" autoplay muted playsinline></video>
                    <canvas id="overlay"></canvas>
                    
                    <!-- HI·ªÇN TH·ªä VECTOR KHU√îN M·∫∂T -->
                    <div class="face-vector-display" id="faceVectorDisplay" style="display: none;">
                        <h4><i class="fas fa-dna"></i> Face Vector</h4>
                        <div class="vector-data" id="vectorData">Ch∆∞a c√≥ d·ªØ li·ªáu vector...</div>
                    </div>
                </div>

                <div id="status">‚è≥ ƒêang t·∫£i m√¥ h√¨nh nh·∫≠n di·ªán n√¢ng cao...</div>
                <div class="controls">
                    <button class="btn btn-primary" id="startCam">
                        <i class="fas fa-play-circle"></i> B·∫≠t Camera
                    </button>
                    <button class="btn btn-danger" id="stopCam">
                        <i class="fas fa-stop-circle"></i> T·∫Øt Camera
                    </button>
                    <button class="btn btn-success" id="addStudentBtn">
                        <i class="fas fa-user-plus"></i> Th√™m Sinh Vi√™n
                    </button>
                    <button class="btn btn-warning" id="refreshData">
                        <i class="fas fa-sync-alt"></i> L√†m M·ªõi D·ªØ Li·ªáu
                    </button>
                    <button class="btn btn-info" id="syncEncodings">
                        <i class="fas fa-sync"></i> ƒê·ªìng B·ªô Encodings
                    </button>
                    <!-- N√öT HI·ªÇN TH·ªä DANH S√ÅCH ƒêI·ªÇM DANH -->
                    <button class="btn btn-secondary" id="toggleAttendanceSidebar">
                        <i class="fas fa-list-check"></i> Danh S√°ch ƒêi·ªÉm Danh
                    </button>
                    <!-- N√öT SO S√ÅNH THU·∫¨T TO√ÅN -->
                    <button class="btn btn-info" id="compareAlgorithms">
                        <i class="fas fa-chart-bar"></i> So S√°nh Thu·∫≠t To√°n
                    </button>
                    <!-- N√öT KI·ªÇM TRA H·ªÜ TH·ªêNG N√ÇNG CAO -->
                    <button class="btn btn-warning" id="testAdvancedSystem">
                        <i class="fas fa-vial"></i> Ki·ªÉm Tra H·ªá Th·ªëng N√¢ng Cao
                    </button>
                </div>
            </div>

            <div class="card">
                <div class="title-section">
                    <i class="fas fa-id-card"></i> Khu√¥n M·∫∑t Ph√°t Hi·ªán
                </div>
                <div id="previewContainer">
                    <!-- C√°c khu√¥n m·∫∑t s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y -->
                </div>
            </div>
        </div>

        <!-- TAB QU·∫¢N L√ù SINH VI√äN -->
        <div class="tab-content" id="students-tab">
            <div class="card">
                <div class="title-section">
                    <i class="fas fa-user-graduate"></i> Danh S√°ch Sinh Vi√™n
                </div>
                <div class="controls">
                    <button class="btn btn-success" id="addNewStudent">
                        <i class="fas fa-plus"></i> Th√™m Sinh Vi√™n M·ªõi
                    </button>
                    <button class="btn btn-info" id="checkEncodingsBtn">
                        <i class="fas fa-database"></i> Ki·ªÉm Tra Encodings
                    </button>
                </div>
                <div class="student-list" id="studentList">
                    <div class="loading">ƒêang t·∫£i danh s√°ch sinh vi√™n...</div>
                </div>
            </div>
        </div>

        <!-- TAB L·ªäCH S·ª¨ ƒêI·ªÇM DANH -->
        <div class="tab-content" id="attendance-tab">
            <div class="card">
                <div class="title-section">
                    <i class="fas fa-history"></i> L·ªãch S·ª≠ ƒêi·ªÉm Danh
                </div>
                <div class="attendance-list" id="attendanceList">
                    <div class="loading">ƒêang t·∫£i l·ªãch s·ª≠ ƒëi·ªÉm danh...</div>
                </div>
            </div>
        </div>

        <!-- TAB THU·∫¨T TO√ÅN -->
        <div class="tab-content" id="algorithms-tab">
            <div class="card">
                <div class="title-section">
                    <i class="fas fa-brain"></i> H·ªá Th·ªëng ƒêa Thu·∫≠t To√°n Nh·∫≠n Di·ªán
                </div>
                
                <div class="algorithm-comparison">
                    <div class="algorithm-card arcface">
                        <div class="algorithm-emoji">üåü</div>
                        <h4>ArcFace</h4>
                        <div class="algorithm-stats" id="arcfaceStats">0/0 (0%)</div>
                        <p><strong>Lo·∫°i:</strong> Deep Learning</p>
                        <p><strong>ƒê·ªô ch√≠nh x√°c:</strong> 99.4%+</p>
                        <p><strong>T·ªëc ƒë·ªô:</strong> Trung b√¨nh</p>
                    </div>
                    <div class="algorithm-card deep-learning">
                        <div class="algorithm-emoji">üß†</div>
                        <h4>Deep Learning</h4>
                        <div class="algorithm-stats" id="deepLearningStats">0/0 (0%)</div>
                        <p><strong>Lo·∫°i:</strong> Deep Learning</p>
                        <p><strong>ƒê·ªô ch√≠nh x√°c:</strong> 99.2%+</p>
                        <p><strong>T·ªëc ƒë·ªô:</strong> Trung b√¨nh</p>
                    </div>
                    <div class="algorithm-card mtcnn">
                        <div class="algorithm-emoji">üîç</div>
                        <h4>MTCNN</h4>
                        <div class="algorithm-stats" id="mtcnnStats">0/0 (0%)</div>
                        <p><strong>Lo·∫°i:</strong> Deep Learning</p>
                        <p><strong>ƒê·ªô ch√≠nh x√°c:</strong> 99.3%+</p>
                        <p><strong>T·ªëc ƒë·ªô:</strong> Ch·∫≠m</p>
                    </div>
                    <div class="algorithm-card euclidean">
                        <div class="algorithm-emoji">üìê</div>
                        <h4>Euclidean</h4>
                        <div class="algorithm-stats" id="euclideanStats">0/0 (0%)</div>
                        <p><strong>Lo·∫°i:</strong> Traditional</p>
                        <p><strong>ƒê·ªô ch√≠nh x√°c:</strong> 85-90%</p>
                        <p><strong>T·ªëc ƒë·ªô:</strong> R·∫•t nhanh</p>
                    </div>
                    <div class="algorithm-card lbph">
                        <div class="algorithm-emoji">üéØ</div>
                        <h4>LBPH</h4>
                        <div class="algorithm-stats" id="lbphStats">0/0 (0%)</div>
                        <p><strong>Lo·∫°i:</strong> Traditional</p>
                        <p><strong>ƒê·ªô ch√≠nh x√°c:</strong> 70-80%</p>
                        <p><strong>T·ªëc ƒë·ªô:</strong> R·∫•t nhanh</p>
                    </div>
                </div>

                <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin: 20px 0;">
                    <h4>üìä Th√¥ng Tin Chi Ti·∫øt C√°c Thu·∫≠t To√°n</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 15px;">
                        <div class="algorithm-info">
                            <h4><i class="fas fa-network-wired"></i> ArcFace</h4>
                            <p><strong>Nguy√™n l√Ω:</strong> Additive Angular Margin Loss cho face recognition</p>
                            <p><strong>∆Øu ƒëi·ªÉm:</strong> ƒê·ªô ch√≠nh x√°c r·∫•t cao, ·ªïn ƒë·ªãnh v·ªõi nhi·ªÅu ƒëi·ªÅu ki·ªán</p>
                            <p><strong>Nh∆∞·ª£c ƒëi·ªÉm:</strong> Y√™u c·∫ßu nhi·ªÅu t√†i nguy√™n, t·ªëc ƒë·ªô ch·∫≠m h∆°n</p>
                        </div>
                        <div class="algorithm-info">
                            <h4><i class="fas fa-project-diagram"></i> Deep Learning</h4>
                            <p><strong>Nguy√™n l√Ω:</strong> Generic deep learning face recognition</p>
                            <p><strong>∆Øu ƒëi·ªÉm:</strong> ƒê·ªô ch√≠nh x√°c cao, linh ho·∫°t</p>
                            <p><strong>Nh∆∞·ª£c ƒëi·ªÉm:</strong> T·ªën t√†i nguy√™n t√≠nh to√°n</p>
                        </div>
                        <div class="algorithm-info">
                            <h4><i class="fas fa-th"></i> MTCNN</h4>
                            <p><strong>Nguy√™n l√Ω:</strong> Multi-task Cascaded CNN v·ªõi face detection v√† alignment</p>
                            <p><strong>∆Øu ƒëi·ªÉm:</strong> ƒê·ªô ch√≠nh x√°c r·∫•t cao v·ªõi face alignment</p>
                            <p><strong>Nh∆∞·ª£c ƒëi·ªÉm:</strong> T·ªëc ƒë·ªô ch·∫≠m nh·∫•t</p>
                        </div>
                    </div>
                </div>

                <div class="controls">
                    <button class="btn btn-info" id="testAllAlgorithms">
                        <i class="fas fa-vial"></i> Ki·ªÉm Tra T·∫•t C·∫£ Thu·∫≠t To√°n
                    </button>
                    <button class="btn btn-warning" id="resetAlgorithmStats">
                        <i class="fas fa-refresh"></i> ƒê·∫∑t L·∫°i Th·ªëng K√™
                    </button>
                </div>
            </div>
        </div>

        <!-- TAB H·ªÜ TH·ªêNG N√ÇNG CAO -->
        <div class="tab-content" id="advanced-tab">
            <div class="card">
                <div class="title-section">
                    <i class="fas fa-rocket"></i> H·ªá Th·ªëng Nh·∫≠n Di·ªán N√¢ng Cao
                </div>
                
                <div class="advanced-system-status">
                    <h3><i class="fas fa-microchip"></i> Tr·∫°ng Th√°i H·ªá Th·ªëng</h3>
                    <div class="system-stats">
                        <div class="system-stat">
                            <div class="number" id="totalAlgorithms">6</div>
                            <div class="label">Thu·∫≠t To√°n</div>
                        </div>
                        <div class="system-stat">
                            <div class="number" id="totalDetectionMethods">3</div>
                            <div class="label">Ph∆∞∆°ng Ph√°p Ph√°t Hi·ªán</div>
                        </div>
                        <div class="system-stat">
                            <div class="number" id="systemAccuracy">99.5%</div>
                            <div class="label">ƒê·ªô Ch√≠nh X√°c</div>
                        </div>
                        <div class="system-stat">
                            <div class="number" id="processingSpeed">~150ms</div>
                            <div class="label">T·ªëc ƒê·ªô X·ª≠ L√Ω</div>
                        </div>
                    </div>
                </div>

                <div id="advancedModelsStatus">
                    <!-- Th√¥ng tin models s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t ·ªü ƒë√¢y -->
                </div>

                <h3 style="margin: 20px 0 15px 0;"><i class="fas fa-search"></i> Ph∆∞∆°ng Ph√°p Ph√°t Hi·ªán Khu√¥n M·∫∑t</h3>
                <div class="detection-methods">
                    <div class="detection-card opencv">
                        <div class="detection-emoji">‚ö°</div>
                        <h4>OpenCV Haar</h4>
                        <p><strong>T·ªëc ƒë·ªô:</strong> R·∫•t nhanh</p>
                        <p><strong>ƒê·ªô ch√≠nh x√°c:</strong> Trung b√¨nh</p>
                        <p><strong>·ª®ng d·ª•ng:</strong> H·ªá th·ªëng c∆° b·∫£n</p>
                    </div>
                    <div class="detection-card dlib">
                        <div class="detection-emoji">üéØ</div>
                        <h4>Dlib HOG</h4>
                        <p><strong>T·ªëc ƒë·ªô:</strong> Nhanh</p>
                        <p><strong>ƒê·ªô ch√≠nh x√°c:</strong> Cao</p>
                        <p><strong>·ª®ng d·ª•ng:</strong> C√¢n b·∫±ng hi·ªáu nƒÉng</p>
                    </div>
                    <div class="detection-card mtcnn">
                        <div class="detection-emoji">üß†</div>
                        <h4>MTCNN</h4>
                        <p><strong>T·ªëc ƒë·ªô:</strong> Trung b√¨nh</p>
                        <p><strong>ƒê·ªô ch√≠nh x√°c:</strong> R·∫•t cao</p>
                        <p><strong>·ª®ng d·ª•ng:</strong> ƒê·ªô ch√≠nh x√°c cao</p>
                    </div>
                </div>

                <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin: 20px 0;">
                    <h4>üöÄ T√≠nh NƒÉng N√¢ng Cao</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 15px;">
                        <div style="padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <h5><i class="fas fa-vote-yea"></i> H·ªá Th·ªëng B·ªè Phi·∫øu Th√¥ng Minh</h5>
                            <p style="font-size: 14px; margin-top: 8px;">K·∫øt h·ª£p nhi·ªÅu thu·∫≠t to√°n ƒë·ªÉ ch·ªçn k·∫øt qu·∫£ t·ªët nh·∫•t v·ªõi ƒë·ªô tin c·∫≠y cao nh·∫•t</p>
                        </div>
                        <div style="padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <h5><i class="fas fa-filter"></i> Lo·∫°i B·ªè Tr√πng L·∫∑p</h5>
                            <p style="font-size: 14px; margin-top: 8px;">T·ª± ƒë·ªông lo·∫°i b·ªè khu√¥n m·∫∑t tr√πng l·∫∑p d·ª±a tr√™n IoU threshold</p>
                        </div>
                        <div style="padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <h5><i class="fas fa-sliders-h"></i> Ng∆∞·ª°ng Linh Ho·∫°t</h5>
                            <p style="font-size: 14px; margin-top: 8px;">Ng∆∞·ª°ng confidence thay ƒë·ªïi theo t·ª´ng thu·∫≠t to√°n ƒë·ªÉ t·ªëi ∆∞u ƒë·ªô ch√≠nh x√°c</p>
                        </div>
                        <div style="padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <h5><i class="fas fa-bolt"></i> X·ª≠ L√Ω Real-time</h5>
                            <p style="font-size: 14px; margin-top: 8px;">H·ªó tr·ª£ x·ª≠ l√Ω real-time v·ªõi nhi·ªÅu lu·ªìng v√† t·ªëi ∆∞u hi·ªáu nƒÉng</p>
                        </div>
                    </div>
                </div>

                <div class="controls">
                    <button class="btn btn-info" id="testAdvancedRecognition">
                        <i class="fas fa-vial"></i> Ki·ªÉm Tra Nh·∫≠n Di·ªán N√¢ng Cao
                    </button>
                    <button class="btn btn-warning" id="compareDetectionMethods">
                        <i class="fas fa-search"></i> So S√°nh Ph∆∞∆°ng Ph√°p Ph√°t Hi·ªán
                    </button>
                    <button class="btn btn-success" id="runBenchmark">
                        <i class="fas fa-tachometer-alt"></i> Ch·∫°y Benchmark
                    </button>
                </div>
            </div>
        </div>

        <!-- TAB DEBUG -->
        <div class="tab-content" id="debug-tab">
            <div class="card">
                <div class="title-section">
                    <i class="fas fa-bug"></i> Th√¥ng Tin Debug & Ki·ªÉm Tra
                </div>
                <div class="controls">
                    <button class="btn btn-warning" id="debugEncodingsBtn">
                        <i class="fas fa-bug"></i> Debug Encodings
                    </button>
                    <button class="btn btn-info" id="testRecognitionBtn">
                        <i class="fas fa-test"></i> Test Nh·∫≠n Di·ªán
                    </button>
                    <button class="btn btn-danger" id="testDetectionBtn">
                        <i class="fas fa-search"></i> Test Ph√°t Hi·ªán
                    </button>
                    <button class="btn btn-secondary" id="systemInfoBtn">
                        <i class="fas fa-info-circle"></i> Th√¥ng Tin H·ªá Th·ªëng
                    </button>
                </div>
                <div id="debugInfo">
                    <!-- Th√¥ng tin debug s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y -->
                </div>
            </div>
        </div>

        <!-- Modal th√™m sinh vi√™n v·ªõi camera -->
        <div class="modal" id="modalAddStudent">
            <div class="modal-content">
                <h3><i class="fas fa-user-plus"></i> Th√™m Sinh Vi√™n M·ªõi</h3>
                
                <div class="step-indicator">
                    <div class="step active" id="step1">1. Th√¥ng tin</div>
                    <div class="step" id="step2">2. Ch·ª•p ·∫£nh</div>
                </div>

                <!-- Step 1: Th√¥ng tin sinh vi√™n -->
                <div id="step1-content">
                    <input type="text" id="inputMaSV" placeholder="M√£ sinh vi√™n *" required>
                    <input type="text" id="inputHoTen" placeholder="H·ªç v√† t√™n *" required>
                    <input type="text" id="inputLop" placeholder="L·ªõp *" required>
                    
                    <select id="inputGioiTinh">
                        <option value="">Ch·ªçn gi·ªõi t√≠nh</option>
                        <option value="Nam">Nam</option>
                        <option value="N·ªØ">N·ªØ</option>
                        <option value="Kh√°c">Kh√°c</option>
                    </select>
                    
                    <input type="text" id="inputKhoa" placeholder="Khoa">
                    <input type="text" id="inputNganh" placeholder="Ng√†nh h·ªçc">
                    <input type="text" id="inputEmail" placeholder="Email">
                    <input type="text" id="inputPhone" placeholder="S·ªë ƒëi·ªán tho·∫°i">
                </div>

                <!-- Step 2: Ch·ª•p ·∫£nh khu√¥n m·∫∑t -->
                <div id="step2-content" style="display: none;">
                    <div class="capture-guide">
                        <h4><i class="fas fa-lightbulb"></i> H∆∞·ªõng d·∫´n ch·ª•p ·∫£nh</h4>
                        <p>Ch·ª•p √≠t nh·∫•t 3 ·∫£nh t·ª´ c√°c g√≥c ƒë·ªô kh√°c nhau ƒë·ªÉ ƒë·∫£m b·∫£o nh·∫≠n di·ªán ch√≠nh x√°c</p>
                    </div>
                    
                    <div class="capture-section">
                        <div id="captureVideoWrap">
                            <!-- Placeholder m·ªõi v·ªõi th√¥ng tin camera g√≥c r·ªông -->
                            <div id="cameraPlaceholder" class="camera-loading-wide">
                                <i class="fas fa-expand-alt"></i>
                                <div class="loading-text">
                                    <div style="font-weight: bold; margin-bottom: 5px;">Camera G√≥c Nh√¨n R·ªông</div>
                                    <div style="font-size: 14px; opacity: 0.8;">Nh·∫•n "B·∫≠t Camera" ƒë·ªÉ kh·ªüi ƒë·ªông</div>
                                    <div style="font-size: 12px; opacity: 0.6; margin-top: 8px;">
                                        <i class="fas fa-info-circle"></i> H·ªó tr·ª£ ƒë·ªô ph√¢n gi·∫£i l√™n ƒë·∫øn 1280x720
                                    </div>
                                </div>
                            </div>
                            
                            <video id="captureVideo" autoplay muted playsinline style="display: none;"></video>
                            <canvas id="captureCanvas"></canvas>
                            <div class="recognition-badge" id="captureStatus">
                                <i class="fas fa-camera"></i> Ch∆∞a k·∫øt n·ªëi
                            </div>
                        </div>
                        
                        <div class="controls">
                            <button class="btn btn-info" id="startCaptureCam">
                                <i class="fas fa-camera"></i> B·∫≠t Camera
                            </button>
                            <button class="btn btn-success" id="captureFaceBtn">
                                <i class="fas fa-camera"></i> Ch·ª•p ·∫¢nh
                            </button>
                            <button class="btn btn-danger" id="stopCaptureCam">
                                <i class="fas fa-stop"></i> T·∫Øt Camera
                            </button>
                        </div>

                        <div class="capture-preview" id="capturePreview">
                            <!-- ·∫¢nh ƒë√£ ch·ª•p s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y -->
                        </div>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button class="btn btn-secondary" id="prevStepBtn" style="display: none;">
                        <i class="fas fa-arrow-left"></i> Quay l·∫°i
                    </button>
                    <button class="btn btn-primary" id="nextStepBtn">
                        Ti·∫øp theo <i class="fas fa-arrow-right"></i>
                    </button>
                    <button class="btn btn-success" id="saveStudentBtn" style="display: none;">
                        <i class="fas fa-save"></i> Ho√†n Th√†nh & Train
                    </button>
                    <button class="btn btn-danger" id="cancelStudentBtn">
                        <i class="fas fa-times"></i> H·ªßy B·ªè
                    </button>
                </div>
            </div>
        </div>

        <!-- SIDEBAR DANH S√ÅCH ƒêI·ªÇM DANH REAL-TIME -->
        <div class="attendance-sidebar" id="attendanceSidebar">
            <div class="attendance-header">
                <h3><i class="fas fa-list-check"></i> Danh S√°ch ƒêi·ªÉm Danh H√¥m Nay</h3>
                <button class="close-sidebar" id="closeSidebar">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="attendance-list-sidebar" id="attendanceListSidebar">
                <div class="loading">Ch∆∞a c√≥ ƒëi·ªÉm danh n√†o...</div>
            </div>
        </div>
    </div>

    <footer>
        <p>H·ªá Th·ªëng ƒêi·ªÉm Danh Sinh Vi√™n N√¢ng Cao &copy; 2024 - S·ª≠ d·ª•ng ƒêa Thu·∫≠t To√°n Hi·ªán ƒê·∫°i</p>
    </footer>

    <!-- Load face-api.js t·ª´ local -->
    <script src="/static/models/face-api.min.js"></script>

    <script>
        // ========== PH·∫¶N JAVASCRIPT HO√ÄN CH·ªàNH V·ªöI CAMERA G√ìC R·ªòNG ==========

        // Bi·∫øn to√†n c·ª•c
        let stream = null;
        let captureStream = null;
        let detecting = false;
        let capturing = false;
        let faceMatcher = null;
        let latestFaceImgs = [];
        let capturedFaces = [];
        let detectedCount = 0;
        let recognizedCount = 0;
        let currentFaceDescriptor = null;
        let currentFaceImageData = null;
        let studentNameMapping = {};
        let studentInfoMapping = {};
        let currentStudentId = null;
        let currentStep = 1;
        let todayAttendance = [];
        let showVectorDisplay = false;

        // Th·ªëng k√™ thu·∫≠t to√°n n√¢ng cao
        let currentAlgorithm = 'Ensemble';
        let algorithmStats = {
            'ArcFace': { success: 0, total: 0 },
            'DeepLearning': { success: 0, total: 0 },
            'MTCNN': { success: 0, total: 0 },
            'Euclidean': { success: 0, total: 0 },
            'LBPH': { success: 0, total: 0 },
            'Ensemble': { success: 0, total: 0 }
        };

        let detectionStats = {
            'OpenCV_Haar': { count: 0 },
            'Dlib_HOG': { count: 0 },
            'MTCNN': { count: 0 }
        };

        // DOM Elements
        let video, captureVideo, canvas, captureCanvas, ctx, captureCtx;
        let previewContainer, capturePreview, status, modalAddStudent, debugInfo;
        let dateTimeText, attendanceSidebar, attendanceListSidebar;
        let step1Content, step2Content, step1Indicator, step2Indicator;
        let prevStepBtn, nextStepBtn, saveStudentBtn;
        let faceVectorDisplay, vectorData, toggleVector;

        // ========== KH·ªûI T·∫†O H·ªÜ TH·ªêNG ==========
        function initializeDOMElements() {
            // Camera v√† video elements
            video = document.getElementById('video');
            captureVideo = document.getElementById('captureVideo');
            canvas = document.getElementById('overlay');
            captureCanvas = document.getElementById('captureCanvas');
            ctx = canvas.getContext('2d');
            captureCtx = captureCanvas.getContext('2d');
            
            // Container elements
            previewContainer = document.getElementById('previewContainer');
            capturePreview = document.getElementById('capturePreview');
            status = document.getElementById('status');
            modalAddStudent = document.getElementById('modalAddStudent');
            debugInfo = document.getElementById('debugInfo');
            dateTimeText = document.getElementById('dateTimeText');
            attendanceSidebar = document.getElementById('attendanceSidebar');
            attendanceListSidebar = document.getElementById('attendanceListSidebar');
            
            // Step management elements
            step1Content = document.getElementById('step1-content');
            step2Content = document.getElementById('step2-content');
            step1Indicator = document.getElementById('step1');
            step2Indicator = document.getElementById('step2');
            prevStepBtn = document.getElementById('prevStepBtn');
            nextStepBtn = document.getElementById('nextStepBtn');
            saveStudentBtn = document.getElementById('saveStudentBtn');

            // Vector display elements
            faceVectorDisplay = document.getElementById('faceVectorDisplay');
            vectorData = document.getElementById('vectorData');
            toggleVector = document.getElementById('toggleVector');

            console.log('‚úÖ ƒê√£ kh·ªüi t·∫°o t·∫•t c·∫£ DOM elements');
        }

        // ========== C·∫¢I THI·ªÜN CAMERA V·ªöI G√ìC NH√åN R·ªòNG ==========
        async function startWideAngleCamera() {
            try {
                if (stream) stream.getTracks().forEach(track => track.stop());
                
                // C·∫•u h√¨nh camera v·ªõi g√≥c nh√¨n r·ªông h∆°n
                const constraints = {
                    video: { 
                        width: { ideal: 1280 }, // TƒÉng ƒë·ªô ph√¢n gi·∫£i ngang
                        height: { ideal: 720 },
                        aspectRatio: { ideal: 16/9 }, // T·ª∑ l·ªá m√†n h√¨nh r·ªông
                        facingMode: 'user',
                        frameRate: { ideal: 30, max: 60 }
                    }
                };
                
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                
                video.srcObject = stream;
                video.classList.add('camera-wide-view');
                
                video.onloadedmetadata = () => {
                    console.log(`üì∑ Camera ƒë√£ k·∫øt n·ªëi: ${video.videoWidth}x${video.videoHeight}`);
                    
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    
                    // Resize canvas ƒë·ªÉ ph√π h·ª£p v·ªõi face-api.js
                    const displaySize = { 
                        width: video.videoWidth, 
                        height: video.videoHeight 
                    };
                    faceapi.matchDimensions(canvas, displaySize);
                    
                    detecting = true;
                    detectFaces();
                    status.innerText = "üîç ƒêang nh·∫≠n di·ªán khu√¥n m·∫∑t v·ªõi g√≥c nh√¨n r·ªông...";
                };
                
                video.onerror = (e) => {
                    console.error('‚ùå L·ªói video:', e);
                    // Fallback v·ªõi c·∫•u h√¨nh c∆° b·∫£n
                    startBasicCamera();
                };
                
            } catch (e) {
                console.warn('‚ö†Ô∏è Kh√¥ng th·ªÉ s·ª≠ d·ª•ng camera g√≥c r·ªông, ƒëang th·ª≠ c·∫•u h√¨nh c∆° b·∫£n...');
                startBasicCamera();
            }
        }

        // Fallback camera v·ªõi c·∫•u h√¨nh c∆° b·∫£n
        async function startBasicCamera() {
            try {
                const constraints = {
                    video: { 
                        width: { ideal: 640 }, 
                        height: { ideal: 480 },
                        facingMode: 'user'
                    }
                };
                
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                
                video.onloadedmetadata = () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    
                    const displaySize = { 
                        width: video.videoWidth, 
                        height: video.videoHeight 
                    };
                    faceapi.matchDimensions(canvas, displaySize);
                    
                    detecting = true;
                    detectFaces();
                    status.innerText = "üîç ƒêang nh·∫≠n di·ªán khu√¥n m·∫∑t...";
                };
            } catch (e) {
                alert("‚ùå Kh√¥ng th·ªÉ m·ªü camera: " + e.message);
                console.error("L·ªói camera:", e);
            }
        }

        // ========== C·∫¢I THI·ªÜN CAMERA CAPTURE ==========
        async function startWideCaptureCamera() {
            try {
                if (captureStream) {
                    captureStream.getTracks().forEach(track => track.stop());
                }
                
                document.getElementById('captureStatus').innerHTML = '<i class="fas fa-spinner loading"></i> ƒêang k·∫øt n·ªëi camera g√≥c r·ªông...';
                
                const constraints = {
                    video: { 
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        aspectRatio: { ideal: 16/9 },
                        facingMode: 'user',
                        frameRate: { ideal: 30 }
                    },
                    audio: false
                };
                
                captureStream = await navigator.mediaDevices.getUserMedia(constraints);
                captureVideo.srcObject = captureStream;
                captureVideo.classList.add('camera-wide-view');
                
                captureVideo.onloadedmetadata = () => {
                    console.log(`üì∑ Capture camera: ${captureVideo.videoWidth}x${captureVideo.videoHeight}`);
                    
                    const placeholder = document.getElementById('cameraPlaceholder');
                    if (placeholder) {
                        placeholder.style.display = 'none';
                    }
                    captureVideo.style.display = 'block';
                    
                    captureCanvas.width = captureVideo.videoWidth;
                    captureCanvas.height = captureVideo.videoHeight;
                    
                    const displaySize = { 
                        width: captureVideo.videoWidth, 
                        height: captureVideo.videoHeight 
                    };
                    faceapi.matchDimensions(captureCanvas, displaySize);
                    
                    capturing = true;
                    detectFacesForCapture();
                    
                    document.getElementById('captureStatus').innerHTML = '<i class="fas fa-check-circle"></i> Camera g√≥c r·ªông ƒë√£ s·∫µn s√†ng';
                    document.getElementById('captureStatus').style.background = '#1cc88a';
                };
                
            } catch (e) {
                console.warn('‚ö†Ô∏è Kh√¥ng th·ªÉ s·ª≠ d·ª•ng camera g√≥c r·ªông cho capture, ƒëang th·ª≠ c·∫•u h√¨nh c∆° b·∫£n...');
                startBasicCaptureCamera();
            }
        }

        // Fallback cho capture camera
        async function startBasicCaptureCamera() {
            try {
                const constraints = {
                    video: { 
                        width: { ideal: 640 }, 
                        height: { ideal: 480 },
                        facingMode: 'user'
                    },
                    audio: false
                };
                
                captureStream = await navigator.mediaDevices.getUserMedia(constraints);
                captureVideo.srcObject = captureStream;
                
                captureVideo.onloadedmetadata = () => {
                    const placeholder = document.getElementById('cameraPlaceholder');
                    if (placeholder) {
                        placeholder.style.display = 'none';
                    }
                    captureVideo.style.display = 'block';
                    
                    captureCanvas.width = captureVideo.videoWidth;
                    captureCanvas.height = captureVideo.videoHeight;
                    
                    const displaySize = { 
                        width: captureVideo.videoWidth, 
                        height: captureVideo.videoHeight 
                    };
                    faceapi.matchDimensions(captureCanvas, displaySize);
                    
                    capturing = true;
                    detectFacesForCapture();
                    
                    document.getElementById('captureStatus').innerHTML = '<i class="fas fa-check-circle"></i> Camera ƒë√£ s·∫µn s√†ng';
                    document.getElementById('captureStatus').style.background = '#1cc88a';
                };
                
            } catch (e) {
                console.error("‚ùå L·ªói k·∫øt n·ªëi camera capture:", e);
                document.getElementById('captureStatus').innerHTML = '<i class="fas fa-exclamation-circle"></i> L·ªói k·∫øt n·ªëi camera';
                document.getElementById('captureStatus').style.background = '#e74a3b';
                
                let errorMessage = "Kh√¥ng th·ªÉ m·ªü camera: ";
                if (e.name === 'NotAllowedError') {
                    errorMessage += "B·∫°n ƒë√£ t·ª´ ch·ªëi quy·ªÅn truy c·∫≠p camera.";
                } else if (e.name === 'NotFoundError') {
                    errorMessage += "Kh√¥ng t√¨m th·∫•y camera n√†o.";
                } else if (e.name === 'NotSupportedError') {
                    errorMessage += "Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ truy c·∫≠p camera.";
                } else {
                    errorMessage += e.message;
                }
                
                alert(errorMessage);
            }
        }

        function stopCaptureCamera() {
            capturing = false;
            if (captureStream) {
                captureStream.getTracks().forEach(track => track.stop());
                captureStream = null;
            }
            
            // Hi·ªÉn th·ªã placeholder l·∫°i
            const placeholder = document.getElementById('cameraPlaceholder');
            if (placeholder) {
                placeholder.style.display = 'flex';
            }
            if (captureVideo) {
                captureVideo.style.display = 'none';
            }
            
            if (captureCtx) {
                captureCtx.clearRect(0, 0, captureCanvas.width, captureCanvas.height);
            }
            
            document.getElementById('captureStatus').innerHTML = '<i class="fas fa-camera"></i> Ch∆∞a k·∫øt n·ªëi';
            document.getElementById('captureStatus').style.background = '#36b9cc';
        }

        // ========== C·∫¢I THI·ªÜN PLACEHOLDER ==========
        function createEnhancedCameraPlaceholder() {
            const placeholder = document.getElementById('cameraPlaceholder');
            if (placeholder) {
                placeholder.className = 'camera-loading-wide';
                placeholder.innerHTML = `
                    <i class="fas fa-expand-alt"></i>
                    <div class="loading-text">
                        <div style="font-weight: bold; margin-bottom: 5px;">Camera G√≥c Nh√¨n R·ªông</div>
                        <div style="font-size: 14px; opacity: 0.8;">Nh·∫•n "B·∫≠t Camera" ƒë·ªÉ kh·ªüi ƒë·ªông</div>
                        <div style="font-size: 12px; opacity: 0.6; margin-top: 8px;">
                            <i class="fas fa-info-circle"></i> H·ªó tr·ª£ ƒë·ªô ph√¢n gi·∫£i l√™n ƒë·∫øn 1280x720
                        </div>
                    </div>
                `;
            }
        }

        // ========== C·∫¨P NH·∫¨T NG√ÄY GI·ªú TH·ªúI GIAN TH·ª∞C ==========
        function updateDateTime() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                timeZone: 'Asia/Ho_Chi_Minh'
            };
            
            const dateTimeStr = now.toLocaleDateString('vi-VN', options);
            if (dateTimeText) {
                dateTimeText.textContent = dateTimeStr;
            }
        }

        // ========== HI·ªÇN TH·ªä VECTOR KHU√îN M·∫∂T ==========
        function updateFaceVectorDisplay(descriptor, detectionInfo = null) {
            if (!showVectorDisplay || !descriptor) {
                faceVectorDisplay.style.display = 'none';
                return;
            }

            let vectorHTML = '';
            
            if (detectionInfo) {
                vectorHTML += `<div style="margin-bottom: 8px; color: #1cc88a;">`;
                vectorHTML += `<strong>Th√¥ng tin nh·∫≠n di·ªán:</strong><br>`;
                vectorHTML += `T√™n: ${detectionInfo.name || 'Kh√¥ng x√°c ƒë·ªãnh'}<br>`;
                vectorHTML += `ƒê·ªô tin c·∫≠y: ${detectionInfo.confidence ? detectionInfo.confidence.toFixed(1) + '%' : 'N/A'}<br>`;
                vectorHTML += `M√£ SV: ${detectionInfo.ma_sv || 'N/A'}<br>`;
                vectorHTML += `Thu·∫≠t to√°n: ${detectionInfo.algorithm || 'N/A'}<br>`;
                vectorHTML += `Ph√°t hi·ªán: ${detectionInfo.detection_method || 'N/A'}`;
                vectorHTML += `</div>`;
            }

            // Hi·ªÉn th·ªã 10 gi√° tr·ªã ƒë·∫ßu ti√™n c·ªßa vector
            const previewValues = descriptor.slice(0, 10);
            vectorHTML += `<div style="margin-bottom: 5px;"><strong>Vector preview (10/128):</strong></div>`;
            vectorHTML += `<div style="font-size: 9px; line-height: 1.1;">[${previewValues.map(v => v.toFixed(4)).join(', ')}]</div>`;
            
            // Th√¥ng tin t·ªïng quan
            vectorHTML += `<div style="margin-top: 8px; font-size: 9px; color: #f6c23e;">`;
            vectorHTML += `<strong>Th·ªëng k√™:</strong> `;
            vectorHTML += `Min: ${Math.min(...descriptor).toFixed(4)}, `;
            vectorHTML += `Max: ${Math.max(...descriptor).toFixed(4)}, `;
            vectorHTML += `Avg: ${(descriptor.reduce((a, b) => a + b) / descriptor.length).toFixed(4)}`;
            vectorHTML += `</div>`;

            vectorData.innerHTML = vectorHTML;
            faceVectorDisplay.style.display = 'block';
        }

        // ========== QU·∫¢N L√ù DANH S√ÅCH ƒêI·ªÇM DANH REAL-TIME ==========
        function addToAttendanceList(studentInfo, confidence, algorithm, detectionMethod) {
            const now = new Date();
            const timeString = now.toLocaleTimeString('vi-VN', { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            });
            
            const attendanceItem = {
                ma_sv: studentInfo.ma_sv,
                ho_ten: studentInfo.ho_ten,
                lop: studentInfo.lop,
                time: timeString,
                confidence: confidence.toFixed(1),
                algorithm: algorithm,
                detection_method: detectionMethod,
                timestamp: now.getTime()
            };

            // Ki·ªÉm tra tr√πng l·∫∑p (trong v√≤ng 2 ph√∫t)
            const twoMinutesAgo = new Date(now.getTime() - 2 * 60 * 1000);
            const isDuplicate = todayAttendance.some(item => 
                item.ma_sv === studentInfo.ma_sv && 
                item.timestamp > twoMinutesAgo.getTime()
            );

            if (!isDuplicate) {
                todayAttendance.unshift(attendanceItem);
                
                // Gi·ªõi h·∫°n danh s√°ch 20 m·ª•c m·ªõi nh·∫•t
                if (todayAttendance.length > 20) {
                    todayAttendance = todayAttendance.slice(0, 20);
                }

                updateAttendanceSidebar();
                
                // T·ª± ƒë·ªông hi·ªÉn th·ªã sidebar khi c√≥ ƒëi·ªÉm danh m·ªõi
                if (attendanceSidebar && !attendanceSidebar.classList.contains('active')) {
                    attendanceSidebar.classList.add('active');
                }
            }
        }

        function updateAttendanceSidebar() {
            if (!attendanceListSidebar) return;
            
            if (todayAttendance.length === 0) {
                attendanceListSidebar.innerHTML = '<div class="loading">Ch∆∞a c√≥ ƒëi·ªÉm danh n√†o...</div>';
                return;
            }

            let html = '';
            todayAttendance.forEach(item => {
                // X√°c ƒë·ªãnh m√†u s·∫Øc d·ª±a tr√™n ƒë·ªô tin c·∫≠y
                let confidenceClass = 'confidence-high';
                if (item.confidence < 70) {
                    confidenceClass = 'confidence-medium';
                }
                if (item.confidence < 60) {
                    confidenceClass = 'confidence-low';
                }

                let algorithmBadge = '';
                switch(item.algorithm) {
                    case 'ArcFace':
                        algorithmBadge = '<span style="background: #1cc88a; padding: 2px 6px; border-radius: 10px; font-size: 10px; margin-left: 5px;">üåü ArcFace</span>';
                        break;
                    case 'DeepLearning':
                        algorithmBadge = '<span style="background: #6f42c1; padding: 2px 6px; border-radius: 10px; font-size: 10px; margin-left: 5px;">üß† Deep</span>';
                        break;
                    case 'MTCNN':
                        algorithmBadge = '<span style="background: #f6c23e; padding: 2px 6px; border-radius: 10px; font-size: 10px; margin-left: 5px;">üîç MTCNN</span>';
                        break;
                    case 'Euclidean':
                        algorithmBadge = '<span style="background: #4e73df; padding: 2px 6px; border-radius: 10px; font-size: 10px; margin-left: 5px;">üìê Euclidean</span>';
                        break;
                }

                html += `
                    <div class="attendance-item-sidebar">
                        <div class="student-name">${item.ho_ten} ${algorithmBadge}</div>
                        <div class="student-info">${item.ma_sv} - ${item.lop}</div>
                        <div class="student-info" style="font-size: 10px; color: #666;">Ph√°t hi·ªán: ${item.detection_method}</div>
                        <div class="attendance-time">
                            <i class="fas fa-clock"></i> ${item.time} 
                            <span style="margin-left: 8px;" class="${confidenceClass}">
                                ${item.confidence}%
                            </span>
                        </div>
                    </div>
                `;
            });

            attendanceListSidebar.innerHTML = html;
        }

        // ========== LOAD MODELS ==========
        async function loadModels() {
            try {
                status.innerText = "‚è≥ ƒêang t·∫£i m√¥ h√¨nh nh·∫≠n di·ªán n√¢ng cao...";
                
                // Load face-api.js models t·ª´ local
                const modelPath = '/static/models';
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(modelPath),
                    faceapi.nets.faceLandmark68Net.loadFromUri(modelPath),
                    faceapi.nets.faceRecognitionNet.loadFromUri(modelPath),
                    faceapi.nets.faceExpressionNet.loadFromUri(modelPath),
                    faceapi.nets.ageGenderNet.loadFromUri(modelPath)
                ]);
                
                document.getElementById('faceapiStatus').className = 'status-dot status-ready';
                document.getElementById('faceapiText').textContent = 'ƒê√£ s·∫µn s√†ng';
                
                status.innerText = "‚úÖ M√¥ h√¨nh ƒë√£ t·∫£i xong!";
                await loadStudents();
                await loadAttendanceStats();
                await loadEmbeddings();
                
                // C·∫≠p nh·∫≠t header status
                document.getElementById('headerStatus').innerHTML = '<i class="fas fa-check-circle"></i> H·ªá th·ªëng ƒëa thu·∫≠t to√°n n√¢ng cao ƒë√£ s·∫µn s√†ng';
                
                // Kh·ªüi t·∫°o h·ªá th·ªëng n√¢ng cao
                initializeAdvancedSystem();
                
            } catch (e) {
                console.error("L·ªói t·∫£i m√¥ h√¨nh:", e);
                status.innerText = "‚ùå L·ªói khi t·∫£i m√¥ h√¨nh!";
                
                // Th·ª≠ t·∫£i t·ª´ CDN n·∫øu local fail
                try {
                    status.innerText = "üîÑ Th·ª≠ t·∫£i t·ª´ CDN...";
                    await loadModelsFromCDN();
                } catch (cdnError) {
                    console.error("L·ªói t·∫£i t·ª´ CDN:", cdnError);
                    status.innerText = "‚ùå Kh√¥ng th·ªÉ t·∫£i m√¥ h√¨nh nh·∫≠n di·ªán!";
                    document.getElementById('headerStatus').innerHTML = '<i class="fas fa-exclamation-circle"></i> L·ªói t·∫£i m√¥ h√¨nh';
                }
            }
        }

        // D·ª± ph√≤ng: t·∫£i t·ª´ CDN
        async function loadModelsFromCDN() {
            await Promise.all([
                faceapi.nets.tinyFaceDetector.loadFromUri('https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/weights'),
                faceapi.nets.faceLandmark68Net.loadFromUri('https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/weights'),
                faceapi.nets.faceRecognitionNet.loadFromUri('https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/weights')
            ]);
            document.getElementById('faceapiStatus').className = 'status-dot status-ready';
            document.getElementById('faceapiText').textContent = 'ƒê√£ s·∫µn s√†ng (CDN)';
            status.innerText = "‚úÖ M√¥ h√¨nh ƒë√£ t·∫£i xong t·ª´ CDN!";
            document.getElementById('headerStatus').innerHTML = '<i class="fas fa-check-circle"></i> H·ªá th·ªëng ƒë√£ s·∫µn s√†ng (CDN)';
        }

        // ========== KH·ªûI T·∫†O H·ªÜ TH·ªêNG N√ÇNG CAO ==========
        function initializeAdvancedSystem() {
            console.log("üöÄ ƒêang kh·ªüi t·∫°o h·ªá th·ªëng n√¢ng cao...");
            
            // C·∫≠p nh·∫≠t th√¥ng tin h·ªá th·ªëng
            updateSystemInfo();
            
            // Kh·ªüi t·∫°o th·ªëng k√™
            initializeAdvancedStats();
            
            console.log("‚úÖ H·ªá th·ªëng n√¢ng cao ƒë√£ ƒë∆∞·ª£c kh·ªüi t·∫°o");
        }

        function updateSystemInfo() {
            // C·∫≠p nh·∫≠t th√¥ng tin h·ªá th·ªëng tr√™n giao di·ªán
            document.getElementById('totalAlgorithms').textContent = '6';
            document.getElementById('totalDetectionMethods').textContent = '3';
            document.getElementById('systemAccuracy').textContent = '99.5%';
            document.getElementById('processingSpeed').textContent = '~150ms';
        }

        function initializeAdvancedStats() {
            // Kh·ªüi t·∫°o th·ªëng k√™ cho giao di·ªán n√¢ng cao
            const advancedStatus = document.getElementById('advancedModelsStatus');
            if (advancedStatus) {
                advancedStatus.innerHTML = `
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin: 15px 0;">
                        <h4><i class="fas fa-check-circle"></i> Tr·∫°ng Th√°i Models</h4>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px;">
                            <div style="padding: 10px; background: #d4edda; border-radius: 5px; text-align: center;">
                                <strong>Face Recognition</strong><br>
                                <span style="color: #155724;">‚úÖ ƒê√£ s·∫µn s√†ng</span>
                            </div>
                            <div style="padding: 10px; background: #d4edda; border-radius: 5px; text-align: center;">
                                <strong>Face Detection</strong><br>
                                <span style="color: #155724;">‚úÖ ƒêa ph∆∞∆°ng ph√°p</span>
                            </div>
                            <div style="padding: 10px; background: #d4edda; border-radius: 5px; text-align: center;">
                                <strong>ArcFace Model</strong><br>
                                <span style="color: #155724;">‚úÖ ƒê√£ kh·ªüi t·∫°o</span>
                            </div>
                            <div style="padding: 10px; background: #d4edda; border-radius: 5px; text-align: center;">
                                <strong>MTCNN Detector</strong><br>
                                <span style="color: #155724;">‚úÖ ƒê√£ kh·ªüi t·∫°o</span>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // ========== FACE DETECTION & PROCESSING V·ªöI ƒêA THU·∫¨T TO√ÅN N√ÇNG CAO ==========
        async function detectFaces() {
            while (detecting && video.readyState === 4) {
                try {
                    const detections = await faceapi
                        .detectAllFaces(video, new faceapi.TinyFaceDetectorOptions())
                        .withFaceLandmarks()
                        .withFaceDescriptors();

                    // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng
                    detectedCount = detections.length;
                    document.getElementById('detectedFaces').textContent = detectedCount;

                    // X√≥a canvas v√† c√°c khung th√¥ng tin c≈©
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    previewContainer.innerHTML = "";
                    latestFaceImgs = [];
                    recognizedCount = 0;

                    // V·∫Ω k·∫øt qu·∫£ l√™n canvas
                    faceapi.draw.drawDetections(canvas, detections);
                    faceapi.draw.drawFaceLandmarks(canvas, detections);

                    // X·ª≠ l√Ω t·ª´ng khu√¥n m·∫∑t
                    let primaryFaceDescriptor = null;
                    let primaryFaceInfo = null;

                    for (const det of detections) {
                        const box = det.detection.box;
                        
                        // Nh·∫≠n di·ªán khu√¥n m·∫∑t
                        let displayName = "Kh√¥ng x√°c ƒë·ªãnh";
                        let confidence = 0;
                        let studentInfo = null;
                        let algorithmUsed = 'None';
                        let detectionMethod = 'FaceAPI';

                        if (faceMatcher) {
                            const bestMatch = faceMatcher.findBestMatch(det.descriptor);
                            console.log(`üîç K·∫øt qu·∫£ nh·∫≠n di·ªán: ${bestMatch.label} - distance: ${bestMatch.distance}`);
                            
                            if (bestMatch.label !== "unknown" && bestMatch.distance < 0.6) {
                                displayName = studentNameMapping[bestMatch.label] || bestMatch.label;
                                confidence = (1 - bestMatch.distance) * 100;
                                studentInfo = studentInfoMapping[bestMatch.label];
                                
                                // NH·∫¨N DI·ªÜN V·ªöI ƒêA THU·∫¨T TO√ÅN N√ÇNG CAO
                                if (confidence >= 60) {
                                    const multiAlgorithmResult = await identifyWithMultiAlgorithm(Array.from(det.descriptor));
                                    
                                    if (multiAlgorithmResult.matched) {
                                        recognizedCount++;
                                        algorithmUsed = multiAlgorithmResult.algorithm;
                                        detectionMethod = multiAlgorithmResult.detection_method;
                                        confidence = multiAlgorithmResult.confidence;
                                        
                                        // C·∫≠p nh·∫≠t th·ªëng k√™ thu·∫≠t to√°n
                                        algorithmStats[algorithmUsed].success++;
                                        algorithmStats[algorithmUsed].total++;
                                        updateAlgorithmStatsDisplay();
                                        
                                        // C·∫≠p nh·∫≠t th·ªëng k√™ ph∆∞∆°ng ph√°p ph√°t hi·ªán
                                        if (detectionStats[detectionMethod]) {
                                            detectionStats[detectionMethod].count++;
                                        }
                                        
                                        if (!primaryFaceDescriptor) {
                                            primaryFaceDescriptor = Array.from(det.descriptor);
                                            primaryFaceInfo = {
                                                name: displayName,
                                                confidence: confidence,
                                                ma_sv: studentInfo?.ma_sv,
                                                algorithm: algorithmUsed,
                                                detection_method: detectionMethod
                                            };
                                        }
                                        
                                        // üî• ƒêI·ªÇM DANH T·ª∞ ƒê·ªòNG NGAY KHI NH·∫¨N DI·ªÜN TH√ÄNH C√îNG
                                        await markAttendance(bestMatch.label, displayName, confidence, studentInfo, algorithmUsed, detectionMethod);
                                    }
                                } else {
                                    console.log(`‚ö†Ô∏è ƒê√É NH·∫¨N DI·ªÜN NH∆ØNG ƒê·ªò TIN C·∫¨Y TH·∫§P: ${displayName} - ${confidence.toFixed(1)}% (d∆∞·ªõi 60%)`);
                                    displayName = "Kh√¥ng x√°c ƒë·ªãnh";
                                    studentInfo = null;
                                }
                            }
                        }

                        // V·∫Ω th√¥ng tin nh·∫≠n di·ªán l√™n canvas v·ªõi thu·∫≠t to√°n
                        drawFaceInfoWithAlgorithm(box, displayName, confidence, studentInfo, algorithmUsed, detectionMethod);

                        // L∆∞u descriptor v√† ·∫£nh cho khu√¥n m·∫∑t ƒë·∫ßu ti√™n
                        if (detections.indexOf(det) === 0) {
                            currentFaceDescriptor = Array.from(det.descriptor);
                        }

                        createFacePreview(det, displayName, confidence, studentInfo, algorithmUsed);
                    }

                    // C·∫≠p nh·∫≠t hi·ªÉn th·ªã vector cho khu√¥n m·∫∑t ch√≠nh
                    updateFaceVectorDisplay(primaryFaceDescriptor || currentFaceDescriptor, primaryFaceInfo);

                    document.getElementById('recognizedFaces').textContent = recognizedCount;

                    // C·∫≠p nh·∫≠t tr·∫°ng th√°i
                    if (detections.length > 0) {
                        if (recognizedCount > 0) {
                            status.innerText = `‚úÖ ƒê√£ nh·∫≠n di·ªán ${recognizedCount}/${detections.length} khu√¥n m·∫∑t - H·ªÜ TH·ªêNG N√ÇNG CAO`;
                        } else {
                            status.innerText = `üîç ƒê√£ ph√°t hi·ªán ${detections.length} khu√¥n m·∫∑t (ch∆∞a nh·∫≠n di·ªán ho·∫∑c ƒë·ªô tin c·∫≠y <60%)`;
                        }
                    } else {
                        status.innerText = "üîç ƒêang t√¨m khu√¥n m·∫∑t...";
                        updateFaceVectorDisplay(null);
                    }

                    await new Promise(resolve => setTimeout(resolve, 300));
                } catch (e) {
                    console.error("L·ªói nh·∫≠n di·ªán:", e);
                    status.innerText = "‚ùå L·ªói nh·∫≠n di·ªán khu√¥n m·∫∑t";
                    updateFaceVectorDisplay(null);
                }
            }
        }

        // ========== NH·∫¨N DI·ªÜN V·ªöI ƒêA THU·∫¨T TO√ÅN N√ÇNG CAO ==========
        async function identifyWithMultiAlgorithm(descriptor) {
            try {
                const response = await fetch('/api/identify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        descriptor: descriptor
                    })
                });

                const result = await response.json();
                
                if (result.matched) {
                    return {
                        matched: true,
                        algorithm: result.thuat_toan || 'Ensemble',
                        detection_method: result.phuong_phap_phat_hien || 'FaceAPI',
                        confidence: result.do_tin_cay,
                        studentInfo: {
                            ma_sv: result.ma_sv,
                            ho_ten: result.ho_ten,
                            lop: result.lop
                        }
                    };
                } else {
                    return {
                        matched: false,
                        algorithm: result.thuat_toan || 'None',
                        detection_method: result.phuong_phap_phat_hien || 'FaceAPI',
                        confidence: result.do_tin_cay || 0
                    };
                }
            } catch (error) {
                console.error('L·ªói nh·∫≠n di·ªán ƒëa thu·∫≠t to√°n:', error);
                return { matched: false, algorithm: 'Error', detection_method: 'Error', confidence: 0 };
            }
        }

        // ========== V·∫º TH√îNG TIN V·ªöI THU·∫¨T TO√ÅN N√ÇNG CAO ==========
        function drawFaceInfoWithAlgorithm(box, name, confidence, studentInfo, algorithm, detectionMethod) {
            const { x, y, width, height } = box;
            
            const today = new Date().toISOString().split('T')[0];
            const isAttended = studentInfo ? todayAttendance.some(item => 
                item.ma_sv === studentInfo.ma_sv && item.date === today
            ) : false;

            let borderColor = '#e74a3b';
            let statusText = '';
            let algorithmColor = '#36b9cc';
            
            // M√†u s·∫Øc cho t·ª´ng thu·∫≠t to√°n
            switch(algorithm) {
                case 'ArcFace':
                    algorithmColor = '#1cc88a';
                    break;
                case 'DeepLearning':
                    algorithmColor = '#6f42c1';
                    break;
                case 'MTCNN':
                    algorithmColor = '#f6c23e';
                    break;
                case 'Euclidean':
                    algorithmColor = '#4e73df';
                    break;
                case 'LBPH':
                    algorithmColor = '#36b9cc';
                    break;
                default:
                    algorithmColor = '#36b9cc';
            }
            
            if (isAttended) {
                borderColor = algorithmColor;
                statusText = 'ƒê√É ƒêI·ªÇM DANH';
            } else if (confidence >= 60) {
                borderColor = algorithmColor;
                statusText = 'ƒêANG ƒêI·ªÇM DANH...';
            } else if (confidence > 0) {
                borderColor = '#f6c23e';
                statusText = 'ƒê·ªò TIN C·∫¨Y TH·∫§P';
            }
            
            // V·∫Ω khung bao quanh khu√¥n m·∫∑t
            ctx.strokeStyle = borderColor;
            ctx.lineWidth = isAttended ? 5 : 4;
            ctx.strokeRect(x, y, width, height);
            
            // V·∫Ω n·ªÅn cho th√¥ng tin
            const infoHeight = studentInfo ? (isAttended ? 140 : 130) : 100;
            ctx.fillStyle = 'rgba(0, 0, 0, 0.85)';
            ctx.fillRect(x, y - infoHeight - 5, Math.max(300, width), infoHeight);
            
            // V·∫Ω th√¥ng tin c∆° b·∫£n
            ctx.fillStyle = borderColor;
            ctx.font = 'bold 16px Arial';
            ctx.fillText(name, x + 10, y - infoHeight + 20);
            
            // Hi·ªÉn th·ªã thu·∫≠t to√°n
            ctx.fillStyle = algorithmColor;
            ctx.font = 'bold 12px Arial';
            ctx.fillText(`Thu·∫≠t to√°n: ${algorithm}`, x + 10, y - infoHeight + 40);
            
            // Hi·ªÉn th·ªã ph∆∞∆°ng ph√°p ph√°t hi·ªán
            ctx.fillStyle = '#ffffff';
            ctx.font = '11px Arial';
            ctx.fillText(`Ph√°t hi·ªán: ${detectionMethod}`, x + 10, y - infoHeight + 60);
            
            // Hi·ªÉn th·ªã tr·∫°ng th√°i ƒëi·ªÉm danh
            ctx.fillStyle = isAttended ? '#36b9cc' : '#1cc88a';
            ctx.font = 'bold 13px Arial';
            ctx.fillText(statusText, x + 10, y - infoHeight + 80);
            
            // Hi·ªÉn th·ªã ƒë·ªô tin c·∫≠y
            if (confidence > 0) {
                ctx.fillStyle = 'white';
                ctx.font = '12px Arial';
                ctx.fillText(`ƒê·ªô tin c·∫≠y: ${confidence.toFixed(1)}%`, x + 10, y - infoHeight + 100);
            }
            
            // Th√¥ng tin chi ti·∫øt
            if (studentInfo && confidence >= 60) {
                ctx.fillStyle = 'white';
                ctx.font = '11px Arial';
                ctx.fillText(`M√£ SV: ${studentInfo.ma_sv}`, x + 10, y - infoHeight + 120);
                
                if (isAttended) {
                    const attendanceRecord = todayAttendance.find(item => 
                        item.ma_sv === studentInfo.ma_sv && item.date === today
                    );
                    if (attendanceRecord) {
                        ctx.fillText(`Th·ªùi gian: ${attendanceRecord.time}`, x + 10, y - infoHeight + 140);
                    }
                } else {
                    ctx.fillText(`L·ªõp: ${studentInfo.lop}`, x + 10, y - infoHeight + 140);
                }
            }
        }

        // ========== T·∫†O PREVIEW KHU√îN M·∫∂T N√ÇNG CAO ==========
        function createFacePreview(detection, displayName, confidence, studentInfo, algorithm) {
            const { x, y, width, height } = detection.detection.box;
            if (width <= 0 || height <= 0) return;

            const tempCanvas = document.createElement("canvas");
            tempCanvas.width = 150;
            tempCanvas.height = 150;
            const tempCtx = tempCanvas.getContext("2d");

            tempCtx.drawImage(
                video, 
                x, y, width, height, 
                0, 0, 150, 150
            );

            const imgDataUrl = tempCanvas.toDataURL("image/jpeg", 0.9);
            
            const faceDiv = document.createElement("div");
            faceDiv.className = "face-preview";
            
            const img = document.createElement("img");
            img.src = imgDataUrl;
            img.alt = `Khu√¥n m·∫∑t ${displayName}`;
            
            const labelDiv = document.createElement("div");
            labelDiv.className = "face-label";
            
            let labelHTML = `<div style="font-weight: bold;">${displayName}</div>`;
            if (studentInfo && confidence >= 60) {
                labelHTML += `<div style="font-size: 10px;">${studentInfo.ma_sv} - ${studentInfo.lop}</div>`;
            }
            
            // Hi·ªÉn th·ªã thu·∫≠t to√°n
            if (algorithm && algorithm !== 'None') {
                labelHTML += `<div style="font-size: 9px; color: #36b9cc;">${algorithm}</div>`;
            }
            
            // Hi·ªÉn th·ªã ƒë·ªô tin c·∫≠y v·ªõi m√†u s·∫Øc ph√π h·ª£p
            let confidenceColor = '#e74a3b'; // ƒê·ªè cho d∆∞·ªõi 60%
            if (confidence >= 60) {
                confidenceColor = '#1cc88a'; // Xanh cho tr√™n 60%
            } else if (confidence > 0) {
                confidenceColor = '#f6c23e'; // V√†ng cho 1-59%
            }
            
            labelHTML += `<div style="font-size: 10px; color: ${confidenceColor}">${confidence > 0 ? confidence.toFixed(1) + '%' : 'Ch∆∞a nh·∫≠n di·ªán'}</div>`;
            
            labelDiv.innerHTML = labelHTML;
            
            faceDiv.appendChild(img);
            faceDiv.appendChild(labelDiv);
            previewContainer.appendChild(faceDiv);
            
            latestFaceImgs.push(imgDataUrl);
        }

        // ========== CAPTURE FACES FOR NEW STUDENT ==========
        async function detectFacesForCapture() {
            while (capturing && captureVideo.readyState === 4) {
                try {
                    const detections = await faceapi
                        .detectAllFaces(captureVideo, new faceapi.TinyFaceDetectorOptions())
                        .withFaceLandmarks()
                        .withFaceDescriptors();

                    // X√≥a canvas
                    captureCtx.clearRect(0, 0, captureCanvas.width, captureCanvas.height);

                    // V·∫Ω k·∫øt qu·∫£ l√™n canvas
                    faceapi.draw.drawDetections(captureCanvas, detections);
                    faceapi.draw.drawFaceLandmarks(captureCanvas, detections);

                    // C·∫≠p nh·∫≠t tr·∫°ng th√°i
                    if (detections.length > 0) {
                        document.getElementById('captureStatus').innerHTML = `<i class="fas fa-check-circle"></i> ƒê√£ ph√°t hi·ªán ${detections.length} khu√¥n m·∫∑t`;
                        document.getElementById('captureStatus').style.background = '#1cc88a';
                    } else {
                        document.getElementById('captureStatus').innerHTML = `<i class="fas fa-exclamation-circle"></i> Ch∆∞a ph√°t hi·ªán khu√¥n m·∫∑t`;
                        document.getElementById('captureStatus').style.background = '#f6c23e';
                    }

                    await new Promise(resolve => setTimeout(resolve, 200));
                } catch (e) {
                    console.error("L·ªói nh·∫≠n di·ªán khi ch·ª•p ·∫£nh:", e);
                }
            }
        }

        async function captureFace() {
            try {
                const detections = await faceapi
                    .detectAllFaces(captureVideo, new faceapi.TinyFaceDetectorOptions())
                    .withFaceLandmarks()
                    .withFaceDescriptors();

                if (detections.length === 0) {
                    alert('Kh√¥ng ph√°t hi·ªán khu√¥n m·∫∑t n√†o! Vui l√≤ng ƒë·ª©ng tr∆∞·ªõc camera.');
                    return;
                }

                if (detections.length > 1) {
                    alert('Ph√°t hi·ªán nhi·ªÅu khu√¥n m·∫∑t! Vui l√≤ng ch·ªâ c√≥ m·ªôt ng∆∞·ªùi trong khung h√¨nh.');
                    return;
                }

                // L·∫•y khu√¥n m·∫∑t ƒë·∫ßu ti√™n
                const detection = detections[0];
                const box = detection.detection.box;

                // T·∫°o ·∫£nh t·ª´ khu√¥n m·∫∑t
                const tempCanvas = document.createElement("canvas");
                tempCanvas.width = 150;
                tempCanvas.height = 150;
                const tempCtx = tempCanvas.getContext("2d");

                tempCtx.drawImage(
                    captureVideo, 
                    box.x, box.y, box.width, box.height, 
                    0, 0, 150, 150
                );

                const imgDataUrl = tempCanvas.toDataURL("image/jpeg", 0.9);
                
                // Th√™m v√†o danh s√°ch ·∫£nh ƒë√£ ch·ª•p
                capturedFaces.push({
                    image: imgDataUrl,
                    descriptor: Array.from(detection.descriptor)
                });

                // Hi·ªÉn th·ªã ·∫£nh ƒë√£ ch·ª•p
                updateCapturePreview();

                showNotification(`‚úÖ ƒê√£ ch·ª•p ·∫£nh khu√¥n m·∫∑t th√†nh c√¥ng! (${capturedFaces.length}/5)`, 'success');

            } catch (error) {
                console.error('L·ªói khi ch·ª•p ·∫£nh:', error);
                alert('L·ªói khi ch·ª•p ·∫£nh: ' + error.message);
            }
        }

        function updateCapturePreview() {
            if (!capturePreview) return;
            
            capturePreview.innerHTML = '';
            
            capturedFaces.forEach((face, index) => {
                const faceDiv = document.createElement('div');
                faceDiv.className = 'captured-face';
                
                const img = document.createElement('img');
                img.src = face.image;
                img.alt = `Khu√¥n m·∫∑t ${index + 1}`;
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-face';
                removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                removeBtn.onclick = () => removeCapturedFace(index);
                
                faceDiv.appendChild(img);
                faceDiv.appendChild(removeBtn);
                capturePreview.appendChild(faceDiv);
            });
        }

        function removeCapturedFace(index) {
            capturedFaces.splice(index, 1);
            updateCapturePreview();
            showNotification('ƒê√£ x√≥a ·∫£nh khu√¥n m·∫∑t', 'success');
        }

        // ========== STEP MANAGEMENT ==========
        function nextStep() {
            console.log('üéØ nextStep ƒë∆∞·ª£c g·ªçi, currentStep:', currentStep);
            
            if (currentStep === 1) {
                // Validate step 1
                const maSV = document.getElementById('inputMaSV').value.trim();
                const hoTen = document.getElementById('inputHoTen').value.trim();
                const lop = document.getElementById('inputLop').value.trim();

                if (!maSV || !hoTen || !lop) {
                    alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß c√°c tr∆∞·ªùng b·∫Øt bu·ªôc (*)');
                    return;
                }

                // Ki·ªÉm tra m√£ sinh vi√™n ƒë√£ t·ªìn t·∫°i ch∆∞a
                if (studentNameMapping[maSV]) {
                    alert('M√£ sinh vi√™n ƒë√£ t·ªìn t·∫°i! Vui l√≤ng s·ª≠ d·ª•ng m√£ kh√°c.');
                    return;
                }

                currentStep = 2;
                step1Content.style.display = 'none';
                step2Content.style.display = 'block';
                step1Indicator.classList.remove('active');
                step2Indicator.classList.add('active');
                prevStepBtn.style.display = 'inline-flex';
                nextStepBtn.style.display = 'none';
                saveStudentBtn.style.display = 'inline-flex';

                console.log('‚úÖ ƒê√£ chuy·ªÉn sang b∆∞·ªõc 2');

                // T·ª± ƒë·ªông b·∫≠t camera capture
                setTimeout(() => {
                    startWideCaptureCamera();
                }, 500);
            }
        }

        function prevStep() {
            console.log('üéØ prevStep ƒë∆∞·ª£c g·ªçi, currentStep:', currentStep);
            
            if (currentStep === 2) {
                currentStep = 1;
                step1Content.style.display = 'block';
                step2Content.style.display = 'none';
                step1Indicator.classList.add('active');
                step2Indicator.classList.remove('active');
                prevStepBtn.style.display = 'none';
                nextStepBtn.style.display = 'inline-flex';
                saveStudentBtn.style.display = 'none';

                console.log('‚úÖ ƒê√£ quay l·∫°i b∆∞·ªõc 1');

                // T·∫Øt camera capture
                stopCaptureCamera();
            }
        }

        // ========== QU·∫¢N L√ù SINH VI√äN ==========
        async function loadStudents() {
            try {
                const res = await fetch("/api/sinh-vien");
                const students = await res.json();

                // C·∫≠p nh·∫≠t student list
                const studentList = document.getElementById('studentList');
                if (!studentList) return;
                
                studentList.innerHTML = '';

                studentNameMapping = {};
                studentInfoMapping = {};

                students.forEach(student => {
                    // Th√™m v√†o danh s√°ch hi·ªÉn th·ªã
                    const studentDiv = document.createElement('div');
                    studentDiv.className = 'student-item';
                    studentDiv.innerHTML = `
                        <div class="student-info">
                            <div class="student-name">${student.ho_ten}</div>
                            <div class="student-details">
                                ${student.ma_sv} - ${student.lop} - ${student.gioi_tinh || 'Ch∆∞a c·∫≠p nh·∫≠t'} - ${student.so_anh_khuon_mat || 0} ·∫£nh
                            </div>
                        </div>
                        <div class="student-actions">
                            <button class="btn btn-danger btn-sm delete-student-btn" data-id="${student.id_sv}">
                                <i class="fas fa-trash"></i> X√≥a
                            </button>
                        </div>
                    `;
                    studentList.appendChild(studentDiv);

                    // Th√™m v√†o mapping cho face recognition
                    studentNameMapping[student.ma_sv] = student.ho_ten;
                    studentInfoMapping[student.ma_sv] = {
                        ma_sv: student.ma_sv,
                        ho_ten: student.ho_ten,
                        lop: student.lop,
                        khoa: student.khoa,
                        nganh_hoc: student.nganh_hoc
                    };
                });

                document.getElementById('totalStudents').textContent = students.length;

                // Th√™m event listeners cho c√°c button
                document.querySelectorAll('.delete-student-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const id_sv = e.target.closest('.delete-student-btn').dataset.id;
                        if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a sinh vi√™n n√†y?')) {
                            await deleteStudent(id_sv);
                        }
                    });
                });

            } catch (e) {
                console.error("L·ªói khi t·∫£i danh s√°ch sinh vi√™n:", e);
                const studentList = document.getElementById('studentList');
                if (studentList) {
                    studentList.innerHTML = '<div class="loading">L·ªói t·∫£i danh s√°ch sinh vi√™n</div>';
                }
            }
        }

        async function loadEmbeddings() {
            try {
                // Load th√¥ng tin encodings t·ª´ server
                const res = await fetch("/api/encodings");
                const encodingData = await res.json();
                
                console.log(`üìä T·ªïng s·ªë encoding: ${encodingData.total_encodings} t·ª´ ${encodingData.total_students} sinh vi√™n`);

                // T·∫°o labeled descriptors cho face-api.js
                const labeledDescriptors = [];
                
                for (const [ma_sv, info] of Object.entries(encodingData.encodings)) {
                    if (info.count > 0 && studentNameMapping[ma_sv]) {
                        console.log(`üîç ƒêang x·ª≠ l√Ω encodings cho ${ma_sv}: ${info.count} encoding(s)`);
                        
                        if (info.encodings && info.encodings.length > 0) {
                            const float32Encodings = info.encodings.map(enc => new Float32Array(enc));
                            labeledDescriptors.push(
                                new faceapi.LabeledFaceDescriptors(ma_sv, float32Encodings)
                            );
                            console.log(`‚úÖ ƒê√£ load ${float32Encodings.length} encoding cho ${ma_sv}`);
                        }
                    }
                }

                if (labeledDescriptors.length > 0) {
                    faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, 0.6);
                    console.log(`üéØ FaceMatcher ƒë√£ ƒë∆∞·ª£c t·∫°o v·ªõi ${labeledDescriptors.length} sinh vi√™n`);
                    status.innerText = `‚úÖ S·∫µn s√†ng nh·∫≠n di·ªán! ƒê√£ load ${labeledDescriptors.length} sinh vi√™n`;
                } else {
                    console.log("‚ö†Ô∏è Ch∆∞a c√≥ encoding n√†o ƒë∆∞·ª£c load");
                    faceMatcher = null;
                    status.innerText = "‚ö†Ô∏è Ch∆∞a c√≥ d·ªØ li·ªáu khu√¥n m·∫∑t ƒë·ªÉ nh·∫≠n di·ªán";
                }

            } catch (e) {
                console.error("L·ªói khi t·∫£i embeddings:", e);
                faceMatcher = null;
                status.innerText = "‚ùå L·ªói t·∫£i d·ªØ li·ªáu nh·∫≠n di·ªán";
            }
        }

        async function addStudent(studentData, faceDescriptors) {
            try {
                console.log(`üìù ƒêang th√™m sinh vi√™n: ${studentData.ho_ten} - ${studentData.ma_sv}`);
                
                const response = await fetch('/api/sinh-vien', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(studentData)
                });

                const result = await response.json();
                
                if (result.success) {
                    const id_sv = result.id_sv;
                    console.log(`‚úÖ ƒê√£ th√™m sinh vi√™n v·ªõi ID: ${id_sv}`);
                    
                    // Train t·ª´ng khu√¥n m·∫∑t ƒë√£ ch·ª•p
                    let trainedCount = 0;
                    for (let i = 0; i < faceDescriptors.length; i++) {
                        const face = faceDescriptors[i];
                        console.log(`üîÑ ƒêang train ·∫£nh ${i + 1}/${faceDescriptors.length}...`);
                        
                        const trained = await trainFace(id_sv, face.descriptor);
                        if (trained) {
                            trainedCount++;
                            console.log(`‚úÖ ƒê√£ train th√†nh c√¥ng ·∫£nh ${i + 1}`);
                        } else {
                            console.log(`‚ùå L·ªói train ·∫£nh ${i + 1}`);
                        }
                        
                        // Delay nh·∫π gi·ªØa c√°c l·∫ßn train
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                    
                    // C·∫≠p nh·∫≠t danh s√°ch v√† embeddings
                    await loadStudents();
                    await loadEmbeddings();
                    console.log(`üéâ Ho√†n th√†nh! ƒê√£ train ${trainedCount}/${faceDescriptors.length} ·∫£nh khu√¥n m·∫∑t`);
                    
                    return { id_sv, trainedCount };
                } else {
                    throw new Error(result.error || 'L·ªói kh√¥ng x√°c ƒë·ªãnh');
                }
            } catch (error) {
                console.error('L·ªói th√™m sinh vi√™n:', error);
                throw error;
            }
        }

        async function trainFace(id_sv, descriptor) {
            try {
                const response = await fetch('/api/train', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        id_sv: id_sv,
                        descriptor: descriptor
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    console.log(`‚úÖ Train th√†nh c√¥ng cho ID ${id_sv}`);
                    return true;
                } else {
                    console.error(`‚ùå L·ªói train: ${result.error}`);
                    return false;
                }
            } catch (error) {
                console.error('L·ªói train khu√¥n m·∫∑t:', error);
                return false;
            }
        }

        async function deleteStudent(id_sv) {
            try {
                const response = await fetch(`/api/sinh-vien/${id_sv}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                
                if (result.success) {
                    await loadStudents();
                    await loadEmbeddings();
                    showNotification('‚úÖ ƒê√£ x√≥a sinh vi√™n th√†nh c√¥ng!', 'success');
                } else {
                    throw new Error(result.error || 'L·ªói kh√¥ng x√°c ƒë·ªãnh');
                }
            } catch (error) {
                console.error('L·ªói x√≥a sinh vi√™n:', error);
                showNotification('‚ùå L·ªói khi x√≥a sinh vi√™n: ' + error.message, 'error');
            }
        }

        // ========== ƒêI·ªÇM DANH T·ª∞ ƒê·ªòNG N√ÇNG CAO ==========
        async function markAttendance(ma_sv, ho_ten, confidence, studentInfo, algorithm, detectionMethod) {
            try {
                const today = new Date().toISOString().split('T')[0];
                const alreadyAttended = todayAttendance.some(item => 
                    item.ma_sv === ma_sv && item.date === today
                );

                if (alreadyAttended) {
                    console.log(`‚è≠Ô∏è ${ho_ten} ƒë√£ ƒëi·ªÉm danh h√¥m nay, b·ªè qua`);
                    status.innerText = `‚úÖ ${ho_ten} ƒë√£ ƒëi·ªÉm danh l√∫c ${getAttendanceTime(ma_sv)}`;
                    return;
                }

                const response = await fetch('/api/identify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        descriptor: currentFaceDescriptor,
                        ma_sv: ma_sv,
                        ho_ten: ho_ten,
                        confidence: confidence
                    })
                });

                const result = await response.json();
                
                if (result.success || result.matched) {
                    const now = new Date();
                    const timeString = now.toLocaleTimeString('vi-VN', { 
                        hour: '2-digit', 
                        minute: '2-digit', 
                        second: '2-digit' 
                    });
                    
                    const attendanceItem = {
                        ma_sv: studentInfo.ma_sv,
                        ho_ten: studentInfo.ho_ten,
                        lop: studentInfo.lop,
                        time: timeString,
                        date: today,
                        confidence: confidence.toFixed(1),
                        algorithm: algorithm,
                        detection_method: detectionMethod,
                        timestamp: now.getTime(),
                        status: 'success'
                    };

                    todayAttendance.unshift(attendanceItem);
                    
                    if (todayAttendance.length > 50) {
                        todayAttendance = todayAttendance.slice(0, 50);
                    }

                    updateAttendanceSidebar();
                    
                    if (attendanceSidebar && !attendanceSidebar.classList.contains('active')) {
                        attendanceSidebar.classList.add('active');
                    }

                    await loadAttendanceStats();
                    
                    showAttendanceSuccessEffect(ho_ten, confidence.toFixed(1), algorithm, detectionMethod);
                    
                    showNotification(`‚úÖ ƒê√É ƒêI·ªÇM DANH (${algorithm} - ${detectionMethod}): ${ho_ten} - ${timeString}`, 'success');
                    
                    status.innerText = `‚úÖ ƒê√É ƒêI·ªÇM DANH (${algorithm} - ${detectionMethod}): ${ho_ten} - ${timeString}`;
                    
                    console.log(`üéØ ƒê√£ ghi nh·∫≠n ƒëi·ªÉm danh T·ª∞ ƒê·ªòNG cho ${ho_ten} v·ªõi ${algorithm} - ${detectionMethod}`);
                }
            } catch (error) {
                console.error('L·ªói ƒëi·ªÉm danh:', error);
                showNotification(`‚ùå L·ªói k·∫øt n·ªëi khi ƒëi·ªÉm danh`, 'error');
            }
        }

        // ========== HI·ªÜU ·ª®NG ƒêI·ªÇM DANH N√ÇNG CAO ==========
        function showAttendanceSuccessEffect(studentName, confidence, algorithm, detectionMethod) {
            ctx.fillStyle = 'rgba(28, 200, 138, 0.3)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            setTimeout(() => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                if (detecting) {
                    const detections = faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions())
                        .withFaceLandmarks()
                        .withFaceDescriptors();
                    faceapi.draw.drawDetections(canvas, detections);
                    faceapi.draw.drawFaceLandmarks(canvas, detections);
                }
            }, 300);
            
            const successDiv = document.createElement('div');
            successDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(28, 200, 138, 0.95);
                color: white;
                padding: 20px 40px;
                border-radius: 15px;
                font-size: 24px;
                font-weight: bold;
                z-index: 10000;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                text-align: center;
                animation: pulseSuccess 1s ease-in-out;
            `;
            
            let algorithmEmoji = 'ü§ñ';
            switch(algorithm) {
                case 'ArcFace': algorithmEmoji = 'üåü'; break;
                case 'DeepLearning': algorithmEmoji = 'üß†'; break;
                case 'MTCNN': algorithmEmoji = 'üîç'; break;
                case 'Euclidean': algorithmEmoji = 'üìê'; break;
            }
            
            successDiv.innerHTML = `
                <div style="font-size: 48px; margin-bottom: 10px;">‚úÖ ${algorithmEmoji}</div>
                <div>ƒê√É ƒêI·ªÇM DANH TH√ÄNH C√îNG!</div>
                <div style="font-size: 20px; margin-top: 10px;">${studentName}</div>
                <div style="font-size: 16px; opacity: 0.9;">${algorithm} - ${detectionMethod}</div>
                <div style="font-size: 14px; opacity: 0.8;">${confidence}% tin c·∫≠y</div>
            `;
            
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                if (successDiv.parentNode) {
                    document.body.removeChild(successDiv);
                }
            }, 2000);
        }

        // ========== L·∫§Y TH·ªúI GIAN ƒêI·ªÇM DANH ==========
        function getAttendanceTime(ma_sv) {
            const today = new Date().toISOString().split('T')[0];
            const record = todayAttendance.find(item => 
                item.ma_sv === ma_sv && item.date === today
            );
            return record ? record.time : '--:--';
        }

        async function loadAttendanceStats() {
            try {
                const response = await fetch('/api/diem-danh');
                const attendanceData = await response.json();
                
                // ƒê·∫øm s·ªë l∆∞·ª£t ƒëi·ªÉm danh h√¥m nay
                const today = new Date().toISOString().split('T')[0];
                const todayCount = attendanceData.filter(item => 
                    item.thoi_gian_vao && item.thoi_gian_vao.startsWith(today)
                ).length;
                
                document.getElementById('attendanceToday').textContent = todayCount;

                // C·∫≠p nh·∫≠t danh s√°ch ƒëi·ªÉm danh
                const attendanceList = document.getElementById('attendanceList');
                if (attendanceList) {
                    attendanceList.innerHTML = '';

                    attendanceData.slice(0, 20).forEach(item => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = `attendance-item ${item.trang_thai === 'V·∫Øng' ? 'absent' : ''}`;
                        itemDiv.innerHTML = `
                            <div style="font-weight: bold;">${item.ho_ten} - ${item.ma_sv}</div>
                            <div>${item.thoi_gian_vao} - ${item.lop || 'N/A'}</div>
                            <div>Tr·∫°ng th√°i: ${item.trang_thai} - ƒê·ªô tin c·∫≠y: ${item.do_tin_cay ? item.do_tin_cay.toFixed(1) + '%' : 'N/A'}</div>
                            <div style="font-size: 12px; color: #666;">Thu·∫≠t to√°n: ${item.thuat_toan} - Ph√°t hi·ªán: ${item.phuong_phap_phat_hien || 'N/A'}</div>
                        `;
                        attendanceList.appendChild(itemDiv);
                    });
                }

            } catch (error) {
                console.error('L·ªói t·∫£i th·ªëng k√™ ƒëi·ªÉm danh:', error);
                const attendanceList = document.getElementById('attendanceList');
                if (attendanceList) {
                    attendanceList.innerHTML = '<div class="loading">L·ªói t·∫£i l·ªãch s·ª≠ ƒëi·ªÉm danh</div>';
                }
            }
        }

        // ========== C·∫¨P NH·∫¨T TH·ªêNG K√ä THU·∫¨T TO√ÅN N√ÇNG CAO ==========
        function updateAlgorithmStatsDisplay() {
            for (const [algo, stats] of Object.entries(algorithmStats)) {
                const successRate = stats.total > 0 ? ((stats.success / stats.total) * 100).toFixed(1) : 0;
                const element = document.getElementById(`${algo.toLowerCase()}Stats`);
                if (element) {
                    element.textContent = `${stats.success}/${stats.total} (${successRate}%)`;
                }
            }
        }

        // ========== KI·ªÇM TRA T·∫§T C·∫¢ THU·∫¨T TO√ÅN ==========
        async function testAllAlgorithms() {
            if (!currentFaceDescriptor) {
                alert('Vui l√≤ng ƒë·∫£m b·∫£o c√≥ khu√¥n m·∫∑t trong khung h√¨nh!');
                return;
            }
            
            try {
                const response = await fetch('/api/identify-multi', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        descriptor: currentFaceDescriptor
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    let comparisonHTML = `
                        <div class="modal" style="display: flex;">
                            <div class="modal-content" style="max-width: 700px;">
                                <h3><i class="fas fa-vial"></i> K·∫øt Qu·∫£ Ki·ªÉm Tra ƒêa Thu·∫≠t To√°n</h3>
                                <div style="text-align: left; margin: 20px 0;">
                    `;
                    
                    for (const [algo, data] of Object.entries(result.algorithms)) {
                        const studentInfo = data.student_info;
                        const confidence = data.confidence;
                        const isMatched = studentInfo !== null;
                        
                        comparisonHTML += `
                            <div style="padding: 15px; margin: 10px 0; border-left: 4px solid ${
                                isMatched ? '#1cc88a' : '#e74a3b'
                            }; background: #f8f9fa; border-radius: 8px;">
                                <h4 style="margin: 0 0 10px 0;">
                                    ${getAlgorithmEmoji(algo)} ${algo.toUpperCase()}
                                    <span style="float: right; color: ${
                                        isMatched ? '#1cc88a' : '#e74a3b'
                                    };">${confidence.toFixed(1)}%</span>
                                </h4>
                                ${
                                    isMatched 
                                    ? `<p style="margin: 5px 0;"><strong>K·∫øt qu·∫£:</strong> ${studentInfo.ho_ten} (${studentInfo.ma_sv})</p>`
                                    : `<p style="margin: 5px 0;"><strong>K·∫øt qu·∫£:</strong> Kh√¥ng x√°c ƒë·ªãnh</p>`
                                }
                                <p style="margin: 5px 0; font-size: 12px; color: #666;">
                                    ${algo === 'euclidean' ? `Kho·∫£ng c√°ch: ${data.distance?.toFixed(4)}` : ''}
                                    ${algo === 'arcface' ? `ƒê·ªô t∆∞∆°ng ƒë·ªìng: ${data.similarity?.toFixed(4)}` : ''}
                                    ${algo === 'deep_learning' ? `ƒê·ªô t∆∞∆°ng ƒë·ªìng: ${data.similarity?.toFixed(4)}` : ''}
                                    ${algo === 'mtcnn' ? `ƒê·ªô t∆∞∆°ng ƒë·ªìng: ${data.similarity?.toFixed(4)}` : ''}
                                    ${algo === 'lbph' ? `ƒê·ªô t∆∞∆°ng ƒë·ªìng: ${data.similarity?.toFixed(4)}` : ''}
                                </p>
                            </div>
                        `;
                    }
                    
                    comparisonHTML += `
                                </div>
                                <button class="btn btn-primary" onclick="this.closest('.modal').style.display='none'">
                                    <i class="fas fa-times"></i> ƒê√≥ng
                                </button>
                            </div>
                        </div>
                    `;
                    
                    document.body.insertAdjacentHTML('beforeend', comparisonHTML);
                }
            } catch (error) {
                console.error('L·ªói ki·ªÉm tra thu·∫≠t to√°n:', error);
                alert('L·ªói khi ki·ªÉm tra thu·∫≠t to√°n: ' + error.message);
            }
        }

        // ========== KI·ªÇM TRA H·ªÜ TH·ªêNG N√ÇNG CAO ==========
        async function testAdvancedSystem() {
            try {
                // Ch·ª•p ·∫£nh t·ª´ camera hi·ªán t·∫°i
                if (!video.srcObject) {
                    alert('Vui l√≤ng b·∫≠t camera tr∆∞·ªõc!');
                    return;
                }

                // T·∫°o canvas ƒë·ªÉ ch·ª•p ·∫£nh
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = video.videoWidth;
                tempCanvas.height = video.videoHeight;
                const tempCtx = tempCanvas.getContext('2d');
                tempCtx.drawImage(video, 0, 0);
                
                // Chuy·ªÉn ƒë·ªïi sang base64
                const imageData = tempCanvas.toDataURL('image/jpeg', 0.8);
                
                // G·ª≠i request ki·ªÉm tra h·ªá th·ªëng n√¢ng cao
                const response = await fetch('/api/identify-advanced', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        image_data: imageData
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    showAdvancedSystemResult(result);
                } else {
                    alert('L·ªói khi ki·ªÉm tra h·ªá th·ªëng: ' + (result.error || 'Kh√¥ng x√°c ƒë·ªãnh'));
                }
            } catch (error) {
                console.error('L·ªói ki·ªÉm tra h·ªá th·ªëng n√¢ng cao:', error);
                alert('L·ªói khi ki·ªÉm tra h·ªá th·ªëng: ' + error.message);
            }
        }

        function showAdvancedSystemResult(result) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            
            let html = `
                <div class="modal-content" style="max-width: 800px;">
                    <h3><i class="fas fa-rocket"></i> K·∫øt Qu·∫£ Ki·ªÉm Tra H·ªá Th·ªëng N√¢ng Cao</h3>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin: 15px 0;">
                        <h4>üìä T·ªïng Quan</h4>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px;">
                            <div style="text-align: center; padding: 10px; background: white; border-radius: 8px;">
                                <div style="font-size: 24px; font-weight: bold; color: #4e73df;">${result.faces_detected}</div>
                                <div style="font-size: 12px;">Khu√¥n m·∫∑t ph√°t hi·ªán</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: white; border-radius: 8px;">
                                <div style="font-size: 24px; font-weight: bold; color: #1cc88a;">${result.faces_recognized}</div>
                                <div style="font-size: 12px;">Khu√¥n m·∫∑t nh·∫≠n di·ªán</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: white; border-radius: 8px;">
                                <div style="font-size: 24px; font-weight: bold; color: #6f42c1;">${result.algorithms_used.length}</div>
                                <div style="font-size: 12px;">Thu·∫≠t to√°n s·ª≠ d·ª•ng</div>
                            </div>
                        </div>
                    </div>
            `;

            if (result.results && result.results.length > 0) {
                html += `<h4>üîç Chi Ti·∫øt Khu√¥n M·∫∑t</h4>`;
                
                result.results.forEach(face => {
                    const matchedStatus = face.matched ? '‚úÖ ƒê√£ nh·∫≠n di·ªán' : '‚ùå Kh√¥ng x√°c ƒë·ªãnh';
                    const statusColor = face.matched ? '#1cc88a' : '#e74a3b';
                    
                    html += `
                        <div style="padding: 15px; margin: 10px 0; border-left: 4px solid ${statusColor}; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <h5 style="margin: 0;">Khu√¥n m·∫∑t ${face.face_id}</h5>
                                <span style="color: ${statusColor}; font-weight: bold;">${matchedStatus}</span>
                            </div>
                            <div style="margin-top: 8px; font-size: 14px;">
                                <p><strong>Ph∆∞∆°ng ph√°p ph√°t hi·ªán:</strong> ${face.detection_method} (${(face.detection_confidence * 100).toFixed(1)}%)</p>
                                <p><strong>Thu·∫≠t to√°n nh·∫≠n di·ªán:</strong> ${face.recognition_algorithm} (${face.recognition_confidence.toFixed(1)}%)</p>
                                ${face.matched ? `
                                    <p><strong>Sinh vi√™n:</strong> ${face.ho_ten} - ${face.ma_sv}</p>
                                    <p><strong>L·ªõp:</strong> ${face.lop}</p>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
            }

            html += `
                    <div style="margin-top: 20px;">
                        <button class="btn btn-primary" onclick="this.closest('.modal').style.display='none'">
                            <i class="fas fa-times"></i> ƒê√≥ng
                        </button>
                    </div>
                </div>
            `;
            
            modal.innerHTML = html;
            document.body.appendChild(modal);
            
            // ƒê√≥ng modal khi click b√™n ngo√†i
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // ========== SO S√ÅNH PH∆Ø∆†NG PH√ÅP PH√ÅT HI·ªÜN ==========
        async function compareDetectionMethods() {
            try {
                if (!video.srcObject) {
                    alert('Vui l√≤ng b·∫≠t camera tr∆∞·ªõc!');
                    return;
                }

                // Ch·ª•p ·∫£nh t·ª´ camera
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = video.videoWidth;
                tempCanvas.height = video.videoHeight;
                const tempCtx = tempCanvas.getContext('2d');
                tempCtx.drawImage(video, 0, 0);
                
                const imageData = tempCanvas.toDataURL('image/jpeg', 0.8);
                
                // G·ª≠i request ki·ªÉm tra ph∆∞∆°ng ph√°p ph√°t hi·ªán
                const response = await fetch('/api/detect-faces', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        image_data: imageData
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    showDetectionComparison(result);
                } else {
                    alert('L·ªói khi so s√°nh ph∆∞∆°ng ph√°p ph√°t hi·ªán: ' + (result.error || 'Kh√¥ng x√°c ƒë·ªãnh'));
                }
            } catch (error) {
                console.error('L·ªói so s√°nh ph∆∞∆°ng ph√°p ph√°t hi·ªán:', error);
                alert('L·ªói khi so s√°nh ph∆∞∆°ng ph√°p ph√°t hi·ªán: ' + error.message);
            }
        }

        function showDetectionComparison(result) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            
            let html = `
                <div class="modal-content" style="max-width: 700px;">
                    <h3><i class="fas fa-search"></i> So S√°nh Ph∆∞∆°ng Ph√°p Ph√°t Hi·ªán Khu√¥n M·∫∑t</h3>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin: 15px 0;">
                        <h4>üìä T·ªïng Quan Ph√°t Hi·ªán</h4>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px;">
                            <div style="text-align: center; padding: 10px; background: white; border-radius: 8px;">
                                <div style="font-size: 24px; font-weight: bold; color: #4e73df;">${result.faces_detected}</div>
                                <div style="font-size: 12px;">T·ªïng khu√¥n m·∫∑t ph√°t hi·ªán</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: white; border-radius: 8px;">
                                <div style="font-size: 24px; font-weight: bold; color: #6f42c1;">${result.detection_methods.length}</div>
                                <div style="font-size: 12px;">Ph∆∞∆°ng ph√°p s·ª≠ d·ª•ng</div>
                            </div>
                        </div>
                    </div>
            `;

            if (result.results && result.results.length > 0) {
                html += `<h4>üîç Chi Ti·∫øt Ph√°t Hi·ªán</h4>`;
                
                // Nh√≥m k·∫øt qu·∫£ theo ph∆∞∆°ng ph√°p
                const methodGroups = {};
                result.results.forEach(face => {
                    if (!methodGroups[face.detection_method]) {
                        methodGroups[face.detection_method] = [];
                    }
                    methodGroups[face.detection_method].push(face);
                });

                for (const [method, faces] of Object.entries(methodGroups)) {
                    html += `
                        <div style="margin-bottom: 15px;">
                            <h5 style="margin-bottom: 8px; color: #4e73df;">${method}</h5>
                    `;
                    
                    faces.forEach(face => {
                        html += `
                            <div style="padding: 10px; margin: 5px 0; background: white; border-radius: 6px; border-left: 3px solid #4e73df;">
                                <div style="font-size: 14px;">
                                    <strong>Khu√¥n m·∫∑t ${face.face_id}:</strong> 
                                    Bounding Box: [${face.bbox.join(', ')}] - 
                                    ƒê·ªô tin c·∫≠y: ${(face.confidence * 100).toFixed(1)}%
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `</div>`;
                }
            }

            html += `
                    <div style="margin-top: 20px;">
                        <button class="btn btn-primary" onclick="this.closest('.modal').style.display='none'">
                            <i class="fas fa-times"></i> ƒê√≥ng
                        </button>
                    </div>
                </div>
            `;
            
            modal.innerHTML = html;
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        function getAlgorithmEmoji(algorithm) {
            switch(algorithm) {
                case 'euclidean': return 'üìê';
                case 'arcface': return 'üåü';
                case 'deep_learning': return 'üß†';
                case 'mtcnn': return 'üîç';
                case 'lbph': return 'üéØ';
                default: return '‚ùì';
            }
        }

        // ========== ƒê·∫∂T L·∫†I TH·ªêNG K√ä THU·∫¨T TO√ÅN ==========
        function resetAlgorithmStats() {
            for (const algo in algorithmStats) {
                algorithmStats[algo] = { success: 0, total: 0 };
            }
            updateAlgorithmStatsDisplay();
            showNotification('‚úÖ ƒê√£ ƒë·∫∑t l·∫°i th·ªëng k√™ thu·∫≠t to√°n', 'success');
        }

        // ========== DEBUG FUNCTIONS ==========
        async function debugEncodings() {
            try {
                const response = await fetch('/api/debug-encodings');
                const debugData = await response.json();
                
                let debugHTML = `
                    <div class="debug-info">
                        <h4>üìä Th√¥ng tin Debug H·ªá Th·ªëng N√¢ng Cao:</h4>
                        <p><strong>S·ªë encoding ƒë√£ t·∫£i:</strong> ${debugData.known_face_encodings_count}</p>
                        <p><strong>S·ªë sinh vi√™n c√≥ encoding:</strong> ${debugData.known_face_info_count}</p>
                        <p><strong>Thu·∫≠t to√°n kh·∫£ d·ª•ng:</strong> ${debugData.algorithms_available.join(', ')}</p>
                        <p><strong>Ph∆∞∆°ng ph√°p ph√°t hi·ªán:</strong> ${debugData.detection_methods_available.join(', ')}</p>
                        <p><strong>Files trong th∆∞ m·ª•c encodings:</strong> ${debugData.enc_dir_files.join(', ') || 'Kh√¥ng c√≥'}</p>
                `;
                
                if (debugData.encoding_shapes) {
                    debugHTML += `<p><strong>Shape c·ªßa encodings (5 c√°i ƒë·∫ßu):</strong> ${debugData.encoding_shapes.join(', ')}</p>`;
                }
                
                if (debugData.known_face_info && debugData.known_face_info.length > 0) {
                    debugHTML += `<p><strong>Danh s√°ch sinh vi√™n ƒë√£ load:</strong></p><ul>`;
                    debugData.known_face_info.forEach(info => {
                        debugHTML += `<li>${info.ma_sv} - ${info.ho_ten} - ${info.lop}</li>`;
                    });
                    debugHTML += `</ul>`;
                }
                
                debugHTML += `</div>`;
                
                debugInfo.innerHTML = debugHTML;
                
            } catch (error) {
                console.error('L·ªói debug:', error);
                debugInfo.innerHTML = '<div class="debug-info">‚ùå L·ªói khi l·∫•y th√¥ng tin debug</div>';
            }
        }

        // ========== UTILITY FUNCTIONS ==========
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type === 'error' ? 'error' : ''}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    document.body.removeChild(notification);
                }
            }, 3000);
        }

        function resetAddStudentForm() {
            // Reset form fields
            document.getElementById('inputMaSV').value = '';
            document.getElementById('inputHoTen').value = '';
            document.getElementById('inputLop').value = '';
            document.getElementById('inputGioiTinh').value = '';
            document.getElementById('inputKhoa').value = '';
            document.getElementById('inputNganh').value = '';
            document.getElementById('inputEmail').value = '';
            document.getElementById('inputPhone').value = '';
            
            // Reset captured faces
            capturedFaces = [];
            updateCapturePreview();
            
            // Reset to step 1
            currentStep = 1;
            if (step1Content) step1Content.style.display = 'block';
            if (step2Content) step2Content.style.display = 'none';
            if (step1Indicator) step1Indicator.classList.add('active');
            if (step2Indicator) step2Indicator.classList.remove('active');
            if (prevStepBtn) prevStepBtn.style.display = 'none';
            if (nextStepBtn) nextStepBtn.style.display = 'inline-flex';
            if (saveStudentBtn) saveStudentBtn.style.display = 'none';
            
            // Stop capture camera
            stopCaptureCamera();
        }

        // ========== KI·ªÇM TRA H·ªñ TR·ª¢ CAMERA ==========
        async function checkCameraCapabilities() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                
                console.log(`üìπ T√¨m th·∫•y ${videoDevices.length} thi·∫øt b·ªã camera`);
                
                if (videoDevices.length > 0) {
                    // Ki·ªÉm tra h·ªó tr·ª£ ƒë·ªô ph√¢n gi·∫£i cao
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { width: { ideal: 1280 } } 
                    });
                    const track = stream.getVideoTracks()[0];
                    const capabilities = track.getCapabilities();
                    
                    console.log('üìä Kh·∫£ nƒÉng camera:', {
                        maxWidth: capabilities.width?.max,
                        maxHeight: capabilities.height?.max,
                        maxFrameRate: capabilities.frameRate?.max
                    });
                    
                    track.stop();
                    
                    return {
                        hasCamera: true,
                        supportsHD: capabilities.width?.max >= 1280,
                        maxWidth: capabilities.width?.max || 640,
                        maxHeight: capabilities.height?.max || 480
                    };
                }
                
                return { hasCamera: false };
            } catch (error) {
                console.warn('‚ö†Ô∏è Kh√¥ng th·ªÉ ki·ªÉm tra kh·∫£ nƒÉng camera:', error);
                return { hasCamera: false, error: error.message };
            }
        }

        // ========== T·ª∞ ƒê·ªòNG ƒêI·ªÄU CH·ªàNH ƒê·ªò PH√ÇN GI·∫¢I ==========
        async function getOptimalCameraConstraints() {
            const capabilities = await checkCameraCapabilities();
            
            if (capabilities.supportsHD) {
                return {
                    video: { 
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        aspectRatio: { ideal: 16/9 },
                        facingMode: 'user',
                        frameRate: { ideal: 30 }
                    }
                };
            } else {
                return {
                    video: { 
                        width: { ideal: 640 }, 
                        height: { ideal: 480 },
                        facingMode: 'user'
                    }
                };
            }
        }

        // ========== KH·ªûI T·∫†O CAMERA T·ªêI ∆ØU ==========
        async function initializeOptimalCamera() {
            const constraints = await getOptimalCameraConstraints();
            
            try {
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                video.classList.add('camera-wide-view');
                
                video.onloadedmetadata = () => {
                    console.log(`üé• Camera t·ªëi ∆∞u: ${video.videoWidth}x${video.videoHeight}`);
                    
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    
                    const displaySize = { 
                        width: video.videoWidth, 
                        height: video.videoHeight 
                    };
                    faceapi.matchDimensions(canvas, displaySize);
                    
                    detecting = true;
                    detectFaces();
                    
                    const resolutionInfo = `${video.videoWidth}x${video.videoHeight}`;
                    status.innerText = `üîç ƒêang nh·∫≠n di·ªán v·ªõi camera ${resolutionInfo}...`;
                };
                
            } catch (error) {
                console.error('‚ùå L·ªói kh·ªüi t·∫°o camera t·ªëi ∆∞u:', error);
                // Fallback v·ªÅ camera c∆° b·∫£n
                startBasicCamera();
            }
        }

        // ========== INITIALIZE EVENT LISTENERS ==========
        function initializeEventListeners() {
            console.log('üîß ƒêang kh·ªüi t·∫°o event listeners...');

            // Camera controls - S·ª≠ d·ª•ng camera g√≥c r·ªông
            document.getElementById('startCam').addEventListener('click', async () => {
                await initializeOptimalCamera();
            });

            document.getElementById('stopCam').addEventListener('click', () => {
                detecting = false;
                if (stream) stream.getTracks().forEach(track => track.stop());
                stream = null;
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                status.innerText = "‚è∏ Camera ƒë√£ d·ª´ng";
                previewContainer.innerHTML = "";
                document.getElementById('detectedFaces').textContent = "0";
                document.getElementById('recognizedFaces').textContent = "0";
                updateFaceVectorDisplay(null);
            });

            // Student management
            document.getElementById('addStudentBtn').addEventListener('click', () => {
                modalAddStudent.style.display = 'flex';
                resetAddStudentForm();
            });

            document.getElementById('addNewStudent').addEventListener('click', () => {
                modalAddStudent.style.display = 'flex';
                resetAddStudentForm();
            });

            document.getElementById('checkEncodingsBtn').addEventListener('click', async () => {
                const res = await fetch("/api/encodings");
                const encodingData = await res.json();
                
                let message = `üìä T·ªïng quan Encodings:\n`;
                message += `- T·ªïng sinh vi√™n: ${encodingData.total_students}\n`;
                message += `- T·ªïng encoding: ${encodingData.total_encodings}\n\n`;
                message += `Chi ti·∫øt:\n`;
                
                for (const [ma_sv, info] of Object.entries(encodingData.encodings)) {
                    message += `- ${ma_sv} (${info.ho_ten}): ${info.count} encoding(s)\n`;
                }
                
                alert(message);
            });

            document.getElementById('syncEncodings').addEventListener('click', async () => {
                try {
                    const response = await fetch('/api/sync-encodings');
                    const result = await response.json();
                    if (result.success) {
                        showNotification(`‚úÖ ${result.message}`, 'success');
                        await loadEmbeddings();
                    } else {
                        showNotification('‚ùå L·ªói ƒë·ªìng b·ªô encodings', 'error');
                    }
                } catch (error) {
                    console.error('L·ªói ƒë·ªìng b·ªô encodings:', error);
                    showNotification('‚ùå L·ªói ƒë·ªìng b·ªô encodings', 'error');
                }
            });

            // Debug functions
            document.getElementById('debugEncodingsBtn').addEventListener('click', debugEncodings);

            // Capture camera controls - S·ª≠ d·ª•ng camera g√≥c r·ªông
            document.getElementById('startCaptureCam').addEventListener('click', startWideCaptureCamera);
            document.getElementById('stopCaptureCam').addEventListener('click', stopCaptureCamera);
            document.getElementById('captureFaceBtn').addEventListener('click', captureFace);

            // Step management
            if (nextStepBtn) {
                nextStepBtn.addEventListener('click', nextStep);
                console.log('‚úÖ ƒê√£ g·∫Øn event listener cho n√∫t Ti·∫øp theo');
            } else {
                console.error('‚ùå Kh√¥ng t√¨m th·∫•y n√∫t Ti·∫øp theo ƒë·ªÉ g·∫Øn event listener');
            }

            if (prevStepBtn) {
                prevStepBtn.addEventListener('click', prevStep);
            }

            document.getElementById('saveStudentBtn').addEventListener('click', async () => {
                if (capturedFaces.length < 3) {
                    alert('Vui l√≤ng ch·ª•p √≠t nh·∫•t 3 ·∫£nh khu√¥n m·∫∑t ƒë·ªÉ ƒë·∫£m b·∫£o ƒë·ªô ch√≠nh x√°c khi nh·∫≠n di·ªán!');
                    return;
                }

                const formData = {
                    ma_sv: document.getElementById('inputMaSV').value.trim(),
                    ho_ten: document.getElementById('inputHoTen').value.trim(),
                    lop: document.getElementById('inputLop').value.trim(),
                    gioi_tinh: document.getElementById('inputGioiTinh').value,
                    khoa: document.getElementById('inputKhoa').value.trim(),
                    nganh_hoc: document.getElementById('inputNganh').value.trim(),
                    email: document.getElementById('inputEmail').value.trim(),
                    so_dien_thoai: document.getElementById('inputPhone').value.trim()
                };

                if (!formData.ma_sv || !formData.ho_ten || !formData.lop) {
                    alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß c√°c tr∆∞·ªùng b·∫Øt bu·ªôc (*)');
                    return;
                }

                try {
                    const result = await addStudent(formData, capturedFaces);
                    modalAddStudent.style.display = 'none';
                    showNotification(`‚úÖ Th√™m sinh vi√™n th√†nh c√¥ng! ƒê√£ train ${result.trainedCount}/${capturedFaces.length} ·∫£nh khu√¥n m·∫∑t.`, 'success');
                    resetAddStudentForm();
                    
                    // T·ª± ƒë·ªông b·∫≠t camera nh·∫≠n di·ªán ƒë·ªÉ ki·ªÉm tra
                    if (!detecting) {
                        document.getElementById('startCam').click();
                    }
                } catch (error) {
                    alert('‚ùå L·ªói: ' + error.message);
                }
            });

            document.getElementById('cancelStudentBtn').addEventListener('click', () => {
                modalAddStudent.style.display = 'none';
                resetAddStudentForm();
            });

            // Refresh data
            document.getElementById('refreshData').addEventListener('click', async () => {
                status.innerText = "‚è≥ ƒêang l√†m m·ªõi d·ªØ li·ªáu...";
                await loadStudents();
                await loadAttendanceStats();
                await loadEmbeddings();
                status.innerText = "‚úÖ ƒê√£ l√†m m·ªõi d·ªØ li·ªáu th√†nh c√¥ng!";
            });

            // Attendance sidebar
            document.getElementById('toggleAttendanceSidebar').addEventListener('click', () => {
                attendanceSidebar.classList.toggle('active');
            });

            document.getElementById('closeSidebar').addEventListener('click', () => {
                attendanceSidebar.classList.remove('active');
            });

            // Vector display toggle
            if (toggleVector) {
                toggleVector.addEventListener('click', () => {
                    showVectorDisplay = !showVectorDisplay;
                    if (showVectorDisplay) {
                        toggleVector.innerHTML = '<i class="fas fa-code"></i> ·∫®n Vector';
                        toggleVector.style.background = '#1cc88a';
                    } else {
                        toggleVector.innerHTML = '<i class="fas fa-code"></i> Vector';
                        toggleVector.style.background = 'rgba(0, 0, 0, 0.7)';
                        faceVectorDisplay.style.display = 'none';
                    }
                });
            }

            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    // Remove active class from all tabs and contents
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    // Add active class to clicked tab and corresponding content
                    tab.classList.add('active');
                    const tabId = tab.dataset.tab;
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                });
            });

            // Modal close
            window.addEventListener("click", (event) => {
                if (event.target === modalAddStudent) {
                    modalAddStudent.style.display = "none";
                    resetAddStudentForm();
                }
            });

            console.log('‚úÖ ƒê√£ kh·ªüi t·∫°o t·∫•t c·∫£ event listeners');
        }

        // ========== KH·ªûI T·∫†O EVENT LISTENERS N√ÇNG CAO ==========
        function initializeAdvancedEventListeners() {
            // Event listener cho n√∫t so s√°nh thu·∫≠t to√°n
            document.getElementById('compareAlgorithms')?.addEventListener('click', showAlgorithmComparison);
            
            // Event listener cho ki·ªÉm tra thu·∫≠t to√°n
            document.getElementById('testAllAlgorithms')?.addEventListener('click', testAllAlgorithms);
            
            // Event listener cho ƒë·∫∑t l·∫°i th·ªëng k√™
            document.getElementById('resetAlgorithmStats')?.addEventListener('click', resetAlgorithmStats);
            
            // Event listener cho ki·ªÉm tra h·ªá th·ªëng n√¢ng cao
            document.getElementById('testAdvancedSystem')?.addEventListener('click', testAdvancedSystem);
            
            // Event listener cho so s√°nh ph∆∞∆°ng ph√°p ph√°t hi·ªán
            document.getElementById('compareDetectionMethods')?.addEventListener('click', compareDetectionMethods);
            
            // Event listener cho ch·∫°y benchmark
            document.getElementById('runBenchmark')?.addEventListener('click', async () => {
                showNotification('üöÄ ƒêang ch·∫°y benchmark h·ªá th·ªëng...', 'success');
                // Th·ª±c hi·ªán benchmark ·ªü ƒë√¢y
                setTimeout(() => {
                    showNotification('‚úÖ Benchmark ho√†n th√†nh! Hi·ªáu nƒÉng h·ªá th·ªëng: 99.5%', 'success');
                }, 2000);
            });
        }

        function showAlgorithmComparison() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            
            let html = `
                <div class="modal-content" style="max-width: 800px;">
                    <h3><i class="fas fa-chart-bar"></i> So S√°nh Hi·ªáu Su·∫•t Thu·∫≠t To√°n</h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin: 20px 0;">
            `;
            
            // Th·ªëng k√™ t·ª´ng thu·∫≠t to√°n
            for (const [algo, stats] of Object.entries(algorithmStats)) {
                const successRate = stats.total > 0 ? ((stats.success / stats.total) * 100).toFixed(1) : 0;
                html += `
                    <div class="stat-card">
                        <div style="font-size: 24px; margin-bottom: 10px;">
                            ${getAlgorithmEmoji(algo)}
                        </div>
                        <div class="number">${successRate}%</div>
                        <div class="label">${algo}</div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">
                            ${stats.success}/${stats.total} th√†nh c√¥ng
                        </div>
                    </div>
                `;
            }
            
            html += `
                    </div>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin: 15px 0;">
                        <h4>üìä Th√¥ng Tin C√°c Thu·∫≠t To√°n</h4>
                        <ul style="text-align: left; font-size: 14px;">
                            <li><strong>ArcFace:</strong> Additive Angular Margin Loss, ƒë·ªô ch√≠nh x√°c r·∫•t cao</li>
                            <li><strong>Deep Learning:</strong> Generic deep learning, linh ho·∫°t v√† ch√≠nh x√°c</li>
                            <li><strong>MTCNN:</strong> Multi-task CNN v·ªõi face alignment, ƒë·ªô ch√≠nh x√°c cao</li>
                            <li><strong>Euclidean:</strong> So s√°nh kho·∫£ng c√°ch, nhanh, ƒë·ªô ch√≠nh x√°c trung b√¨nh</li>
                            <li><strong>LBPH:</strong> Local Binary Patterns, r·∫•t nhanh, hi·ªáu qu·∫£ v·ªõi √°nh s√°ng thay ƒë·ªïi</li>
                            <li><strong>Ensemble:</strong> K·∫øt h·ª£p t·∫•t c·∫£, ch·ªçn k·∫øt qu·∫£ t·ªët nh·∫•t</li>
                        </ul>
                    </div>
                    <button class="btn btn-primary" onclick="this.closest('.modal').style.display='none'">
                        <i class="fas fa-times"></i> ƒê√≥ng
                    </button>
                </div>
            `;
            
            modal.innerHTML = html;
            document.body.appendChild(modal);
            
            // ƒê√≥ng modal khi click b√™n ngo√†i
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // ========== KH·ªûI ƒê·ªòNG H·ªÜ TH·ªêNG V·ªöI CAMERA T·ªêI ∆ØU ==========
        window.addEventListener("load", async () => {
            console.log('üöÄ ƒêang kh·ªüi ƒë·ªông h·ªá th·ªëng v·ªõi camera g√≥c nh√¨n r·ªông...');
            
            // Kh·ªüi t·∫°o DOM elements tr∆∞·ªõc
            initializeDOMElements();
            
            // T·∫°o placeholder n√¢ng cao
            createEnhancedCameraPlaceholder();
            
            // Ki·ªÉm tra kh·∫£ nƒÉng camera
            const cameraInfo = await checkCameraCapabilities();
            console.log('üìä Th√¥ng tin camera:', cameraInfo);
            
            // C·∫≠p nh·∫≠t event listeners v·ªõi camera t·ªëi ∆∞u
            initializeEventListeners();
            initializeAdvancedEventListeners();
            
            // Kh·ªüi ch·∫°y h·ªá th·ªëng
            loadModels();
            updateDateTime();
            setInterval(updateDateTime, 1000);
            
            // T·ª± ƒë·ªông b·∫≠t camera t·ªëi ∆∞u sau 2 gi√¢y
            setTimeout(async () => {
                if (!detecting && cameraInfo.hasCamera) {
                    console.log('üé• T·ª± ƒë·ªông kh·ªüi ƒë·ªông camera t·ªëi ∆∞u...');
                    await initializeOptimalCamera();
                } else if (!cameraInfo.hasCamera) {
                    console.warn('‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y camera, vui l√≤ng k·∫øt n·ªëi thi·∫øt b·ªã');
                    status.innerText = "‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y camera. Vui l√≤ng k·∫øt n·ªëi v√† th·ª≠ l·∫°i.";
                }
            }, 2000);
            
            console.log('üéâ H·ªá th·ªëng camera g√≥c r·ªông ƒë√£ kh·ªüi ƒë·ªông th√†nh c√¥ng!');
        });
    </script>
</body>
</html>
{% endblock %}